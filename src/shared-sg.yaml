Resources:
  TaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
  
  ApiSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Fargate API tasks
      VpcId: !ImportValue leaguebuilder-dev-VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 6000
          ToPort: 6000
          SourceSecurityGroupId: !Ref ALBSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
  
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow inbound UI
      VpcId: !ImportValue leaguebuilder-dev-VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 15672
          ToPort: 15672
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0


Outputs:
  ApiSecurityGroupId:
    Description: Security group for API tasks
    Value: !Ref ApiSecurityGroup
    Export:
      Name: leaguebuilder-dev-ApiSecurityGroupId

  ALBSecurityGroupId:
    Description: Security group for ALB
    Value: !Ref ALBSecurityGroup
    Export:
      Name: leaguebuilder-dev-ALBSecurityGroupId