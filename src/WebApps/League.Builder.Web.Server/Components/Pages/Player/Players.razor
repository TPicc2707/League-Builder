@page "/players"
@using League.Builder.Web.Server.Services.Cache
@inject NavigationManager NavManager
@inject ErrorState ErrorState
@inject ILeagueService LeagueService
@inject ITeamService TeamService
@inject IPlayerService PlayerService
@inject IAWSService AWSService
@inject IHttpContextAccessor HttpContextAccessor
@inject ILeagueLocalCacheService LeagueLocalCache
@inject ITeamLocalCacheService TeamLocalCache
@inject IPlayerLocalCacheService PlayerLocalCache
@inject IJSRuntime JsRuntime
@inject KeycloakTokenService KeycloakTokenService

<AuthorizeView Roles="@Roles.ReadPlayers" Context="auth">
    <Authorized>
        @if (PageLoad)
        {
            <MudItem Style="padding-top: 50px;">
                <MudExpansionPanels>
                    <MudExpansionPanel Class="border border-solid" Style="border-color: #000000" Expanded="expandSearchPanel">
                        <TitleContent>
                            <MudText Typo="Typo.h5" Align="Align.Center" Style="font-weight:bold">Search Players</MudText>
                        </TitleContent>
                        <ChildContent>
                            <MudItem>
                                <MudTabs Elevation="2" Centered="true" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6" Color="Color.Primary" Class="border border-solid" Style="border-color: #000000">
                                    <MudTabPanel Text="Search All">
                                        <MudButton OnClick="SearchAll" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" FullWidth="true">Search All</MudButton>
                                    </MudTabPanel>
                                    <MudTabPanel Text="First Name">
                                        <MudStack Row="true">
                                            <MudItem xs="9" md="9" lg="9">
                                                <MudTextField @bind-Value="firstName" Placeholder="First Name" />
                                            </MudItem>
                                            <MudItem xs="3" md="3" lg="3">
                                                <MudButton Disabled="@(firstName == string.Empty ? true : false)" OnClick="SearchByFirstName" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" Style="width: 200px;">Search</MudButton>
                                            </MudItem>
                                        </MudStack>
                                    </MudTabPanel>
                                    <MudTabPanel Text="Last Name">
                                        <MudStack Row="true">
                                            <MudItem xs="9" md="9" lg="9">
                                                <MudTextField @bind-Value="lastName" Placeholder="Last Name" />
                                            </MudItem>
                                            <MudItem xs="3" md="3" lg="3">
                                                <MudButton Disabled="@(lastName == string.Empty ? true : false)" OnClick="SearchByLastName" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" Style="width: 200px;">Search</MudButton>
                                            </MudItem>
                                        </MudStack>
                                    </MudTabPanel>
                                    <MudTabPanel Text="Position">
                                        <MudStack Row="true">
                                            <MudItem xs="4" md="4" lg="4">
                                                <MudSelect @bind-Value="sport" Label="Sport">
                                                    @foreach (var sport in Constants.Sports())
                                                    {
                                                        <MudSelectItem Value="sport">@sport</MudSelectItem>
                                                    }
                                                </MudSelect>
                                            </MudItem>
                                            <MudItem xs="4" md="4" lg="4">
                                                <MudSelect @bind-Value="position" Label="Position" Disabled="@(sport == string.Empty ? true : false)">
                                                    @foreach (var position in Constants.PositionsBySport(sport))
                                                    {
                                                        <MudSelectItem Value="position">@position</MudSelectItem>
                                                    }
                                                </MudSelect>
                                            </MudItem>
                                            <MudItem xs="4" md="4" lg="4" Style="align-content: center">
                                                <MudButton Disabled="@(position == string.Empty ? true : false)" OnClick="SearchByPosition" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" Style="width: 200px;">Search</MudButton>
                                            </MudItem>
                                        </MudStack>
                                    </MudTabPanel>
                                    <MudTabPanel Text="Birth Date">
                                        <MudStack Row="true">
                                            <MudItem xs="4" md="4" lg="4">
                                                <MudSelect @bind-Value="_when" Label="When">
                                                    @foreach (var when in Constants.When())
                                                    {
                                                        <MudSelectItem Value="when">@when</MudSelectItem>
                                                    }
                                                </MudSelect>
                                            </MudItem>
                                            <MudItem xs="4" md="4" lg="4">
                                                <MudDatePicker Label="Birth Date" Disabled="@(_when == string.Empty ? true : false)" Editable="true" @bind-Date="birthdate" />
                                            </MudItem>
                                            <MudItem xs="4" md="4" lg="4" Style="align-content: center">
                                                <MudButton Disabled="@(birthdate is null ? true : false)" OnClick="SearchBirthdate" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" Style="width: 200px;">Search</MudButton>
                                            </MudItem>
                                        </MudStack>
                                    </MudTabPanel>
                                </MudTabs>
                            </MudItem>
                        </ChildContent>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            </MudItem>
            @if (Model != null)
            {
                <MudItem Style="padding-top: 25px;">
                    <MudExpansionPanels>
                        <MudExpansionPanel Class="border border-solid" Style="border-color: #000000" Expanded="true">
                            <TitleContent>
                                <MudText Typo="Typo.h5" Align="Align.Center" Style="font-weight:bold">Results</MudText>
                            </TitleContent>
                            <ChildContent>
                                <MudItem>
                                    <MudTable Items="@Model" Hover="true" SortLabel="Sort By" Class="border border-solid" Style="border-color: #000000" RowsPerPage="25">
                                        <HeaderContent>
                                            <MudTh Style="font-weight:bold" Class="mud-theme-primary"></MudTh>
                                            <MudTh Style="font-weight:bold" Class="mud-theme-primary"><MudTableSortLabel SortBy="new Func<PlayerModel, object>(x => x.FirstName)">First Name</MudTableSortLabel></MudTh>
                                            <MudTh Style="font-weight:bold" Class="mud-theme-primary"><MudTableSortLabel SortBy="new Func<PlayerModel, object>(x => x.LastName)">Last Name</MudTableSortLabel></MudTh>
                                            <MudTh Style="font-weight:bold" Class="mud-theme-primary"><MudTableSortLabel SortBy="new Func<PlayerModel, object>(x => x.TeamName)">Team</MudTableSortLabel></MudTh>
                                            <MudTh Style="font-weight:bold" Class="mud-theme-primary">Position</MudTh>
                                            <MudTh Style="font-weight:bold" Class="mud-theme-primary">Location</MudTh>
                                            <MudTh Style="font-weight:bold" Class="mud-theme-primary"></MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd DataLabel="">
                                                <MudAvatar Size="Size.Small">
                                                    <MudImage Src="@context.Image" Alt="Player Image"></MudImage>
                                                </MudAvatar>
                                            </MudTd>
                                            <MudTd DataLabel="First Name">
                                                <AuthorizeView Roles="@Roles.ReadStats" Context="readStatsAuth">
                                                    <Authorized>
                                                        <MudTooltip Text="Player Details" Color="Color.Secondary">
                                                            @if (context.Sport == SportName.BASEBALL)
                                                            {
                                                                <MudLink Color="Color.Tertiary" Href="@($"/baseballplayerstats/{context.Id}")">@context.FirstName</MudLink>
                                                            }
                                                            @if (context.Sport == SportName.BASKETBALL)
                                                            {
                                                                <MudLink Color="Color.Tertiary" Href="@($"/basketballplayerstats/{context.Id}")">@context.FirstName</MudLink>
                                                            }
                                                            @if (context.Sport == SportName.FOOTBALL)
                                                            {
                                                                <MudLink Color="Color.Tertiary" Href="@($"/footballplayerstats/{context.Id}")">@context.FirstName</MudLink>
                                                            }
                                                        </MudTooltip>
                                                    </Authorized>
                                                    <NotAuthorized>
                                                        @context.FirstName
                                                    </NotAuthorized>
                                                </AuthorizeView>
                                            </MudTd>
                                            <MudTd DataLabel="Last Name">
                                                <AuthorizeView Roles="@Roles.ReadStats" Context="readStatsAuth">
                                                    <Authorized>
                                                        <MudTooltip Text="Player Details" Color="Color.Secondary">
                                                            @if (context.Sport == SportName.BASEBALL)
                                                            {
                                                                <MudLink Color="Color.Tertiary" Href="@($"/baseballplayerstats/{context.Id}")">@context.LastName</MudLink>
                                                            }
                                                            @if (context.Sport == SportName.BASKETBALL)
                                                            {
                                                                <MudLink Color="Color.Tertiary" Href="@($"/baseballplayerstats/{context.Id}")">@context.LastName</MudLink>
                                                            }
                                                            @if (context.Sport == SportName.FOOTBALL)
                                                            {
                                                                <MudLink Color="Color.Tertiary" Href="@($"/baseballplayerstats/{context.Id}")">@context.LastName</MudLink>
                                                            }
                                                        </MudTooltip>
                                                    </Authorized>
                                                    <NotAuthorized>
                                                        @context.LastName
                                                    </NotAuthorized>
                                                </AuthorizeView>
                                            </MudTd>
                                            <MudTd DataLabel="Team">@context.TeamName</MudTd>
                                            <MudTd DataLabel="Position">@context.PlayerDetail.Position</MudTd>
                                            <MudTd DataLabel="Location">@context.PlayerAddress.City, @context.PlayerAddress.State</MudTd>
                                            <MudTd DataLabel="Links">
                                                <AuthorizeView Roles="@Roles.UpdatePlayers" Context="updateAuth">
                                                    <MudTooltip Text="Update" Color="Color.Secondary">
                                                        <MudIconButton Icon="@Icons.Material.Filled.Update" Color="Color.Tertiary" Edge="Edge.Start" Href="@String.Concat("/updateplayer/", context.Id)" />
                                                    </MudTooltip>
                                                </AuthorizeView>
                                            </MudTd>
                                        </RowTemplate>
                                        <PagerContent>
                                            <MudTablePager />
                                        </PagerContent>
                                    </MudTable>
                                </MudItem>
                            </ChildContent>
                        </MudExpansionPanel>
                    </MudExpansionPanels>
                </MudItem>
            }
            @if (isSearchLoading)
            {
                <Loading />
            }

        }
        else
        {
            <Loading />
        }
    </Authorized>
    <NotAuthorized>
        <NoAccess />
    </NotAuthorized>
</AuthorizeView>

@code {
    private string firstName = string.Empty;
    private string prevFirstName = string.Empty;
    private string lastName  = string.Empty;
    private string prevLastName = string.Empty;
    private string sport = string.Empty;
    private string position = string.Empty;
    private string prevPosition = string.Empty;
    private string _when = string.Empty;
    private DateTime? birthdate;
    private DateTime? prevBirthdate;
    private bool expandSearchPanel = true;
    private bool isSearchLoading = false;
    private bool PageLoad = false;
    private IJSObjectReference? _module;
    private List<PlayerModel> Model { get; set; }
    private GetLeaguesResponse LeaguesResponse { get; set; }
    private GetPlayersResponse PlayersResponse { get; set; }
    private GetPlayersByFirstNameResponse PlayersByFirstNameResponse { get; set; }
    private GetPlayersByLastNameResponse PlayersbyLastNameResponse { get; set; }
    private GetPlayersByPositionResponse PlayersByPositionResponse { get; set; }
    private GetPlayersByBirthDateResponse PlayersByBirthdateResponse { get; set; }
    private GetPlayersBeforeBirthDateResponse PlayersBeforeBirthDateResponse { get; set; }
    private GetPlayersAfterBirthDateResponse PlayersAfterBirthDateResponse { get; set; }
    private GetTeamsResponse TeamsResponse { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            TeamsResponse = await TeamLocalCache.GetTeamsCache();  //If a team is added need to delete local storage
            if (TeamsResponse == null)
            {
                TeamsResponse = await TeamService.GetTeams(0, 1000);
                await TeamLocalCache.SetTeamsCache(TeamsResponse);
            }

            LeaguesResponse = await LeagueLocalCache.GetLeaguesCache();  //If a league is added need to delete local storage
            if (LeaguesResponse == null)
            {
                LeaguesResponse = await LeagueService.GetLeagues();
                await LeagueLocalCache.SetLeaguesCache(LeaguesResponse);
            }

            PageLoad = true;

        }
        catch (Exception ex)
        {
            if (KeycloakTokenService.ShouldForceLogout())
            {
                _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/authRefresh.js");
                await _module.InvokeVoidAsync("logout");
            }
            ErrorState.Message = ex.Message;
            NavManager.NavigateTo("/error");
        }
    }

    private async Task SearchAll()
    {
        isSearchLoading = true; //If a player is added need to delete local storage
        PlayersResponse = await PlayerLocalCache.GetPlayersCache();
        if(PlayersResponse is null)
        {
            PlayersResponse = await PlayerService.GetPlayers(0, 1000);
            await PlayerLocalCache.SetPlayersCache(PlayersResponse);
        }
        Model = PlayersResponse.Players.Data.ToList();
        await GetImageAsync();
        expandSearchPanel = false;
        isSearchLoading = false;
    }

    private async Task SearchByFirstName()
    {
        isSearchLoading = true;
        PlayersByFirstNameResponse = await PlayerLocalCache.GetPlayersByFirstNameCache();
        if(PlayersByFirstNameResponse == null || prevFirstName != firstName)
        {
            PlayersByFirstNameResponse = await PlayerService.GetPlayersByFirstName(firstName);
            await PlayerLocalCache.SetPlayersByFirstNameCache(PlayersByFirstNameResponse);
        }
        Model = PlayersByFirstNameResponse.Players.ToList();
        await GetImageAsync();
        prevFirstName = firstName;
        expandSearchPanel = false;
        isSearchLoading = false;
    }

    private async Task SearchByLastName()
    {
        isSearchLoading = true;
        PlayersbyLastNameResponse = await PlayerLocalCache.GetPlayersByLastNameCache();
        if (PlayersbyLastNameResponse == null || prevLastName != lastName)
        {
            PlayersbyLastNameResponse = await PlayerService.GetPlayersByLastName(lastName);
            await PlayerLocalCache.SetPlayersByLastNameCache(PlayersbyLastNameResponse);
        }
        Model = PlayersbyLastNameResponse.Players.ToList();
        await GetImageAsync();
        prevLastName = lastName;
        expandSearchPanel = false;
        isSearchLoading = false;
    }

    private async Task SearchByPosition()
    {
        isSearchLoading = true;
        PlayersByPositionResponse = await PlayerLocalCache.GetPlayersByPositionCache();
        if(PlayersByPositionResponse == null || prevPosition == position)
        {
            PlayersByPositionResponse = await PlayerService.GetPlayersByPosition(position);
            await PlayerLocalCache.SetPlayersByPositionCache(PlayersByPositionResponse);
        }
        Model = PlayersByPositionResponse.Players.ToList();
        await GetImageAsync();
        prevPosition = position;
        expandSearchPanel = false;
        isSearchLoading = false;
    }

    private async Task SearchBirthdate()
    {
        isSearchLoading = true;
        DateTime date = (DateTime)birthdate;
        DateTime prevDate = prevBirthdate is null ? DateTime.Now : (DateTime)prevBirthdate;
        string prevBirthDate = prevDate.ToString("yyyy-MM-dd");
        string birthDate = date.ToString("yyyy-MM-dd");
        if (_when == "By")
        {
            PlayersByBirthdateResponse = await PlayerLocalCache.GetPlayersByBirthDateCache();
            if (PlayersByBirthdateResponse == null || prevBirthDate == birthDate)
            {
                PlayersByBirthdateResponse = await PlayerService.GetPlayersByBirthDate(birthDate);
                await PlayerLocalCache.SetPlayersByBirthDateCache(PlayersByBirthdateResponse);
            }
            Model = PlayersByBirthdateResponse.Players.ToList();

        }
        if (_when == "Before")
        {
            PlayersBeforeBirthDateResponse = await PlayerLocalCache.GetPlayersBeforeBirthDateCache();
            if (PlayersBeforeBirthDateResponse == null || prevBirthDate == birthDate)
            {
                PlayersBeforeBirthDateResponse = await PlayerService.GetPlayersBeforeBirthDate(birthDate);
                await PlayerLocalCache.SetPlayersBeforeBirthDateCache(PlayersBeforeBirthDateResponse);
            }
            Model = PlayersBeforeBirthDateResponse.Players.ToList();

        }
        if (_when == "After")
        {
            PlayersAfterBirthDateResponse = await PlayerLocalCache.GetPlayersAfterBirthDateCache();
            if (PlayersAfterBirthDateResponse == null || prevBirthDate == birthDate)
            {
                PlayersAfterBirthDateResponse = await PlayerService.GetPlayersAfterBirthDate(birthDate);
                await PlayerLocalCache.SetPlayersAfterBirthDateCache(PlayersAfterBirthDateResponse);
            }
            Model = PlayersAfterBirthDateResponse.Players.ToList();

        }
        await GetImageAsync();
        prevBirthdate = birthdate;
        expandSearchPanel = false;
        isSearchLoading = false;
    }

    private async Task GetImageAsync()
    {
        foreach (var player in Model)
        {
            var team = TeamsResponse.Teams.Data.FirstOrDefault(t => t.Id == player.TeamId);
            player.TeamName = team.TeamName;
            var league = LeaguesResponse.Leagues.FirstOrDefault(t => t.Id == team.LeagueId);
            player.Sport = league.Sport;
            var keyPath = $"/{league.Sport}/{league.Name}/teams/{team.TeamName}/players/{String.Concat(player.FirstName, " ", player.LastName)}/{player.ImageFile}";
            player.Image = await AWSService.GetImage(keyPath);
        }
    }
}
