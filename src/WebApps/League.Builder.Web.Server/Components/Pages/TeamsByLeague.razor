@page "/teamsbyleague/{id}"
@inject ILeagueService LeagueService
@inject ITeamService TeamService
@inject NavigationManager NavManager
@inject IHttpContextAccessor HttpContextAccessor
@inject IAWSService AWSService

<AuthorizeView Roles="@String.Concat(Roles.ReadTeams, ", ", Roles.ReadLeagues)" Context="auth">
    <Authorized>
        @if (PageLoad)
        {
            <MudItem Style="padding-top: 100px;">
                <MudItem xs="12" md="12" lg="12" Style="padding-bottom: 25px;">
                    <MudCard Class="border border-solid" Style="border-color: #000000">
                        <MudCardContent>
                            <MudStack Row="true">
                                <MudItem xs="4" md="4" lg="4">
                                    <MudImage Src="@League.League.Image" Width="225" Height="225" Alt="Swedish Farm House" Elevation="25" Class="rounded-lg ma-4" />
                                </MudItem>
                                <MudItem xs="6" md="6" lg="6" Class="ma-4">
                                    <MudText Typo="Typo.h4" Align="Align.Start" Style="font-weight:bold; ">@League.League.Name</MudText>
                                    <MudText Typo="Typo.body1" Align="Align.Start" Style="padding-top: 10px;">@String.Concat(League.League.OwnerFirstName, " ", League.League.OwnerLastName)</MudText>
                                    <MudText Typo="Typo.body1" Align="Align.Start" Style="padding-top: 10px;">@League.League.Sport</MudText>
                                    <MudText Typo="Typo.body1" Align="Align.Start" Style="padding-top: 10px;">@League.League.Description</MudText>
                                </MudItem>
                            </MudStack>
                        </MudCardContent>
                        <MudCardActions Class="ma-4">
                            <MudButton Variant="Variant.Text"  OnClick="OpenContactDialogAsync">Contact Info</MudButton>
                        </MudCardActions>
                    </MudCard>

                </MudItem>
            </MudItem>
            <MudItem Style="padding-top: 25px;">
                <MudExpansionPanels>
                    <MudExpansionPanel Expanded="true" Class="border border-solid" Style="border-color: #000000">
                        <TitleContent>
                            <MudText Typo="Typo.h5" Align="Align.Center" Style="font-weight:bold">Teams</MudText>
                        </TitleContent>
                        <ChildContent>
                            <AuthorizeView Roles="@Roles.CreateTeams" Context="createTeamsAuth">
                                <Authorized>
                                    <MudItem>
                                        <MudTable Items="@Teams.Teams" Hover="true" SortLabel="Sort By" Class="border border-solid" Style="border-color: #000000">
                                            <ToolBarContent>
                                                <MudStack Justify="Justify.FlexStart">
                                                    <MudButton OnClick="NavigateToCreateTeam" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" style="width: 200px;">Create</MudButton>
                                                </MudStack>
                                            </ToolBarContent>
                                            <HeaderContent>
                                                <MudTh Style="font-weight:bold" Class="mud-theme-primary"></MudTh>
                                                <MudTh Style="font-weight:bold" Class="mud-theme-primary"><MudTableSortLabel SortBy="new Func<TeamModel, object>(x => x.TeamName)">Name</MudTableSortLabel></MudTh>
                                                <MudTh Style="font-weight:bold" Class="mud-theme-primary">Description</MudTh>
                                                <MudTh Style="font-weight:bold" Class="mud-theme-primary"></MudTh>
                                            </HeaderContent>
                                            <RowTemplate>
                                                <MudTd DataLabel="">
                                                    <MudAvatar Size="Size.Small">
                                                        <MudImage Src="@context.Image" Alt="Team Image"></MudImage>
                                                    </MudAvatar>
                                                </MudTd>
                                                <MudTd DataLabel="Team Name"><MudLink Color="Color.Tertiary" Href="@($"/playersbyteam/{context.Id}")">@context.TeamName</MudLink></MudTd>
                                                <MudTd DataLabel="Description">@context.Description</MudTd>
                                                <MudTd DataLabel="Links">
                                                    <AuthorizeView Roles="@Roles.ReadGames" Context="teamGamesAuth">
                                                        <MudIconButton Icon="@Icons.Material.Filled.CalendarMonth" Color="Color.Tertiary" Edge="Edge.Start" Href="@String.Concat("/teamgames/", context.Id)" />
                                                    </AuthorizeView>
                                                    <AuthorizeView Roles="@Roles.UpdateTeams" Context="updateAuth">
                                                        <MudIconButton Icon="@Icons.Material.Filled.Update" Color="Color.Tertiary" Edge="Edge.Start" Href="@String.Concat("/updateteam/", context.Id)" />
                                                    </AuthorizeView>
                                                </MudTd>
                                            </RowTemplate>
                                            <PagerContent>
                                                <MudTablePager />
                                            </PagerContent>
                                        </MudTable>
                                    </MudItem>
                                </Authorized>
                                <NotAuthorized>
                                    <MudItem>
                                        <MudTable Items="@Teams.Teams" Hover="true" SortLabel="Sort By" Class="border border-solid" Style="border-color: #000000">
                                            <HeaderContent>
                                                <MudTh Style="font-weight:bold" Class="mud-theme-primary"></MudTh>
                                                <MudTh Style="font-weight:bold" Class="mud-theme-primary"><MudTableSortLabel SortBy="new Func<TeamModel, object>(x => x.TeamName)">Name</MudTableSortLabel></MudTh>
                                                <MudTh Style="font-weight:bold" Class="mud-theme-primary">Description</MudTh>
                                                <MudTh Style="font-weight:bold" Class="mud-theme-primary"></MudTh>
                                            </HeaderContent>
                                            <RowTemplate>
                                                <MudTd DataLabel="">
                                                    <MudAvatar Size="Size.Small">
                                                        <MudImage Src="@context.Image" Alt="Team Image"></MudImage>
                                                    </MudAvatar>
                                                </MudTd>
                                                <MudTd DataLabel="Team Name"><MudLink Color="Color.Tertiary" Href="@($"/playersbyteam/{context.Id}")">@context.TeamName</MudLink></MudTd>
                                                <MudTd DataLabel="Description">@context.Description</MudTd>
                                                <MudTd DataLabel="Links">
                                                    <AuthorizeView Roles="@Roles.ReadGames" Context="teamGamesAuth">
                                                        <MudIconButton Icon="@Icons.Material.Filled.CalendarMonth" Color="Color.Tertiary" Edge="Edge.Start" Href="@String.Concat("/teamgames/", context.Id)" />
                                                    </AuthorizeView>
                                                    <AuthorizeView Roles="@Roles.UpdateTeams" Context="updateAuth">
                                                        <MudIconButton Icon="@Icons.Material.Filled.Update" Color="Color.Tertiary" Edge="Edge.Start" Href="@String.Concat("/updateteam/", context.Id)" />
                                                    </AuthorizeView>
                                                </MudTd>
                                            </RowTemplate>
                                            <PagerContent>
                                                <MudTablePager />
                                            </PagerContent>
                                        </MudTable>
                                    </MudItem>
                                </NotAuthorized>
                            </AuthorizeView>
                        </ChildContent>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            </MudItem>
        }
        else
        {
            <Loading />
        }
    </Authorized>
    <NotAuthorized>
        <MudText>You are not authorized to view this page...</MudText>
    </NotAuthorized>
</AuthorizeView>


@code {
    [Parameter]
    public string Id { get; set; }
    [Inject] private IDialogService DialogService { get; set; }

    private bool PageLoad = false;
    private int TeamCount = 0;
    private int PageSize = 0;
    private int Counter = 0;
    private Justify _justify = Justify.SpaceEvenly;
    private int TeamCounter = 0;

    private GetLeagueByIdResponse League { get; set; }
    private GetTeamsByLeagueResponse Teams { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (await AuthorizationStatus.IsUserAccessTokenExpired(HttpContextAccessor))
        {
            NavManager.NavigateTo("authentication/logout");
        }

        var leagueId = Guid.Parse(Id);
        League = await LeagueService.GetLeague(leagueId);
        await GetLeagueImageAsync();
        Teams = await TeamService.GetTeamsByLeague(leagueId);
        await GetImageAsync();
        PageLoad = true;
    }

    private Task OpenDialogAsync(Guid id)
    {
        var parameters = new DialogParameters<DeleteTeamMessageBox> { { x => x.Id, id } };
        var options = new DialogOptions { CloseOnEscapeKey = true };

        return DialogService.ShowAsync<DeleteTeamMessageBox>("Delete Team", parameters, options);
    }

    private Task OpenContactDialogAsync()
    {
        var parameters = new DialogParameters<LeagueContactInfoMessageBox> { { x => x.Id, League.League.Id } };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraSmall, FullWidth = true };

        return DialogService.ShowAsync<LeagueContactInfoMessageBox>("Contact Info", parameters, options);
    }

    private IEnumerable<TeamModel> GetTeamsForRow(int count)
    {
        Console.WriteLine(count);
        var teams = Teams.Teams.OrderBy(p => p.TeamName).Skip(4 * count).Take(4);
        TeamCounter++;
        return teams;
    }

    private async Task GetImageAsync()
    {
        foreach (var team in Teams.Teams)
        {
            var keyPath = $"/{League.League.Sport}/{League.League.Name}/teams/{team.TeamName}/{team.ImageFile}";
            team.Image = await AWSService.GetImage(keyPath);
        }
    }

    private async Task GetLeagueImageAsync()
    {
        string keyPath = $"/{League.League.Sport}/{League.League.Name}/{League.League.ImageFile}";
        League.League.Image = await AWSService.GetImage(keyPath);
    }

    private async Task NavigateToCreateTeam()
    {
        NavManager.NavigateTo($"/createteam/{Id}");
    }


}
