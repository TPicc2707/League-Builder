@page "/editbaseballgamestats/{id}"
@using League.Builder.Web.Server.Services.Cache
@inject IStatsService StatsService
@inject IGameService GameService
@inject ILeagueService LeagueService
@inject ITeamService TeamService
@inject IPlayerService PlayerService
@inject IAWSService AWSService
@inject ISnackbar Snackbar
@inject NavigationManager NavManager
@inject ErrorState ErrorState
@inject IHttpContextAccessor HttpContextAccessor
@inject IGameLocalCacheService GameLocalCache
@inject IPlayerLocalCacheService PlayerLocalCache
@inject IStatsLocalCacheService StatsLocalCache
@inject ILeagueLocalCacheService LeagueLocalCache
@inject ITeamLocalCacheService TeamLocalCache
@inject IJSRuntime JsRuntime
@inject KeycloakTokenService KeycloakTokenService

<AuthorizeView Roles="@String.Concat(Roles.CreateStats, ", ", Roles.UpdateStats)" Context="auth">
    <Authorized>
        @if (PageLoad)
        {
            <TeamHeader Game="GameModel.Game" />
            <MudItem Style="padding-top: 25px;">
                <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Centered="true" Color="Color.Primary" Class="border border-solid" Style="border-color: #000000; padding: 25px;">
                    <MudTabPanel Text="@($"{GameModel.Game.AwayTeam.TeamName} Stats")">
                        <ModifyBaseballHittingTable Stats="@Model.Where(x => x.TeamId == GameModel.Game.AwayTeam.Id && x.Position != PositionFilter.BASEBALL)"
                                                    SelectedItem="@hittingStatSelectedItem"
                                                    SelectedItemChanged="@(v => hittingStatSelectedItem = v)"
                                                    OnCommit="SubmitHittingStats"
                                                    OnBackup="BackupHittingItem"
                                                    OnReset="ResetHittingItemToOriginalValues"
                                                    EditButtonPosition="@editButtonPosition"
                                                    EditTrigger="@editTrigger" />
                        <BaseballHittingTotals Totals="AwayHittingTotals" />
                        <ModifyBaseballPitchingTable Stats="@Model.Where(x => x.TeamId == GameModel.Game.AwayTeam.Id && x.Position == PositionFilter.BASEBALL)"
                                                     SelectedItem="@pitchingStatSelectedItem"
                                                     SelectedItemChanged="@(v => pitchingStatSelectedItem = v)"
                                                     OnCommit="SubmitPitchingStats"
                                                     OnBackup="BackupPitchingItem"
                                                     OnReset="ResetPitchingItemToOriginalValues"
                                                     EditButtonPosition="@editButtonPosition"
                                                     EditTrigger="@editTrigger" />
                        <BaseballPitchingTotals Totals="AwayPitchingTotals" />
                    </MudTabPanel>
                    <MudTabPanel Text="@($"{GameModel.Game.HomeTeam.TeamName} Stats")">
                        <ModifyBaseballHittingTable Stats="@Model.Where(x => x.TeamId == GameModel.Game.HomeTeam.Id && x.Position != PositionFilter.BASEBALL)"
                                                    SelectedItem="@hittingStatSelectedItem"
                                                    SelectedItemChanged="@(v => hittingStatSelectedItem = v)"
                                                    OnCommit="SubmitHittingStats"
                                                    OnBackup="BackupHittingItem"
                                                    OnReset="ResetHittingItemToOriginalValues"
                                                    EditButtonPosition="@editButtonPosition"
                                                    EditTrigger="@editTrigger" />     
                        <BaseballHittingTotals Totals="HomeHittingTotals" />
                        <ModifyBaseballPitchingTable Stats="@Model.Where(x => x.TeamId == GameModel.Game.HomeTeam.Id && x.Position == PositionFilter.BASEBALL)"
                                                     SelectedItem="@pitchingStatSelectedItem"
                                                     SelectedItemChanged="@(v => pitchingStatSelectedItem = v)"
                                                     OnCommit="SubmitPitchingStats"
                                                     OnBackup="BackupPitchingItem"
                                                     OnReset="ResetPitchingItemToOriginalValues"
                                                     EditButtonPosition="@editButtonPosition"
                                                     EditTrigger="@editTrigger" />
                        <BaseballPitchingTotals Totals="HomePitchingTotals" />
                    </MudTabPanel>
                </MudTabs>

            </MudItem>
        }
        else
        {
            <Loading />
        }
    </Authorized>
    <NotAuthorized>
        <NoAccess />
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter]
    public string Id { get; set; }
    private bool PageLoad = false;
    List<BaseballGameStatsModel> Model = new List<BaseballGameStatsModel>();
    BaseballGameStatsModel hittingStatSelectedItem = null;
    BaseballGameStatsModel pitchingStatSelectedItem = null;
    BaseballGameStatsModel hittingStatBeforeEdit;
    BaseballGameStatsModel pitchingStatBeforeEdit;
    GetGameByIdResponse GameModel { get; set; }
    GetLeagueByIdResponse LeagueByIdResponse { get; set; }
    GetTeamByIdResponse AwayTeamByIdResponse { get; set; }
    GetTeamByIdResponse HomeTeamByIdResponse { get; set; }
    GetPlayersByTeamResponse AwayPlayersModel { get; set; }
    GetPlayersByTeamResponse HomePlayersModel { get; set; }
    GetBaseballStatsByTeamResponse AwayPlayerStatsModel { get; set; }
    GetBaseballStatsByTeamResponse HomePlayerStatsModel { get; set; }
    GetBaseballStatsByPlayerResponse PlayerStatsModel { get; set; }
    private IJSObjectReference? _module;
    private TableEditButtonPosition editButtonPosition = TableEditButtonPosition.End;
    private TableEditTrigger editTrigger = TableEditTrigger.RowClick;

    private HittingTotalAccumalator AwayHit = new();
    private PitchingTotalAccumalator AwayPitch = new();

    private BaseballHittingTotalsModel AwayHittingTotals => new()
    {
        AtBats = AwayHit.AtBats,
        Runs = AwayHit.Runs,
        Hits = AwayHit.Hits,
        RBIs = AwayHit.RBIs,
        Walks = AwayHit.Walks,
        HBPs = AwayHit.HBPs,
        Strikeouts = AwayHit.Strikeouts,
        SBs = AwayHit.SBs,
        TBs = AwayHit.TotalBases,
        Doubles = AwayHit.Doubles,
        Triples = AwayHit.Triples,
        HomeRuns = AwayHit.HomeRuns,
        SFs = AwayHit.SFs
    };

    private BaseballPitchingTotalsModel AwayPitchingTotals => new()
    {
        Wins = AwayPitch.Wins,
        Losses = AwayPitch.Losses,
        Runs = AwayPitch.Runs,
        Saves = AwayPitch.Saves,
        Innings = AwayPitch.Innings,
        HitsAllowed = AwayPitch.HitsAllowed,
        WalksAllowed = AwayPitch.WalksAllowed,
        Strikeouts = AwayPitch.Strikeouts
    };

    private HittingTotalAccumalator HomeHit = new();
    private PitchingTotalAccumalator HomePitch = new();

    private BaseballHittingTotalsModel HomeHittingTotals => new()
    {
        AtBats = HomeHit.AtBats,
        Runs = HomeHit.Runs,
        Hits = HomeHit.Hits,
        RBIs = HomeHit.RBIs,
        Walks = HomeHit.Walks,
        HBPs = HomeHit.HBPs,
        Strikeouts = HomeHit.Strikeouts,
        SBs = HomeHit.SBs,
        TBs = HomeHit.TotalBases,
        Doubles = HomeHit.Doubles,
        Triples = HomeHit.Triples,
        HomeRuns = HomeHit.HomeRuns,
        SFs = HomeHit.SFs
    };

    private BaseballPitchingTotalsModel HomePitchingTotals => new()
    {
        Wins = HomePitch.Wins,
        Losses = HomePitch.Losses,
        Runs = HomePitch.Runs,
        Saves = HomePitch.Saves,
        Innings = HomePitch.Innings,
        HitsAllowed = HomePitch.HitsAllowed,
        WalksAllowed = HomePitch.WalksAllowed,
        Strikeouts = HomePitch.Strikeouts
    };


    protected override async Task OnInitializedAsync()
    {
        try
        {
            var gameId = Guid.Parse(Id);
            GameModel = await DataLoader.GetOrLoad(
                () => GameLocalCache.GetGameByIdCache(Id),
                () => GameService.GetGameById(gameId),
                (g) => GameLocalCache.SetGameByIdCache(Id, g)
            );

            AwayPlayersModel = await DataLoader.GetOrLoad(
                () => PlayerLocalCache.GetPlayersByTeamCache(GameModel.Game.AwayTeam.Id.ToString()),
                () => PlayerService.GetPlayersByTeam(GameModel.Game.AwayTeam.Id),
                (p) => PlayerLocalCache.SetPlayersByTeamCache(GameModel.Game.AwayTeam.Id.ToString(), p)
            );

            HomePlayersModel = await DataLoader.GetOrLoad(
                () => PlayerLocalCache.GetPlayersByTeamCache(GameModel.Game.HomeTeam.Id.ToString()),
                () => PlayerService.GetPlayersByTeam(GameModel.Game.HomeTeam.Id),
                (p) => PlayerLocalCache.SetPlayersByTeamCache(GameModel.Game.HomeTeam.Id.ToString(), p)
            );

            AwayPlayerStatsModel = await DataLoader.GetOrLoad(
                () => StatsLocalCache.GetBaseballStatsByTeamCache(GameModel.Game.AwayTeam.Id.ToString()),
                () => StatsService.GetBaseballStatsByTeam(GameModel.Game.AwayTeam.Id),
                (p) => StatsLocalCache.SetBaseballStatsByTeamCache(GameModel.Game.AwayTeam.Id.ToString(), p)
            );

            HomePlayerStatsModel = await DataLoader.GetOrLoad(
                () => StatsLocalCache.GetBaseballStatsByTeamCache(GameModel.Game.HomeTeam.Id.ToString()),
                () => StatsService.GetBaseballStatsByTeam(GameModel.Game.HomeTeam.Id),
                (p) => StatsLocalCache.SetBaseballStatsByTeamCache(GameModel.Game.HomeTeam.Id.ToString(), p)
            );

            await GetImageAsync();

            ProcessTeamStats(AwayPlayersModel.Players, AwayPlayerStatsModel, true);
            ProcessTeamStats(HomePlayersModel.Players, HomePlayerStatsModel, false);

            PageLoad = true;
        }
        catch (Exception ex)
        {
            await HandleError(ex);
        }
    }

    private void ProcessTeamStats(IEnumerable<PlayerModel> players,
        GetBaseballStatsByTeamResponse stats,
        bool isAway)
    {
        foreach (var player in players)
        {
            var playerStat = stats.BaseballStats.FirstOrDefault(x => x.PlayerId == player.Id && x.GameId == GameModel.Game.Id);
            if (playerStat is not null)
            {
                AddPlayerStats(player, playerStat);
                AccumulateTotals(playerStat, isAway);
            }
            else if (GameModel.Game.GameStatus == GameStatus.Completed)
                Model.Add(new BaseballGameStatsModel(GameModel.Game.LeagueId, player.TeamId, player.Id, GameModel.Game.SeasonId, GameModel.Game.Id, player.FirstName, player.LastName, player.PlayerDetail.Position));
        }
    }

    private void AddPlayerStats(
    PlayerModel player,
    Models.Stats.Baseball.BaseballStatsModel playerStat
   )
    {
        Model.Add(new BaseballGameStatsModel(
            GameModel.Game.LeagueId, 
            player.TeamId, 
            player.Id, 
            GameModel.Game.SeasonId,
            GameModel.Game.Id, 
            player.FirstName, 
            player.LastName, 
            player.PlayerDetail.Position,                                   
            playerStat.HittingStats.AtBats, 
            playerStat.HittingStats.Hits, 
            playerStat.HittingStats.TotalBases, 
            playerStat.HittingStats.Runs, 
            playerStat.HittingStats.Doubles,
            playerStat.HittingStats.Triples, 
            playerStat.HittingStats.HomeRuns, 
            playerStat.HittingStats.RunsBattedIn, 
            playerStat.HittingStats.StolenBases,
            playerStat.HittingStats.Strikeouts, 
            playerStat.HittingStats.Walks, 
            playerStat.HittingStats.HitByPitch, 
            playerStat.HittingStats.SacrificeFly, 
            playerStat.PitchingStats.Wins,
            playerStat.PitchingStats.Losses, 
            playerStat.PitchingStats.Runs,
            playerStat.PitchingStats.Start, 
            playerStat.PitchingStats.Saves, 
            playerStat.PitchingStats.Innings, 
            playerStat.PitchingStats.HitsAllowed, 
            playerStat.PitchingStats.WalksAllowed,
            playerStat.PitchingStats.PitchingStrikeouts));
    }

    private void AccumulateTotals(Models.Stats.Baseball.BaseballStatsModel playerStat, bool isAway)
    {
        var hit = isAway ? AwayHit : HomeHit;
        var pitch = isAway ? AwayPitch : HomePitch;

        hit.AtBats += playerStat.HittingStats.AtBats;
        hit.Hits += playerStat.HittingStats.Hits;
        hit.TotalBases += playerStat.HittingStats.TotalBases;
        hit.Runs += playerStat.HittingStats.Runs;
        hit.Doubles += playerStat.HittingStats.Doubles;
        hit.Triples += playerStat.HittingStats.Triples;
        hit.HomeRuns += playerStat.HittingStats.HomeRuns;
        hit.RBIs += playerStat.HittingStats.RunsBattedIn;
        hit.SBs += playerStat.HittingStats.StolenBases;
        hit.Walks += playerStat.HittingStats.Walks;
        hit.HBPs += playerStat.HittingStats.HitByPitch;
        hit.SFs += playerStat.HittingStats.SacrificeFly;
        hit.Strikeouts += playerStat.HittingStats.Strikeouts;

        pitch.Wins += playerStat.PitchingStats.Wins;
        pitch.Losses += playerStat.PitchingStats.Losses;
        pitch.Runs += playerStat.PitchingStats.Runs;
        pitch.Saves += playerStat.PitchingStats.Saves;
        pitch.Innings = DataLoader.AddInnings(pitch.Innings, playerStat.PitchingStats.Innings);
        pitch.HitsAllowed += playerStat.PitchingStats.HitsAllowed;
        pitch.WalksAllowed += playerStat.PitchingStats.WalksAllowed;
        pitch.Strikeouts += playerStat.PitchingStats.PitchingStrikeouts;
    }


    private void BackupHittingItem(object stats)
    {
        hittingStatBeforeEdit = Clone((BaseballGameStatsModel)stats);
    }

    private void BackupPitchingItem(object stats)
    {
        pitchingStatBeforeEdit = Clone((BaseballGameStatsModel)stats);
    }

    private void ResetHittingItemToOriginalValues(object stats)
    {
        Reset((BaseballGameStatsModel)stats, hittingStatBeforeEdit);
    }

    private void ResetPitchingItemToOriginalValues(object stats)
    {
        Reset((BaseballGameStatsModel)stats, pitchingStatBeforeEdit);
    }

    private T Clone<T>(T source)
    {
        return System.Text.Json.JsonSerializer.Deserialize<T>(System.Text.Json.JsonSerializer.Serialize(source));
    }

    private void Reset<T>(T target, T backup)
    {
        var restored = Clone(backup);
        foreach (var prop in typeof(T).GetProperties())
            prop.SetValue(target, prop.GetValue(restored));
    }

    private async Task SubmitHittingStats()
    {
        try
        {
            if (hittingStatSelectedItem is null)
                return;

            var form = Model.FirstOrDefault(x => x.PlayerId == hittingStatSelectedItem.PlayerId);

            PlayerStatsModel = await DataLoader.GetOrLoad(
                () => StatsLocalCache.GetBaseballStatsByPlayerCache(hittingStatSelectedItem.PlayerId.ToString()),
                () => StatsService.GetBaseballStatsByPlayer(hittingStatSelectedItem.PlayerId),
                (p) => StatsLocalCache.SetBaseballStatsByPlayerCache(hittingStatSelectedItem.PlayerId.ToString(), p)
            );

            var existing = PlayerStatsModel.BaseballStats.FirstOrDefault(x => x.GameId == hittingStatSelectedItem.GameId);

            if (existing is not null)
            {
                var update = new UpdateBaseballStatsModel(existing.Id, hittingStatSelectedItem.LeagueId, hittingStatSelectedItem.TeamId,
                                                                                            hittingStatSelectedItem.PlayerId, hittingStatSelectedItem.SeasonId,
                                                                                            hittingStatSelectedItem.GameId, BuildHittingUpdate(hittingStatSelectedItem), BuildPitchingUpdate(form));

                await StatsService.UpdateBaseballStats(new(update));
                await InvalidateBaseballCaches(form);

                ApplyHittingTotalsDelta(hittingStatSelectedItem, existing);
            }
            else
            {                                                                                                       
                var create = new CreateBaseballStatsModel(hittingStatSelectedItem.LeagueId, hittingStatSelectedItem.TeamId,
                                                                                            hittingStatSelectedItem.PlayerId, hittingStatSelectedItem.SeasonId,
                                                                                            hittingStatSelectedItem.GameId, BuildHittingCreate(hittingStatSelectedItem), BuildPitchingCreate(form));

                await StatsService.CreateBaseballStats(new(create));
                ApplyHittingTotalsDelta(hittingStatSelectedItem, DataLoader.CreateZeroBaseballStats());

            }

            await InvalidateBaseballCaches(form);
            Snackbar.Add("Players Hitting Stats have been saved.", MudBlazor.Severity.Success);
            StateHasChanged();

        }
        catch (Exception ex)
        {
            await HandleError(ex);
        }
    }

    private async Task SubmitPitchingStats()
    {
        try
        {

            if (pitchingStatSelectedItem is null)
                return;

            var form = Model.FirstOrDefault(x => x.PlayerId == pitchingStatSelectedItem.PlayerId);

            PlayerStatsModel = await DataLoader.GetOrLoad(
                () => StatsLocalCache.GetBaseballStatsByPlayerCache(pitchingStatSelectedItem.PlayerId.ToString()),
                () => StatsService.GetBaseballStatsByPlayer(pitchingStatSelectedItem.PlayerId),
                (p) => StatsLocalCache.SetBaseballStatsByPlayerCache(pitchingStatSelectedItem.PlayerId.ToString(), p)
            );

            var existing = PlayerStatsModel.BaseballStats.FirstOrDefault(x => x.GameId == pitchingStatSelectedItem.GameId);

            if (existing is not null)
            {

                var update = new UpdateBaseballStatsModel(existing.Id, pitchingStatSelectedItem.LeagueId, pitchingStatSelectedItem.TeamId,
                                                                                            pitchingStatSelectedItem.PlayerId, pitchingStatSelectedItem.SeasonId,
                                                                                            pitchingStatSelectedItem.GameId, BuildHittingUpdate(form), BuildPitchingUpdate(pitchingStatSelectedItem));

                await StatsService.UpdateBaseballStats(new(update));
                ApplyPitchingTotalsDelta(pitchingStatSelectedItem, existing);
            }
            else
            {
                var create = new CreateBaseballStatsModel(pitchingStatSelectedItem.LeagueId, pitchingStatSelectedItem.TeamId,
                                                                                            pitchingStatSelectedItem.PlayerId, pitchingStatSelectedItem.SeasonId,
                                                                                            pitchingStatSelectedItem.GameId, BuildHittingCreate(form), BuildPitchingCreate(pitchingStatSelectedItem));

                await StatsService.CreateBaseballStats(new(create));
                ApplyPitchingTotalsDelta(pitchingStatSelectedItem, DataLoader.CreateZeroBaseballStats());
            }

            await InvalidateBaseballCaches(form);
            Snackbar.Add("Players Pitching Stats have been saved.", MudBlazor.Severity.Success);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await HandleError(ex);
        }
    }

    private async Task InvalidateBaseballCaches(BaseballGameStatsModel form)
    {
        await StatsLocalCache.DeleteLeagueBaseballStatsBySeasonCache(form.LeagueId.ToString(), form.SeasonId.ToString());
        await StatsLocalCache.DeleteBaseballStatsByTeamCache(form.TeamId.ToString());
        await StatsLocalCache.DeleteBaseballStatsByPlayerCache(form.PlayerId.ToString());
        await StatsLocalCache.DeletePlayerBaseballStatsBySeasonCache(form.PlayerId.ToString(), form.SeasonId.ToString());
    }

    private void ApplyHittingTotalsDelta(BaseballGameStatsModel updated, BaseballStatsModel original)
    {
        var delta = new
        {
            AtBats = updated.AtBats - original.HittingStats.AtBats,
            Hits = updated.Hits - original.HittingStats.Hits,
            TotalBases = updated.TotalBases - original.HittingStats.TotalBases,
            Runs = updated.Runs - original.HittingStats.Runs,
            Doubles = updated.Doubles - original.HittingStats.Doubles,
            Triples = updated.Triples - original.HittingStats.Triples,
            HomeRuns = updated.HomeRuns - original.HittingStats.HomeRuns,
            RBIs = updated.RunsBattedIn - original.HittingStats.RunsBattedIn,
            SBs = updated.StolenBases - original.HittingStats.StolenBases,
            Walks = updated.Walks - original.HittingStats.Walks,
            HBPs = updated.HitByPitch - original.HittingStats.HitByPitch,
            SFs = updated.SacrificeFly - original.HittingStats.SacrificeFly,
            Strikeouts = updated.Strikeouts - original.HittingStats.Strikeouts,
        };

        var totals = updated.TeamId == GameModel.Game.AwayTeam.Id ? AwayHit : HomeHit;

        totals.AtBats += delta.AtBats;
        totals.Hits += delta.Hits;
        totals.TotalBases += delta.TotalBases;
        totals.Runs += delta.Runs;
        totals.Doubles += delta.Doubles;
        totals.Triples += delta.Triples;
        totals.HomeRuns += delta.HomeRuns;
        totals.RBIs += delta.RBIs;
        totals.SBs += delta.SBs;
        totals.Walks += delta.Walks;
        totals.HBPs += delta.HBPs;
        totals.SFs += delta.SFs;
        totals.Strikeouts += delta.Strikeouts;
    }

    private void ApplyPitchingTotalsDelta(BaseballGameStatsModel updated, BaseballStatsModel original)
    {
        var delta = new
        {
            Wins = updated.Wins - original.PitchingStats.Wins,
            Losses = updated.Losses - original.PitchingStats.Losses,
            Runs = updated.PitchingRuns - original.PitchingStats.Runs,
            Saves = updated.Saves - original.PitchingStats.Saves,
            InningsDelta = updated.Innings - original.PitchingStats.Innings,
            HitsAllowed = updated.HitsAllowed - original.PitchingStats.HitsAllowed,
            WalksAllowed = updated.WalksAllowed - original.PitchingStats.WalksAllowed,
            Strikeouts = updated.PitchingStrikeouts - original.PitchingStats.PitchingStrikeouts
        };

        var totals = updated.TeamId == GameModel.Game.AwayTeam.Id ? AwayPitch : HomePitch;

        totals.Wins += delta.Wins;
        totals.Losses += delta.Losses;
        totals.Runs += delta.Runs;
        totals.Saves += delta.Saves;
        totals.Innings = DataLoader.AddInnings(totals.Innings, delta.InningsDelta);

        totals.HitsAllowed += delta.HitsAllowed;
        totals.WalksAllowed += delta.WalksAllowed;
        totals.Strikeouts += delta.Strikeouts;
    }

    private UpdateBaseballHittingStatsModel BuildHittingUpdate(BaseballGameStatsModel form)
    {
        return new UpdateBaseballHittingStatsModel(form.AtBats, form.Hits,
                                            form.TotalBases, form.Runs,
                                            form.Doubles, form.Triples,
                                            form.HomeRuns, form.RunsBattedIn,
                                            form.StolenBases, form.Strikeouts, form.Walks, form.HitByPitch,
                                            form.SacrificeFly);
    }

    private UpdateBaseballPitchingStatsModel BuildPitchingUpdate(BaseballGameStatsModel form)
    {
        return new UpdateBaseballPitchingStatsModel(form.Wins, form.Losses, form.PitchingRuns,
                                                    form.Start, form.Saves, form.Innings,
                                                    form.HitsAllowed, form.WalksAllowed, form.PitchingStrikeouts);

    }

    private CreateBaseballHittingStatsModel BuildHittingCreate(BaseballGameStatsModel form)
    {
        return new CreateBaseballHittingStatsModel(form.AtBats, form.Hits,
                                                form.TotalBases, form.Runs,
                                                form.Doubles, form.Triples,
                                                form.HomeRuns, form.RunsBattedIn,
                                                form.StolenBases, form.Strikeouts, form.Walks, form.HitByPitch, form.SacrificeFly);
    }

    private CreateBaseballPitchingStatsModel BuildPitchingCreate(BaseballGameStatsModel form)
    {
        return new CreateBaseballPitchingStatsModel(form.Wins, form.Losses, form.PitchingRuns,
                                                form.Start, form.Saves, form.Innings,
                                                form.HitsAllowed, form.WalksAllowed, form.PitchingStrikeouts);

    }

    private async Task GetImageAsync()
    {
        LeagueByIdResponse = await DataLoader.GetOrLoad(
            () => LeagueLocalCache.GetLeagueByIdCache(GameModel.Game.LeagueId.ToString()),
            () => LeagueService.GetLeague(GameModel.Game.LeagueId),
            (l) => LeagueLocalCache.SetLeagueByIdCache(GameModel.Game.LeagueId.ToString(), l)
        );

        AwayTeamByIdResponse = await DataLoader.GetOrLoad(
            () => TeamLocalCache.GetTeamByIdCache(GameModel.Game.AwayTeam.Id.ToString()),
            () => TeamService.GetTeamById(GameModel.Game.AwayTeam.Id),
            (t) => TeamLocalCache.SetTeamByIdCache(GameModel.Game.AwayTeam.Id.ToString(), t)
        );

        HomeTeamByIdResponse = await DataLoader.GetOrLoad(
            () => TeamLocalCache.GetTeamByIdCache(GameModel.Game.HomeTeam.Id.ToString()),
            () => TeamService.GetTeamById(GameModel.Game.HomeTeam.Id),
            (t) => TeamLocalCache.SetTeamByIdCache(GameModel.Game.HomeTeam.Id.ToString(), t)
        );
        var awayTeamKeyPath = $"/{LeagueByIdResponse.League.Sport}/{LeagueByIdResponse.League.Name}/teams/{AwayTeamByIdResponse.Team.TeamName}/{AwayTeamByIdResponse.Team.ImageFile}";
        GameModel.Game.AwayTeamImage = await AWSService.GetImage(awayTeamKeyPath);

        var homeTeamKeyPath = $"/{LeagueByIdResponse.League.Sport}/{LeagueByIdResponse.League.Name}/teams/{HomeTeamByIdResponse.Team.TeamName}/{HomeTeamByIdResponse.Team.ImageFile}";
        GameModel.Game.HomeTeamImage = await AWSService.GetImage(homeTeamKeyPath);
    }

    private async Task HandleError(Exception ex)
    {
        if (KeycloakTokenService.ShouldForceLogout())
        {
            _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/authRefresh.js");
            await _module.InvokeVoidAsync("logout");
        }
        ErrorState.Message = ex.Message;
        NavManager.NavigateTo("/error");
    }
}
