@page "/baseballgamelineup/{id}"
@inject IGameService GameService
@inject ITeamService TeamService
@inject IPlayerService PlayerService
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager NavManager
@inject ErrorState ErrorState
@inject IAWSService AWSService
@inject IJSRuntime JsRuntime
@inject KeycloakTokenService KeycloakTokenService
@inject IGameLocalCacheService GameLocalCache
@inject ITeamLocalCacheService TeamLocalCache
@inject IPlayerLocalCacheService PlayerLocalCache

<AuthorizeView Roles="@Roles.ReadGames" Context="auth">
    <Authorized>
        @if (PageLoad)
        {
            <MudItem Style="padding-top: 50px;">
                <MudPaper Class="border border-solid" Style="border-color: #000000; padding: 25px;">
                    <MudText Typo="Typo.h5" Align="Align.Center" Style="font-weight:bold">@AwayTeam.Team.TeamName vs @HomeTeam.Team.TeamName Lineups</MudText>
                </MudPaper>
            </MudItem>
            <MudItem Style="padding-top: 25px;">
                <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Centered="true" Color="Color.Primary" Class="border border-solid" Style="border-color: #000000; padding: 25px;">
                    <MudTabPanel Text="@AwayTeam.Team.TeamName">
                         <MudItem Style="padding-top: 25px;">
                             <MudGrid>
                                 <MudItem xs="12" md="12">
                                     <MudStack Row="true">
                                        <MudItem xs="6" md="6">
                                            <LineupList Title="Lineup"
                                                        Players="AwayLineup.Take(9)"
                                                        ItemText="@(p => $"{p.BattingOrderPosition}. {p.PlayerName}, {p.Position}")" />
                                        </MudItem>
                                        <MudItem xs="6" md="6">
                                            <LineupList Title="Bench"
                                                        Players="AwayLineup.Skip(9)"
                                                        ItemText="@(p => $"{p.PlayerName}, {p.Position}")" />
                                        </MudItem>
                                     </MudStack>
                                    <LineupList Title="Starting Pitcher"
                                                Players="AwayPitchers"
                                                ItemText="@(p => AwayLineupResponse.GameLineup.BaseballLineup.StartingPitcher == p.Id
                                                            ? $"{p.FirstName} {p.LastName} Starter"
                                                            : $"{p.FirstName} {p.LastName}")" />
                                 </MudItem>
                             </MudGrid>
                         </MudItem>
                    </MudTabPanel>
                    <MudTabPanel Text="@HomeTeam.Team.TeamName">
                        <MudItem Style="padding-top: 25px;">
                            <MudGrid>
                                <MudItem xs="12" md="12">
                                    <MudStack Row="true">
                                        <MudItem xs="6" md="6">
                                            <LineupList Title="Lineup"
                                                        Players="AwayLineup.Take(9)"
                                                        ItemText="@(p => $"{p.BattingOrderPosition}. {p.PlayerName}, {p.Position}")" />
                                        </MudItem>
                                        <MudItem xs="6" md="6">
                                            <LineupList Title="Bench"
                                                        Players="AwayLineup.Skip(9)"
                                                        ItemText="@(p => $"{p.PlayerName}, {p.Position}")" />
                                        </MudItem>
                                    </MudStack>
                                    <LineupList Title="Starting Pitcher"
                                                Players="AwayPitchers"
                                                ItemText="@(p => AwayLineupResponse.GameLineup.BaseballLineup.StartingPitcher == p.Id
                                                            ? $"{p.FirstName} {p.LastName} Starter"
                                                            : $"{p.FirstName} {p.LastName}")" />
                                </MudItem>
                            </MudGrid>
                        </MudItem>
                    </MudTabPanel>
                </MudTabs>
            </MudItem>
        }
        else
        {
            <Loading />
        }
    </Authorized>
    <NotAuthorized>
        <NoAccess />
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter]
    public string Id { get; set; }
    private bool PageLoad = false;
    private int benchNumber = 9; //number of players allowed in the lineup this will increment starting at 10
    private GetGameByIdResponse GameByIdResponse { get; set; }
    private GetBaseballGameLineupByGameIdResponse AwayLineupResponse { get; set; }
    private GetBaseballGameLineupByGameIdResponse HomeLineupResponse { get; set; }
    private GetTeamByIdResponse AwayTeam { get; set; }
    private GetTeamByIdResponse HomeTeam { get; set; }
    private GetPlayersByTeamResponse AwayTeamPlayers { get; set; }
    private GetPlayersByTeamResponse HomeTeamPlayers { get; set; }
    private List<LineupListItem> AwayLineup = new();
    private List<LineupListItem> HomeLineup = new();
    private List<PlayerModel> AwayPitchers = new();
    private List<PlayerModel> HomePitchers = new();
    private IJSObjectReference? _module;
    private Dictionary<string, string> BaseballPositions = new();


    protected override async Task OnInitializedAsync()
    {
        try
        {
            var gameId = Guid.Parse(Id);
            GameByIdResponse = await GameService.GetGameById(gameId);
            BaseballPositions = Constants.BaseballPositions();

            await SetupTeam(
                teamId: GameByIdResponse.Game.AwayTeam.Id, 
                lineupSetter: x => AwayLineupResponse = x, 
                lineupList: AwayLineup, 
                pitchersList: AwayPitchers, 
                playersSetter: x => AwayTeamPlayers = x,
                teamSetter: x => AwayTeam = x);

            await SetupTeam(
                teamId: GameByIdResponse.Game.HomeTeam.Id,
                lineupSetter: x => HomeLineupResponse = x,
                lineupList: HomeLineup,
                pitchersList: HomePitchers,
                playersSetter: x => HomeTeamPlayers = x,
                teamSetter: x => HomeTeam = x);


            PageLoad = true;

        }
        catch (Exception ex)
        {
            if (KeycloakTokenService.ShouldForceLogout())
            {
                _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/authRefresh.js");
                await _module.InvokeVoidAsync("logout");
            }
            ErrorState.Message = ex.Message;
            NavManager.NavigateTo("/error");
        }

    }

    private async Task SetupTeam(
        Guid teamId,
        Action<GetBaseballGameLineupByGameIdResponse> lineupSetter,
        List<LineupListItem> lineupList,
        List<PlayerModel> pitchersList,
        Action<GetPlayersByTeamResponse> playersSetter,
        Action<GetTeamByIdResponse> teamSetter)
    {
        var team = await DataLoader.GetOrLoad(
            () => TeamLocalCache.GetTeamByIdCache(teamId.ToString()),
            () => TeamService.GetTeamById(teamId),
            (t) => TeamLocalCache.SetTeamByIdCache(teamId.ToString(), t)
        );
        teamSetter(team);

        var players = await DataLoader.GetOrLoad(
            () => PlayerLocalCache.GetPlayersByTeamCache(team.Team.Id.ToString()),
            () => PlayerService.GetPlayersByTeam(team.Team.Id),
            (p) => PlayerLocalCache.SetPlayersByTeamCache(team.Team.Id.ToString(), p)
        );
        playersSetter(players);

        pitchersList.AddRange(players.Players.Where(x => x.PlayerDetail.Position == PositionFilter.BASEBALL));

        var lineupResponse = await DataLoader.GetOrLoad(
            () => GameLocalCache.GetBaseballGameLineupByGameIdCache(Id, team.Team.Id.ToString()),
            () => GameService.GetBaseballGameLineupByGameId(Guid.Parse(Id), team.Team.Id),
            (g) => GameLocalCache.SetBaseballGameLineupByGameIdCache(Id, team.Team.Id.ToString(), g)
        );
        lineupSetter(lineupResponse);
        
        CreateLineup(players.Players, lineupResponse.GameLineup.BaseballLineup, lineupList, team.Team.Id);

        lineupList.Sort((a, b) => a.BattingOrderPosition.CompareTo(b.BattingOrderPosition));
    }

    private void CreateLineup(
        IEnumerable<PlayerModel> players,
        BaseballGameLineup lineup,
        List<LineupListItem> list,
        Guid teamId)
    {
        foreach(var player in players.Where(x => x.PlayerDetail.Position != PositionFilter.BASEBALL))
        {
            var item = new LineupListItem
                {
                    PlayerId = player.Id,
                    TeamId = teamId,
                    PlayerName = $"{player.FirstName} {player.LastName}",
                    Position = player.PlayerDetail.Position,
                    BattingOrderPosition = ResolveBattingOrder(lineup, player.Id)
                };

            list.Add(item);
        }
    }

    private int ResolveBattingOrder(BaseballGameLineup lineup, Guid playerId)
    {
        return playerId switch
        {
            var id when id == lineup.First => 1,
            var id when id == lineup.Second => 2,
            var id when id == lineup.Third => 3,
            var id when id == lineup.Fourth => 4,
            var id when id == lineup.Fifth => 5,
            var id when id == lineup.Sixth => 6,
            var id when id == lineup.Seventh => 7,
            var id when id == lineup.Eighth => 8,
            var id when id == lineup.Ninth => 9,
            _ => benchNumber++
        };
    }

    public class LineupListItem
    {
        public Guid PlayerId { get; set; }
        public Guid TeamId { get; set; }
        public string PlayerName { get; set; }
        public string Position { get; set; }
        public int BattingOrderPosition { get; set; }
    }

}
