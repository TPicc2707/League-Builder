@page "/editfootballgamestats/{id}"
@using League.Builder.Web.Server.Services.Cache
@inject IStatsService StatsService
@inject IGameService GameService
@inject ILeagueService LeagueService
@inject ITeamService TeamService
@inject IPlayerService PlayerService
@inject IAWSService AWSService
@inject ISnackbar Snackbar
@inject NavigationManager NavManager
@inject ErrorState ErrorState
@inject ImageService ImageService
@inject StatsSubmissionService StatsSubmissionService
@inject IHttpContextAccessor HttpContextAccessor
@inject IGameLocalCacheService GameLocalCache
@inject IPlayerLocalCacheService PlayerLocalCache
@inject IStatsLocalCacheService StatsLocalCache
@inject ILeagueLocalCacheService LeagueLocalCache
@inject ITeamLocalCacheService TeamLocalCache
@inject IJSRuntime JsRuntime
@inject KeycloakTokenService KeycloakTokenService

<AuthorizeView Roles="@String.Concat(Roles.CreateStats, ", ", Roles.UpdateStats)" Context="auth">
    <Authorized>
        @if (PageLoad)
        {
            <TeamHeader Game="GameModel.Game" />
            <MudItem Style="padding-top: 25px;">
                <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Centered="true" Color="Color.Primary" Class="border border-solid" Style="border-color: #000000; padding: 25px;">
                    <MudTabPanel Text="@($"{GameModel.Game.AwayTeam.TeamName} Stats")">
                        <ModifyFootballPassingTable Stats="AwayStatsModel"
                                                    SelectedItem="passingStatSelectedItem"
                                                    SelectedItemChanged="@(v => passingStatSelectedItem = v)"
                                                    OnCommit="SubmitPassingStats"
                                                    OnBackup="BackupPassingItem"
                                                    OnReset="ResetPassingItemToOriginalValues"
                                                    EditButtonPosition="@editButtonPosition"
                                                    EditTrigger="@editTrigger" />
                        <FootballPassingTotals Totals="AwayPassingTotals" />
                        <ModifyFootballRushingTable Stats="AwayStatsModel"
                                                    SelectedItem="rushingStatSelectedItem"
                                                    SelectedItemChanged="@(v => rushingStatSelectedItem = v)"
                                                    OnCommit="SubmitRushingStats"
                                                    OnBackup="BackupRushingItem"
                                                    OnReset="ResetRushingItemToOriginalValues"
                                                    EditButtonPosition="@editButtonPosition"
                                                    EditTrigger="@editTrigger" />
                        <FootballRushingTotals Totals="AwayRushingTotals" />
                        <ModifyFootballReceivingTable Stats="AwayStatsModel"
                                                    SelectedItem="receivingStatSelectedItem"
                                                    SelectedItemChanged="@(v => receivingStatSelectedItem = v)"
                                                    OnCommit="SubmitReceivingStats"
                                                    OnBackup="BackupReceivingItem"
                                                    OnReset="ResetReceivingItemToOriginalValues"
                                                    EditButtonPosition="@editButtonPosition"
                                                    EditTrigger="@editTrigger" />
                        <FootballReceivingTotals Totals="AwayReceivingTotals" />
                        <ModifyFootballDefensiveTable Stats="AwayStatsModel"
                                                      SelectedItem="defensiveStatSelectedItem"
                                                      SelectedItemChanged="@(v => defensiveStatSelectedItem = v)"
                                                      OnCommit="SubmitDefensiveStats"
                                                      OnBackup="BackupDefensiveItem"
                                                      OnReset="ResetDefensiveItemToOriginalValues"
                                                      EditButtonPosition="@editButtonPosition"
                                                      EditTrigger="@editTrigger" />
                        <FootballDefensiveTotals Totals="AwayDefensiveTotals" />
                        <ModifyFootballKickingTable Stats="AwayStatsModel"
                                                      SelectedItem="kickingStatSelectedItem"
                                                    SelectedItemChanged="@(v => kickingStatSelectedItem = v)"
                                                      OnCommit="SubmitKickingStats"
                                                    OnBackup="BackupKickingItem"
                                                    OnReset="ResetKickingItemToOriginalValues"
                                                      EditButtonPosition="@editButtonPosition"
                                                      EditTrigger="@editTrigger" />
                        <FootballKickingTotals Totals="AwayKickingTotals" />
                    </MudTabPanel>
                    <MudTabPanel Text="@($"{GameModel.Game.AwayTeam.TeamName} Stats")">
                        <ModifyFootballPassingTable Stats="HomeStatsModel"
                                                    SelectedItem="passingStatSelectedItem"
                                                    SelectedItemChanged="@(v => passingStatSelectedItem = v)"
                                                    OnCommit="SubmitPassingStats"
                                                    OnBackup="BackupPassingItem"
                                                    OnReset="ResetPassingItemToOriginalValues"
                                                    EditButtonPosition="@editButtonPosition"
                                                    EditTrigger="@editTrigger" />
                        <FootballPassingTotals Totals="HomePassingTotals" />
                        <ModifyFootballRushingTable Stats="HomeStatsModel"
                                                    SelectedItem="rushingStatSelectedItem"
                                                    SelectedItemChanged="@(v => rushingStatSelectedItem = v)"
                                                    OnCommit="SubmitRushingStats"
                                                    OnBackup="BackupRushingItem"
                                                    OnReset="ResetRushingItemToOriginalValues"
                                                    EditButtonPosition="@editButtonPosition"
                                                    EditTrigger="@editTrigger" />
                        <FootballRushingTotals Totals="HomeRushingTotals" />
                        <ModifyFootballReceivingTable Stats="HomeStatsModel"
                                                      SelectedItem="receivingStatSelectedItem"
                                                      SelectedItemChanged="@(v => receivingStatSelectedItem = v)"
                                                      OnCommit="SubmitReceivingStats"
                                                      OnBackup="BackupReceivingItem"
                                                      OnReset="ResetReceivingItemToOriginalValues"
                                                      EditButtonPosition="@editButtonPosition"
                                                      EditTrigger="@editTrigger" />
                        <FootballReceivingTotals Totals="HomeReceivingTotals" />                        
                        <ModifyFootballDefensiveTable Stats="HomeStatsModel"
                                                      SelectedItem="defensiveStatSelectedItem"
                                                      SelectedItemChanged="@(v => defensiveStatSelectedItem = v)"
                                                      OnCommit="SubmitDefensiveStats"
                                                      OnBackup="BackupDefensiveItem"
                                                      OnReset="ResetDefensiveItemToOriginalValues"
                                                      EditButtonPosition="@editButtonPosition"
                                                      EditTrigger="@editTrigger" />
                        <FootballDefensiveTotals Totals="HomeDefensiveTotals" />
                        <ModifyFootballKickingTable Stats="HomeStatsModel"
                                                    SelectedItem="kickingStatSelectedItem"
                                                    SelectedItemChanged="@(v => kickingStatSelectedItem = v)"
                                                    OnCommit="SubmitKickingStats"
                                                    OnBackup="BackupKickingItem"
                                                    OnReset="ResetKickingItemToOriginalValues"
                                                    EditButtonPosition="@editButtonPosition"
                                                    EditTrigger="@editTrigger" />
                        <FootballKickingTotals Totals="HomeKickingTotals" />
                    </MudTabPanel>
                </MudTabs>
            </MudItem>
        }
        else
        {
            <Loading />
        }
    </Authorized>
        <NotAuthorized>
        <MudText>You are not authorized to view this page...</MudText>
    </NotAuthorized>
</AuthorizeView>


@code {
    [Parameter]
    public string Id { get; set; }
    private bool PageLoad = false;
    List<FootballGameStatsModel> Model = new List<FootballGameStatsModel>();
    FootballGameStatsModel passingStatSelectedItem = null;
    FootballGameStatsModel rushingStatSelectedItem = null;
    FootballGameStatsModel receivingStatSelectedItem = null;
    FootballGameStatsModel defensiveStatSelectedItem = null;
    FootballGameStatsModel kickingStatSelectedItem = null;
    FootballGameStatsModel passingStatBeforeEdit;
    FootballGameStatsModel rushingStatBeforeEdit;
    FootballGameStatsModel receivingStatBeforeEdit;
    FootballGameStatsModel defensiveStatBeforeEdit;
    FootballGameStatsModel kickingStatBeforeEdit;
    private TableEditButtonPosition editButtonPosition = TableEditButtonPosition.End;
    private TableEditTrigger editTrigger = TableEditTrigger.RowClick;
    GetGameByIdResponse GameModel { get; set; }
    GetLeagueByIdResponse LeagueByIdResponse { get; set; }
    GetTeamByIdResponse AwayTeamByIdResponse { get; set; }
    GetTeamByIdResponse HomeTeamByIdResponse { get; set; }
    private IJSObjectReference? _module;
    GetPlayersByTeamResponse AwayPlayersModel { get; set; }
    GetPlayersByTeamResponse HomePlayersModel { get; set; }
    GetFootballStatsByTeamResponse AwayPlayerStatsModel { get; set; }
    GetFootballStatsByTeamResponse HomePlayerStatsModel { get; set; }
    GetFootballStatsByPlayerResponse PlayerStatsModel { get; set; }

    private PassingTotalAccumalator AwayPassing = new();
    private RushingTotalAccumalator AwayRushing = new();
    private ReceivingTotalAccumalator AwayReceiving = new();
    private DefensiveTotalAccumalator AwayDefense = new();
    private KickingTotalAccumalator AwayKicking = new();

    private PassingTotalAccumalator HomePassing = new();
    private RushingTotalAccumalator HomeRushing = new();
    private ReceivingTotalAccumalator HomeReceiving = new();
    private DefensiveTotalAccumalator HomeDefense = new();
    private KickingTotalAccumalator HomeKicking = new();

    private FootballPassingTotalsModel AwayPassingTotals => new()
    {
        PassingCompletions = AwayPassing.PassingCompletions,
        PassingAttempts = AwayPassing.PassingAttempts,
        PassingYards = AwayPassing.PassingYards,
        PassingInterceptions = AwayPassing.PassingInterceptions,
        PassingTouchdowns = AwayPassing.PassingTouchdowns
    };

    private FootballPassingTotalsModel HomePassingTotals => new()
    {
        PassingCompletions = HomePassing.PassingCompletions,
        PassingAttempts = HomePassing.PassingAttempts,
        PassingYards = HomePassing.PassingYards,
        PassingInterceptions = HomePassing.PassingInterceptions,
        PassingTouchdowns = HomePassing.PassingTouchdowns
    };

    private FootballRushingTotalsModel AwayRushingTotals => new()
    {
        RushingAttempts = AwayRushing.RushingAttempts,
        RushingYards = AwayRushing.RushingYards,
        RushingTouchdowns = AwayRushing.RushingTouchdowns,
        RushingFumbles = AwayRushing.RushingFumbles,
        RushingFumblesLost = AwayRushing.RushingFumblesLost
    };

    private FootballRushingTotalsModel HomeRushingTotals => new()
    {
        RushingAttempts = HomeRushing.RushingAttempts,
        RushingYards = HomeRushing.RushingYards,
        RushingTouchdowns = HomeRushing.RushingTouchdowns,
        RushingFumbles = HomeRushing.RushingFumbles,
        RushingFumblesLost = HomeRushing.RushingFumblesLost
    };

    private FootballReceivingTotalsModel AwayReceivingTotals => new()
    {
        Receptions = AwayReceiving.Receptions,
        Targets = AwayReceiving.Targets,
        ReceivingYards = AwayReceiving.ReceivingYards,
        ReceivingTouchdowns = AwayReceiving.ReceivingTouchdowns,
        ReceivingFumbles = AwayReceiving.ReceivingFumbles,
        ReceivingFumblesLost = AwayReceiving.ReceivingFumblesLost,
        YardsAfterCatch = AwayReceiving.YardsAfterCatch
    };

    private FootballReceivingTotalsModel HomeReceivingTotals => new()
    {
        Receptions = HomeReceiving.Receptions,
        Targets = HomeReceiving.Targets,
        ReceivingYards = HomeReceiving.ReceivingYards,
        ReceivingTouchdowns = HomeReceiving.ReceivingTouchdowns,
        ReceivingFumbles = HomeReceiving.ReceivingFumbles,
        ReceivingFumblesLost = HomeReceiving.ReceivingFumblesLost,
        YardsAfterCatch = HomeReceiving.YardsAfterCatch
    };

    private FootballDefensiveTotalsModel AwayDefensiveTotals => new()
    {
        Tackles = AwayDefense.Tackles,
        DefensiveSacks = AwayDefense.DefensiveSacks,
        TacklesForLoss = AwayDefense.TacklesForLoss,
        PassesDefended = AwayDefense.PassesDefended,
        DefensiveInterceptions = AwayDefense.DefensiveInterceptions,
        DefensiveInterceptionYards = AwayDefense.DefensiveInterceptionYards,
        DefensiveTouchdowns = AwayDefense.DefensiveTouchdowns,
        ForcedFumbles = AwayDefense.ForcedFumbles,
        RecoveredFumbles = AwayDefense.RecoveredFumbles
    };

    private FootballDefensiveTotalsModel HomeDefensiveTotals => new()
    {
        Tackles = HomeDefense.Tackles,
        DefensiveSacks = HomeDefense.DefensiveSacks,
        TacklesForLoss = HomeDefense.TacklesForLoss,
        PassesDefended = HomeDefense.PassesDefended,
        DefensiveInterceptions = HomeDefense.DefensiveInterceptions,
        DefensiveInterceptionYards = HomeDefense.DefensiveInterceptionYards,
        DefensiveTouchdowns = HomeDefense.DefensiveTouchdowns,
        ForcedFumbles = HomeDefense.ForcedFumbles,
        RecoveredFumbles = HomeDefense.RecoveredFumbles
    };

    private FootballKickingTotalsModel AwayKickingTotals => new()
    {
        FieldGoalsMade = AwayKicking.FieldGoalsMade,
        FieldGoalsAttempted = AwayKicking.FieldGoalsAttempted,
        ExtraPointsMade = AwayKicking.ExtraPointsMade,
        ExtraPointsAttempted = AwayKicking.ExtraPointsAttempted,
        Points = AwayKicking.Points,
        Punts = AwayKicking.Punts,
        PuntingYards = AwayKicking.PuntingYards
    };

    private FootballKickingTotalsModel HomeKickingTotals => new()
    {
        FieldGoalsMade = HomeKicking.FieldGoalsMade,
        FieldGoalsAttempted = HomeKicking.FieldGoalsAttempted,
        ExtraPointsMade = HomeKicking.ExtraPointsMade,
        ExtraPointsAttempted = HomeKicking.ExtraPointsAttempted,
        Points = HomeKicking.Points,
        Punts = HomeKicking.Punts,
        PuntingYards = HomeKicking.PuntingYards
    };

    private IEnumerable<FootballGameStatsModel> AwayStatsModel =>
        Model.Where(x => x.TeamId == GameModel.Game.AwayTeam.Id);

    private IEnumerable<FootballGameStatsModel> HomeStatsModel =>
        Model.Where(x => x.TeamId == GameModel.Game.HomeTeam.Id);


    protected override async Task OnInitializedAsync()
    {
        try
        {
            var gameId = Guid.Parse(Id);
            GameModel = await DataLoader.GetOrLoad(
                () => GameLocalCache.GetGameByIdCache(Id),
                () => GameService.GetGameById(gameId),
                (g) => GameLocalCache.SetGameByIdCache(Id, g)
            );

            AwayPlayersModel = await DataLoader.GetOrLoad(
                () => PlayerLocalCache.GetPlayersByTeamCache(GameModel.Game.AwayTeam.Id.ToString()),
                () => PlayerService.GetPlayersByTeam(GameModel.Game.AwayTeam.Id),
                (p) => PlayerLocalCache.SetPlayersByTeamCache(GameModel.Game.AwayTeam.Id.ToString(), p)
            );

            HomePlayersModel = await DataLoader.GetOrLoad(
                () => PlayerLocalCache.GetPlayersByTeamCache(GameModel.Game.HomeTeam.Id.ToString()),
                () => PlayerService.GetPlayersByTeam(GameModel.Game.HomeTeam.Id),
                (p) => PlayerLocalCache.SetPlayersByTeamCache(GameModel.Game.HomeTeam.Id.ToString(), p)
            );

            AwayPlayerStatsModel = await DataLoader.GetOrLoad(
                () => StatsLocalCache.GetFootballStatsByTeamCache(GameModel.Game.AwayTeam.Id.ToString()),
                () => StatsService.GetFootballStatsByTeam(GameModel.Game.AwayTeam.Id),
                (p) => StatsLocalCache.SetFootballStatsByTeamCache(GameModel.Game.AwayTeam.Id.ToString(), p)
            );

            HomePlayerStatsModel = await DataLoader.GetOrLoad(
                () => StatsLocalCache.GetFootballStatsByTeamCache(GameModel.Game.HomeTeam.Id.ToString()),
                () => StatsService.GetFootballStatsByTeam(GameModel.Game.HomeTeam.Id),
                (p) => StatsLocalCache.SetFootballStatsByTeamCache(GameModel.Game.HomeTeam.Id.ToString(), p)
            );

            await GetImageAsync();

            ProcessTeamStats(AwayPlayersModel.Players, AwayPlayerStatsModel, true);
            ProcessTeamStats(HomePlayersModel.Players, HomePlayerStatsModel, false);

            PageLoad = true;

        }
        catch (Exception ex)
        {
            await HandleError(ex);
        }
    }

    private void ProcessTeamStats(
        IEnumerable<PlayerModel> players,
        GetFootballStatsByTeamResponse stats,
        bool isAway
    )
    {
        foreach (var player in players)
        {
            var playerStat = stats.FootballStats.FirstOrDefault(x => x.PlayerId == player.Id && x.GameId == GameModel.Game.Id);

            if (playerStat is not null)
            {
                AddPlayerStats(player, playerStat);
                AccumulateTotals(playerStat, isAway);
            }
            else if (GameModel.Game.GameStatus == GameStatus.Completed)
            {
                Model.Add(new FootballGameStatsModel(GameModel.Game.LeagueId, player.TeamId, player.Id, GameModel.Game.SeasonId, GameModel.Game.Id, player.FirstName, player.LastName));
            }
        }
    }

    private void AddPlayerStats(
        PlayerModel player,
        Models.Stats.Football.FootballStatsModel playerStat
       )
    {
        Model.Add(new FootballGameStatsModel(GameModel.Game.LeagueId, player.TeamId, player.Id, GameModel.Game.SeasonId, GameModel.Game.Id, player.FirstName, player.LastName,
                                                        playerStat.OffensiveStats.PassingCompletions, playerStat.OffensiveStats.PassingAttempts, playerStat.OffensiveStats.PassingYards,
                                                        playerStat.OffensiveStats.LongestPassingPlay, playerStat.OffensiveStats.PassingTouchdowns, playerStat.OffensiveStats.PassingInterceptions,
                                                        playerStat.OffensiveStats.Sacks, playerStat.OffensiveStats.RushingAttempts, playerStat.OffensiveStats.RushingYards,
                                                        playerStat.OffensiveStats.LongestRushingPlay, playerStat.OffensiveStats.RushingTouchdowns, playerStat.OffensiveStats.RushingFumbles, playerStat.OffensiveStats.RushingFumblesLost,
                                                        playerStat.OffensiveStats.Receptions, playerStat.OffensiveStats.Targets, playerStat.OffensiveStats.ReceivingYards, playerStat.OffensiveStats.ReceivingTouchdowns,
                                                        playerStat.OffensiveStats.ReceivingFumbles, playerStat.OffensiveStats.ReceivingFumblesLost, playerStat.OffensiveStats.YardsAfterCatch,
                                                        playerStat.DefensiveStats.Tackles, playerStat.DefensiveStats.Sacks, playerStat.DefensiveStats.TacklesForLoss, playerStat.DefensiveStats.PassesDefended,
                                                        playerStat.DefensiveStats.DefensiveInterceptions, playerStat.DefensiveStats.DefensiveInterceptionYards, playerStat.DefensiveStats.LongestDefensiveInterceptionPlay,
                                                        playerStat.DefensiveStats.DefensiveTouchdowns, playerStat.DefensiveStats.ForcedFumbles, playerStat.DefensiveStats.RecoveredFumbles,
                                                        playerStat.KickingStats.FieldGoalsMade, playerStat.KickingStats.FieldGoalsAttempted, playerStat.KickingStats.ExtraPointsMade, playerStat.KickingStats.ExtraPointsAttempted,
                                                        playerStat.KickingStats.LongestKick, playerStat.KickingStats.Points,
                                                        playerStat.KickingStats.Punts, playerStat.KickingStats.PuntingYards, playerStat.KickingStats.LongestPunt));
    }

    private void AccumulateTotals(Models.Stats.Football.FootballStatsModel playerStat, bool isAway)
    {
        if (isAway)
        {
            AwayPassing.PassingCompletions += playerStat.OffensiveStats.PassingCompletions;
            AwayPassing.PassingAttempts += playerStat.OffensiveStats.PassingAttempts;
            AwayPassing.PassingYards += playerStat.OffensiveStats.PassingYards;
            AwayPassing.PassingTouchdowns += playerStat.OffensiveStats.PassingTouchdowns;
            AwayPassing.PassingInterceptions += playerStat.OffensiveStats.PassingInterceptions;
            AwayPassing.Sacks += playerStat.OffensiveStats.Sacks;

            AwayRushing.RushingAttempts += playerStat.OffensiveStats.RushingAttempts;
            AwayRushing.RushingYards += playerStat.OffensiveStats.RushingYards;
            AwayRushing.RushingTouchdowns += playerStat.OffensiveStats.RushingTouchdowns;
            AwayRushing.RushingFumbles += playerStat.OffensiveStats.RushingFumbles;
            AwayRushing.RushingFumblesLost += playerStat.OffensiveStats.RushingFumblesLost;

            AwayReceiving.Receptions += playerStat.OffensiveStats.Receptions;
            AwayReceiving.Targets += playerStat.OffensiveStats.Targets;
            AwayReceiving.ReceivingYards += playerStat.OffensiveStats.ReceivingYards;
            AwayReceiving.ReceivingTouchdowns += playerStat.OffensiveStats.ReceivingTouchdowns;
            AwayReceiving.ReceivingFumbles += playerStat.OffensiveStats.ReceivingFumbles;
            AwayReceiving.ReceivingFumblesLost += playerStat.OffensiveStats.ReceivingFumblesLost;
            AwayReceiving.YardsAfterCatch += playerStat.OffensiveStats.YardsAfterCatch;

            AwayDefense.Tackles += playerStat.DefensiveStats.Tackles;
            AwayDefense.DefensiveSacks += playerStat.DefensiveStats.Sacks;
            AwayDefense.TacklesForLoss += playerStat.DefensiveStats.TacklesForLoss;
            AwayDefense.PassesDefended += playerStat.DefensiveStats.PassesDefended;
            AwayDefense.DefensiveInterceptions += playerStat.DefensiveStats.DefensiveInterceptions;
            AwayDefense.DefensiveInterceptionYards += playerStat.DefensiveStats.DefensiveInterceptionYards;
            AwayDefense.DefensiveTouchdowns += playerStat.DefensiveStats.DefensiveTouchdowns;
            AwayDefense.ForcedFumbles += playerStat.DefensiveStats.ForcedFumbles;
            AwayDefense.RecoveredFumbles += playerStat.DefensiveStats.RecoveredFumbles;

            AwayKicking.FieldGoalsMade += playerStat.KickingStats.FieldGoalsMade;
            AwayKicking.FieldGoalsAttempted += playerStat.KickingStats.FieldGoalsAttempted;
            AwayKicking.ExtraPointsMade += playerStat.KickingStats.ExtraPointsMade;
            AwayKicking.ExtraPointsAttempted += playerStat.KickingStats.ExtraPointsAttempted;
            AwayKicking.Points += playerStat.KickingStats.Points;
            AwayKicking.Punts += playerStat.KickingStats.Punts;
            AwayKicking.PuntingYards += playerStat.KickingStats.PuntingYards;
        }
        else
        {
            HomePassing.PassingCompletions += playerStat.OffensiveStats.PassingCompletions;
            HomePassing.PassingAttempts += playerStat.OffensiveStats.PassingAttempts;
            HomePassing.PassingYards += playerStat.OffensiveStats.PassingYards;
            HomePassing.PassingTouchdowns += playerStat.OffensiveStats.PassingTouchdowns;
            HomePassing.PassingInterceptions += playerStat.OffensiveStats.PassingInterceptions;
            HomePassing.Sacks += playerStat.OffensiveStats.Sacks;

            HomeRushing.RushingAttempts += playerStat.OffensiveStats.RushingAttempts;
            HomeRushing.RushingYards += playerStat.OffensiveStats.RushingYards;
            HomeRushing.RushingTouchdowns += playerStat.OffensiveStats.RushingTouchdowns;
            HomeRushing.RushingFumbles += playerStat.OffensiveStats.RushingFumbles;
            HomeRushing.RushingFumblesLost += playerStat.OffensiveStats.RushingFumblesLost;

            HomeReceiving.Receptions += playerStat.OffensiveStats.Receptions;
            HomeReceiving.Targets += playerStat.OffensiveStats.Targets;
            HomeReceiving.ReceivingYards += playerStat.OffensiveStats.ReceivingYards;
            HomeReceiving.ReceivingTouchdowns += playerStat.OffensiveStats.ReceivingTouchdowns;
            HomeReceiving.ReceivingFumbles += playerStat.OffensiveStats.ReceivingFumbles;
            HomeReceiving.ReceivingFumblesLost += playerStat.OffensiveStats.ReceivingFumblesLost;
            HomeReceiving.YardsAfterCatch += playerStat.OffensiveStats.YardsAfterCatch;

            HomeDefense.Tackles += playerStat.DefensiveStats.Tackles;
            HomeDefense.DefensiveSacks += playerStat.DefensiveStats.Sacks;
            HomeDefense.TacklesForLoss += playerStat.DefensiveStats.TacklesForLoss;
            HomeDefense.PassesDefended += playerStat.DefensiveStats.PassesDefended;
            HomeDefense.DefensiveInterceptions += playerStat.DefensiveStats.DefensiveInterceptions;
            HomeDefense.DefensiveInterceptionYards += playerStat.DefensiveStats.DefensiveInterceptionYards;
            HomeDefense.DefensiveTouchdowns += playerStat.DefensiveStats.DefensiveTouchdowns;
            HomeDefense.ForcedFumbles += playerStat.DefensiveStats.ForcedFumbles;
            HomeDefense.RecoveredFumbles += playerStat.DefensiveStats.RecoveredFumbles;

            HomeKicking.FieldGoalsMade += playerStat.KickingStats.FieldGoalsMade;
            HomeKicking.FieldGoalsAttempted += playerStat.KickingStats.FieldGoalsAttempted;
            HomeKicking.ExtraPointsMade += playerStat.KickingStats.ExtraPointsMade;
            HomeKicking.ExtraPointsAttempted += playerStat.KickingStats.ExtraPointsAttempted;
            HomeKicking.Points += playerStat.KickingStats.Points;
            HomeKicking.Punts += playerStat.KickingStats.Punts;
            HomeKicking.PuntingYards += playerStat.KickingStats.PuntingYards;

        }
    }

    private void BackupPassingItem(object stats)
    {
        passingStatBeforeEdit = DataLoader.Clone((FootballGameStatsModel)stats);
    }

    private void BackupRushingItem(object stats)
    {
        rushingStatBeforeEdit = DataLoader.Clone((FootballGameStatsModel)stats);
    }

    private void BackupReceivingItem(object stats)
    {
        receivingStatBeforeEdit = DataLoader.Clone((FootballGameStatsModel)stats);
    }

    private void BackupDefensiveItem(object stats)
    {
        defensiveStatBeforeEdit = DataLoader.Clone((FootballGameStatsModel)stats);
    }

    private void BackupKickingItem(object stats)
    {
        kickingStatBeforeEdit = DataLoader.Clone((FootballGameStatsModel)stats);
    }

    private void ResetPassingItemToOriginalValues(object stats)
    {
        DataLoader.Reset((FootballGameStatsModel)stats, passingStatBeforeEdit);
    }

    private void ResetRushingItemToOriginalValues(object stats)
    {
        DataLoader.Reset((FootballGameStatsModel)stats, rushingStatBeforeEdit);
    }

    private void ResetReceivingItemToOriginalValues(object stats)
    {
        DataLoader.Reset((FootballGameStatsModel)stats, receivingStatBeforeEdit);
    }

    private void ResetDefensiveItemToOriginalValues(object stats)
    {
        DataLoader.Reset((FootballGameStatsModel)stats, defensiveStatBeforeEdit);
    }

    private void ResetKickingItemToOriginalValues(object stats)
    {
        DataLoader.Reset((FootballGameStatsModel)stats, kickingStatBeforeEdit);
    }

    private async Task SubmitPassingStats()
    {
        try
        {
            await StatsSubmissionService.FootballPassingSubmitAsync(passingStatSelectedItem,
            Model, GameModel.Game, ApplyPassingStatsTotalsDelta);
            Snackbar.Add("Players Passing Stats have been saved.", MudBlazor.Severity.Success);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await HandleError(ex);
        }
    }

    private async Task SubmitRushingStats()
    {
        try
        {
            await StatsSubmissionService.FootballRushingSubmitAsync(rushingStatSelectedItem,
            Model, GameModel.Game, ApplyRushingStatsTotalsDelta);
            Snackbar.Add("Players Rushing Stats have been saved.", MudBlazor.Severity.Success);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await HandleError(ex);
        }
    }

    private async Task SubmitReceivingStats()
    {
        try
        {
            await StatsSubmissionService.FootballReceivingSubmitAsync(receivingStatBeforeEdit,
            Model, GameModel.Game, ApplyReceivingStatsTotalsDelta);
            Snackbar.Add("Players Receiving Stats have been saved.", MudBlazor.Severity.Success);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await HandleError(ex);
        }
    }

    private async Task SubmitDefensiveStats()
    {
        try
        {
            await StatsSubmissionService.FootballDefensiveSubmitAsync(defensiveStatBeforeEdit,
            Model, GameModel.Game, ApplyDefensiveStatsTotalsDelta);
            Snackbar.Add("Players Defensive Stats have been saved.", MudBlazor.Severity.Success);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await HandleError(ex);
        }
    }

    private async Task SubmitKickingStats()
    {
        try
        {
            await StatsSubmissionService.FootballKickingSubmitAsync(kickingStatBeforeEdit,
            Model, GameModel.Game, ApplyKickingStatsTotalsDelta);
            Snackbar.Add("Players Kicking Stats have been saved.", MudBlazor.Severity.Success);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await HandleError(ex);
        }
    }

    private void ApplyPassingStatsTotalsDelta(FootballGameStatsModel updated, FootballStatsModel original)
    {
        var totals = updated.TeamId == GameModel.Game.AwayTeam.Id ? AwayPassing : HomePassing;

        totals.ApplyDeltas(updated, original);

    }

    private void ApplyRushingStatsTotalsDelta(FootballGameStatsModel updated, FootballStatsModel original)
    {
        var totals = updated.TeamId == GameModel.Game.AwayTeam.Id ? AwayRushing : HomeRushing;

        totals.ApplyDeltas(updated, original);

    }

    private void ApplyReceivingStatsTotalsDelta(FootballGameStatsModel updated, FootballStatsModel original)
    {
        var totals = updated.TeamId == GameModel.Game.AwayTeam.Id ? AwayReceiving : HomeReceiving;

        totals.ApplyDeltas(updated, original);

    }

    private void ApplyDefensiveStatsTotalsDelta(FootballGameStatsModel updated, FootballStatsModel original)
    {
        var totals = updated.TeamId == GameModel.Game.AwayTeam.Id ? AwayDefense : HomeDefense;

        totals.ApplyDeltas(updated, original);

    }

    private void ApplyKickingStatsTotalsDelta(FootballGameStatsModel updated, FootballStatsModel original)
    {
        var totals = updated.TeamId == GameModel.Game.AwayTeam.Id ? AwayKicking : HomeKicking;

        totals.ApplyDeltas(updated, original);

    }

    private async Task GetImageAsync()
    {
        GetLeagueByIdResponse leagueByIdResponse;
        GetTeamByIdResponse awayTeamResponse;
        GetTeamByIdResponse homeTeamResponse;
        leagueByIdResponse = await LeagueLocalCache.GetLeagueByIdCache(GameModel.Game.LeagueId.ToString());
        if(leagueByIdResponse == null)
        {
            leagueByIdResponse = await LeagueService.GetLeague(GameModel.Game.LeagueId);
            await LeagueLocalCache.SetLeagueByIdCache(GameModel.Game.LeagueId.ToString(), leagueByIdResponse);
        }
        awayTeamResponse = await TeamLocalCache.GetTeamByIdCache(GameModel.Game.AwayTeam.Id.ToString());
        if(awayTeamResponse == null)
        {
            awayTeamResponse = await TeamService.GetTeamById(GameModel.Game.AwayTeam.Id);
            await TeamLocalCache.SetTeamByIdCache(GameModel.Game.AwayTeam.Id.ToString(), awayTeamResponse);
        }
        homeTeamResponse = await TeamLocalCache.GetTeamByIdCache(GameModel.Game.HomeTeam.Id.ToString());
        if (homeTeamResponse == null)
        {
            homeTeamResponse = await TeamService.GetTeamById(GameModel.Game.HomeTeam.Id);
            await TeamLocalCache.SetTeamByIdCache(GameModel.Game.HomeTeam.Id.ToString(), homeTeamResponse);
        }
        GameModel.Game.AwayTeamImage = await ImageService.GetTeamImageAsync(LeagueByIdResponse.League, AwayTeamByIdResponse.Team);
        GameModel.Game.HomeTeamImage = await ImageService.GetTeamImageAsync(LeagueByIdResponse.League, HomeTeamByIdResponse.Team);
    }

    private async Task HandleError(Exception ex)
    {
        if (KeycloakTokenService.ShouldForceLogout())
        {
            _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/authRefresh.js");
            await _module.InvokeVoidAsync("logout");
        }
        ErrorState.Message = ex.Message;
        NavManager.NavigateTo("/error");
    }
}
