@page "/createbaseballgamelineup/{id}"
@inject IGameService GameService
@inject ITeamService TeamService
@inject IPlayerService PlayerService
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager NavManager
@inject ErrorState ErrorState
@inject ISnackbar Snackbar
@inject IJSRuntime JsRuntime
@inject KeycloakTokenService KeycloakTokenService
@inject IGameLocalCacheService GameLocalCache
@inject ITeamLocalCacheService TeamLocalCache
@inject IPlayerLocalCacheService PlayerLocalCache

<AuthorizeView Roles="@String.Concat(Roles.CreateGames)" Context="auth">
    <Authorized>
        @if (PageLoad)
        {
            <MudItem Style="padding-top: 50px;">
                <MudPaper Class="border border-solid" Style="border-color: #000000; padding: 25px;">
                    <MudText Typo="Typo.h5" Align="Align.Center" Style="font-weight:bold">@Away.Team.TeamName vs @Home.Team.TeamName Lineups</MudText>
                </MudPaper>
                <MudItem Style="padding-top: 25px;">
                    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Centered="true" Color="Color.Primary" Class="border border-solid" Style="border-color: #000000; padding: 25px;">
                        <MudTabPanel Text="@Away.Team.TeamName">
                            <BaseballLineupEditor TeamName="@Away.Team.TeamName"
                                                  Lineup="Away.Lineup"
                                                  OnItemDropped="AwayLineupItemUpdated"
                                                  Pitchers="Away.Pitchers"
                                                  SelectedPitcher="Away.SelectedPitcher"
                                                  SelectedPitcherChanged="@((Guid v) => Away.SelectedPitcher = v)"
                                                  OnSave="SaveAwayLineup"
                                                  IsLocked="Away.IsLocked" />
                        </MudTabPanel>
                        <MudTabPanel Text="@Home.Team.TeamName">
                            <BaseballLineupEditor TeamName="@Home.Team.TeamName"
                                                  Lineup="Home.Lineup"
                                                  OnItemDropped="HomeLineupItemUpdated"
                                                  Pitchers="Home.Pitchers"
                                                  SelectedPitcher="Home.SelectedPitcher"
                                                  SelectedPitcherChanged="@((Guid v) => Home.SelectedPitcher = v)"
                                                  OnSave="SaveHomeLineup"
                                                  IsLocked="Home.IsLocked" />
                        </MudTabPanel>
                    </MudTabs>
                </MudItem>
            </MudItem>
        }
        else
        {
            <Loading />
        }
    </Authorized>
    <NotAuthorized>
        <NoAccess />
    </NotAuthorized>
</AuthorizeView>
@code {

    [Parameter]
    public string Id { get; set; }
    private bool PageLoad = false;
    private GetGameByIdResponse GameByIdResponse { get; set; }
    private LineupContext Away = new();
    private LineupContext Home = new();
    private int positionSelector = 1;
    private int benchSelector = 9; //number of players allowed in the lineup this will increment starting at 10
    private string lineupDropzone = "1";
    private string benchDropzone = "2";
    private Dictionary<string, string> BaseballPositions = new();
    private IJSObjectReference? _module;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var gameId = Guid.Parse(Id);
            BaseballPositions = Constants.BaseballPositions();

            GameByIdResponse = await DataLoader.GetOrLoad(
                () => GameLocalCache.GetGameByIdCache(Id),
                () => GameService.GetGameById(gameId),
                (g) => GameLocalCache.SetGameByIdCache(Id, g)
            );
            await SetupTeam(Away, gameId, GameByIdResponse.Game.AwayTeam.Id);  //Away Team Lineup Creation
            await SetupTeam(Home, gameId, GameByIdResponse.Game.HomeTeam.Id);  //Home Team Lineup Creation

            positionSelector = 1;
            PageLoad = true;
        }
        catch (Exception ex)
        {
            await HandleError(ex);
        }
    }

    private async Task SetupTeam(LineupContext ctx, Guid gameId, Guid teamId)
    {
        var teamResponse = await DataLoader.GetOrLoad(
            () => TeamLocalCache.GetTeamByIdCache(teamId.ToString()),
            () => TeamService.GetTeamById(teamId),
            (t) => TeamLocalCache.SetTeamByIdCache(teamId.ToString(), t)
        );

        ctx.Team = teamResponse.Team;

        ctx.ExistingCheck = await DataLoader.GetOrLoad(
            () => GameLocalCache.AnyBaseballGameLineupByGameIdCache(gameId.ToString(), teamId.ToString()),
            () => GameService.AnyBaseballGameLineupByGameId(gameId, teamId),
            (g) => GameLocalCache.SetAnyBaseballGameLineupByGameIdCache(gameId.ToString(), teamId.ToString(), g)
        ); 

        ctx.Players = await DataLoader.GetOrLoad(
            () => PlayerLocalCache.GetPlayersByTeamCache(teamId.ToString()),
            () => PlayerService.GetPlayersByTeam(teamId),
            (p) => PlayerLocalCache.SetPlayersByTeamCache(teamId.ToString(), p)
        );
        ctx.Pitchers = ctx.Players.Players.Where(x => x.PlayerDetail.Position == PositionFilter.BASEBALL).ToList();

        if (ctx.ExistingCheck.IsLineupCreated)
        {
            ctx.ExistingLineup = await DataLoader.GetOrLoad(
                () => GameLocalCache.GetBaseballGameLineupByGameIdCache(gameId.ToString(), teamId.ToString()),
                () => GameService.GetBaseballGameLineupByGameId(gameId, teamId),
                (g) => GameLocalCache.SetBaseballGameLineupByGameIdCache(gameId.ToString(), teamId.ToString(), g)
            );
        }

        int pos = 1;
        int bench = 9;

        foreach(var player in ctx.Players.Players.Where(x => x.PlayerDetail.Position != PositionFilter.BASEBALL))
        {
            var item = new DropItem
            {
                PlayerId = player.Id,
                TeamId = teamId,
                PlayerName = $"{player.FirstName} {player.LastName}",
                Position = BaseballPositions[player.PlayerDetail.Position],
                Selector = pos <= 9 ? lineupDropzone : benchDropzone,
                IsLocked = ctx.ExistingCheck.IsLineupCreated
            };

            item.BattingOrderPosition = ctx.ExistingCheck.IsLineupCreated
                ? SetupLineup(ctx.ExistingLineup.GameLineup.BaseballLineup, item)
                : pos;

            ctx.Lineup.Add(item);
            pos++;
        }

        ctx.Lineup = ctx.Lineup.OrderBy(x => x.BattingOrderPosition).ToList();
        ctx.IsLocked = ctx.ExistingCheck.IsLineupCreated;
    }

    private void AwayLineupItemUpdated(MudItemDropInfo<DropItem> drop) =>
        HandleLineupDrop(drop, Away);

    private void HomeLineupItemUpdated(MudItemDropInfo<DropItem> drop) =>
        HandleLineupDrop(drop, Home);


    private void HandleLineupDrop(MudItemDropInfo<DropItem> drop, LineupContext ctx)
    {
        if (drop.Item.Selector == drop.DropzoneIdentifier)
        {
            if (drop.DropzoneIdentifier == lineupDropzone)
                UpdateLineup(drop, ctx.Lineup);
            return;
        }

        if(drop.DropzoneIdentifier == benchDropzone)
            drop.Item.Selector = benchDropzone;

        if(drop.DropzoneIdentifier == lineupDropzone &&
           ctx.Lineup.Count(x => x.Selector == lineupDropzone) == 9)
        {
            Snackbar.Add($"{ctx.Team.TeamName} lineup is full.", MudBlazor.Severity.Error);
            return;
        }

        drop.Item.Selector = drop.DropzoneIdentifier;
        UpdateLineup(drop, ctx.Lineup);
    }

    private void UpdateLineup(MudItemDropInfo<DropItem> dropItem, List<DropItem> lineup)
    {
        var indexOffset = dropItem.DropzoneIdentifier switch
        {
            "2" => 10,
            _ => 1
        };
        lineup.UpdateOrder(dropItem, item => item.BattingOrderPosition, indexOffset);
    }

    private Task SaveAwayLineup() => SaveLineup(Away, Away.Team.Id);
    private Task SaveHomeLineup() => SaveLineup(Home, Home.Team.Id);

    private async Task SaveLineup(LineupContext ctx, Guid teamId)
    {
        try
        {
            if(ctx.SelectedPitcher == Guid.Empty)
            {
                Snackbar.Add("Please select a Starting Pitcher.", MudBlazor.Severity.Error);
                return;
            }

            if(ctx.Lineup.Count(x => x.Selector == lineupDropzone) < 9)
            {
                Snackbar.Add("Please have 9 hitters in the Lineup", MudBlazor.Severity.Error);
                return;
            }

            var players = ctx.Lineup.OrderBy(x => x.BattingOrderPosition).ToList();
            var pitcher = ctx.Pitchers.First(x => x.Id == ctx.SelectedPitcher);

            var lineupDetails = new BaseballGameLineup(
                players[0].PlayerId, players[1].PlayerId, players[2].PlayerId, 
                players[3].PlayerId, players[4].PlayerId, players[5].PlayerId,
                players[6].PlayerId, players[7].PlayerId, players[8].PlayerId,
                pitcher.Id);

            var request = new CreateBaseballGameLineupRequest(
                new CreateBaseballGameLineupRecord(Guid.Parse(Id), teamId, lineupDetails)
            );

            await GameService.CreateBaseballGameLineup(request);

            foreach(var p in players)
                p.IsLocked = true;

            ctx.IsLocked = true;
            Snackbar.Add($"{ctx.Team.TeamName} Lineup has been created.", MudBlazor.Severity.Success);
            StateHasChanged();

        }
        catch (Exception ex)
        {
            await HandleError(ex);
        }
    }

    private int SetupLineup(BaseballGameLineup lineup, DropItem item)
    {
        switch(item.PlayerId)
        {
            case var first when first == lineup.First:
                return 1;
            case var second when second == lineup.Second:
                return 2;
            case var third when third == lineup.Third:
                return 3;
            case var fourth when fourth == lineup.Fourth:
                return 4;
            case var fifth when fifth == lineup.Fifth:
                return 5;
            case var sixth when sixth == lineup.Sixth:
                return 6;
            case var seventh when seventh == lineup.Seventh:
                return 7;
            case var eighth when eighth == lineup.Eighth:
                return 8;
            case var ninth when ninth == lineup.Ninth:
                return 9;
            default:
                return benchSelector++;
        }
    }

    private async Task HandleError(Exception ex)
    {
        if (KeycloakTokenService.ShouldForceLogout())
        {
            _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/authRefresh.js");
            await _module.InvokeVoidAsync("logout");
        }
        ErrorState.Message = ex.Message;
        NavManager.NavigateTo("/error");
    }

    public class DropItem
    {
        public Guid PlayerId { get; set; }
        public Guid TeamId { get; set; }
        public string PlayerName { get; set; }
        public string Position { get; set; }
        public int BattingOrderPosition { get; set; }
        public string Selector { get; set; }
        public bool IsLocked { get; set; } = false;
    }

    public class LineupContext
    {
        public TeamModel Team { get; set; }
        public GetPlayersByTeamResponse Players { get; set; }
        public List<PlayerModel> Pitchers { get; set; } = new();
        public List<DropItem> Lineup { get; set; } = new();
        public bool IsLocked { get; set; }
        public Guid SelectedPitcher {get; set;}
        public GetBaseballGameLineupByGameIdResponse ExistingLineup { get; set; }
        public AnyBaseballGameLineupByGameIdResponse ExistingCheck {get; set;}
    }
}
