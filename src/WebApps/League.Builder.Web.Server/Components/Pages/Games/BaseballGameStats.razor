@page "/baseballgamestats/{id}"
@using League.Builder.Web.Server.Services.Cache
@inject IStatsService StatsService
@inject IGameService GameService
@inject ILeagueService LeagueService
@inject ITeamService TeamService
@inject IPlayerService PlayerService
@inject IAWSService AWSService
@inject ISnackbar Snackbar
@inject NavigationManager NavManager
@inject ErrorState ErrorState
@inject KeycloakTokenService KeycloakTokenService
@inject ImageService ImageService
@inject IJSRuntime JsRuntime
@inject IHttpContextAccessor HttpContextAccessor
@inject IGameLocalCacheService GameLocalCache
@inject IPlayerLocalCacheService PlayerLocalCache
@inject IStatsLocalCacheService StatsLocalCache
@inject ILeagueLocalCacheService LeagueLocalCache
@inject ITeamLocalCacheService TeamLocalCache

<AuthorizeView Roles="@String.Concat(Roles.ReadStats, ", ", Roles.ReadGames, ", ", Roles.ReadPlayers)" Context="auth">
    <Authorized>
        @if (PageLoad)
        {
            <TeamHeader Game="GameModel.Game" />
            <MudItem Style="padding-top: 25px;">
                <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Centered="true" Color="Color.Primary" Class="border border-solid" Style="border-color: #000000; padding: 25px;">
                    <MudTabPanel Text="@($"{GameModel.Game.AwayTeam.TeamName} Stats")">
                        <BaseballHittingTable Stats="Model.Where(x => x.TeamId == GameModel.Game.AwayTeam.Id)" />
                        <BaseballHittingTotals Totals="AwayHittingTotals" />
                        <BaseballPitchingTable Stats="Model.Where(x => x.TeamId == GameModel.Game.AwayTeam.Id && x.Position == PositionFilter.BASEBALL)" />
                        <BaseballPitchingTotals Totals="AwayPitchingTotals" />
                    </MudTabPanel>
                    <MudTabPanel Text="@String.Concat(GameModel.Game.HomeTeam.TeamName + " Stats")">
                        <BaseballHittingTable Stats="Model.Where(x => x.TeamId == GameModel.Game.HomeTeam.Id)" />
                        <BaseballHittingTotals Totals="HomeHittingTotals" />
                        <BaseballPitchingTable Stats="Model.Where(x => x.TeamId == GameModel.Game.HomeTeam.Id && x.Position == PositionFilter.BASEBALL)" />
                        <BaseballPitchingTotals Totals="HomePitchingTotals" />
                    </MudTabPanel>
                </MudTabs>

            </MudItem>
        }
        else
        {
            <Loading />
        }
    </Authorized>
    <NotAuthorized>
        <MudText>You are not authorized to view this page...</MudText>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter]
    public string Id { get; set; }
    private bool PageLoad = false;
    List<BaseballGameStatsModel> Model = new List<BaseballGameStatsModel>();
    GetGameByIdResponse GameModel { get; set; }
    GetPlayersByTeamResponse AwayPlayersModel { get; set; }
    GetPlayersByTeamResponse HomePlayersModel { get; set; }
    GetBaseballStatsByTeamResponse AwayPlayerStatsModel { get; set; }
    GetBaseballStatsByTeamResponse HomePlayerStatsModel { get; set; }
    GetLeagueByIdResponse LeagueByIdResponse { get; set; }
    GetTeamByIdResponse AwayTeamByIdResponse { get; set; }
    GetTeamByIdResponse HomeTeamByIdResponse { get; set; }
    private IJSObjectReference? _module;

    private HittingTotalAccumalator AwayHit = new();
    private PitchingTotalAccumalator AwayPitch = new();

    private BaseballHittingTotalsModel AwayHittingTotals => new()
    {
        AtBats = AwayHit.AtBats,
        Runs = AwayHit.Runs,
        Hits = AwayHit.Hits,
        RBIs = AwayHit.RBIs,
        Walks = AwayHit.Walks,
        HBPs = AwayHit.HBPs,
        Strikeouts = AwayHit.Strikeouts,
        SBs = AwayHit.SBs,
        TBs = AwayHit.TotalBases,
        Doubles = AwayHit.Doubles,
        Triples = AwayHit.Triples,
        HomeRuns = AwayHit.HomeRuns,
        SFs = AwayHit.SFs
    };

    private BaseballPitchingTotalsModel AwayPitchingTotals => new()
    {
        Wins = AwayPitch.Wins,
        Losses = AwayPitch.Losses,
        Runs = AwayPitch.Runs,
        Saves = AwayPitch.Saves,
        Innings = AwayPitch.Innings,
        HitsAllowed = AwayPitch.HitsAllowed,
        WalksAllowed = AwayPitch.WalksAllowed,
        Strikeouts = AwayPitch.Strikeouts
    };

    private HittingTotalAccumalator HomeHit = new();
    private PitchingTotalAccumalator HomePitch = new();

    private BaseballHittingTotalsModel HomeHittingTotals => new()
    {
        AtBats = HomeHit.AtBats,
        Runs = HomeHit.Runs,
        Hits = HomeHit.Hits,
        RBIs = HomeHit.RBIs,
        Walks = HomeHit.Walks,
        HBPs = HomeHit.HBPs,
        Strikeouts = HomeHit.Strikeouts,
        SBs = HomeHit.SBs,
        TBs = HomeHit.TotalBases,
        Doubles = HomeHit.Doubles,
        Triples = HomeHit.Triples,
        HomeRuns = HomeHit.HomeRuns,
        SFs = HomeHit.SFs
    };

    private BaseballPitchingTotalsModel HomePitchingTotals => new()
    {
        Wins = HomePitch.Wins,
        Losses = HomePitch.Losses,
        Runs = HomePitch.Runs,
        Saves = HomePitch.Saves,
        Innings = HomePitch.Innings,
        HitsAllowed = HomePitch.HitsAllowed,
        WalksAllowed = HomePitch.WalksAllowed,
        Strikeouts = HomePitch.Strikeouts
    };


    protected override async Task OnInitializedAsync()
    {
        try
        {
            var gameId = Guid.Parse(Id);

            GameModel = await DataLoader.GetOrLoad(
                () => GameLocalCache.GetGameByIdCache(Id),
                () => GameService.GetGameById(gameId),
                (g) => GameLocalCache.SetGameByIdCache(Id, g)
            );

            AwayPlayersModel = await DataLoader.GetOrLoad(
                () => PlayerLocalCache.GetPlayersByTeamCache(GameModel.Game.AwayTeam.Id.ToString()),
                () => PlayerService.GetPlayersByTeam(GameModel.Game.AwayTeam.Id),
                (p) => PlayerLocalCache.SetPlayersByTeamCache(GameModel.Game.AwayTeam.Id.ToString(), p)
            );

            HomePlayersModel = await DataLoader.GetOrLoad(
                () => PlayerLocalCache.GetPlayersByTeamCache(GameModel.Game.HomeTeam.Id.ToString()),
                () => PlayerService.GetPlayersByTeam(GameModel.Game.HomeTeam.Id),
                (p) => PlayerLocalCache.SetPlayersByTeamCache(GameModel.Game.HomeTeam.Id.ToString(), p)
            );

            AwayPlayerStatsModel = await DataLoader.GetOrLoad(
                () => StatsLocalCache.GetBaseballStatsByTeamCache(GameModel.Game.AwayTeam.Id.ToString()),
                () => StatsService.GetBaseballStatsByTeam(GameModel.Game.AwayTeam.Id),
                (p) => StatsLocalCache.SetBaseballStatsByTeamCache(GameModel.Game.AwayTeam.Id.ToString(), p)
            );

            AwayPlayerStatsModel = await DataLoader.GetOrLoad(
                () => StatsLocalCache.GetBaseballStatsByTeamCache(GameModel.Game.HomeTeam.Id.ToString()),
                () => StatsService.GetBaseballStatsByTeam(GameModel.Game.HomeTeam.Id),
                (p) => StatsLocalCache.SetBaseballStatsByTeamCache(GameModel.Game.HomeTeam.Id.ToString(), p)
            );

            await GetImageAsync();

            ProcessTeamStats(AwayPlayersModel.Players, AwayPlayerStatsModel, true);
            ProcessTeamStats(HomePlayersModel.Players, HomePlayerStatsModel, false);

            PageLoad = true;
        }
        catch (Exception ex)
        {
            if (KeycloakTokenService.ShouldForceLogout())
            {
                _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/authRefresh.js");
                await _module.InvokeVoidAsync("logout");
            }
            ErrorState.Message = ex.Message;
            NavManager.NavigateTo("/error");
        }
    }

    private void ProcessTeamStats(IEnumerable<PlayerModel> players,
        GetBaseballStatsByTeamResponse stats,
        bool isAway)
    {
        foreach (var player in players)
        {
            var playerStat = stats.BaseballStats.FirstOrDefault(x => x.PlayerId == player.Id && x.GameId == GameModel.Game.Id);
            if (playerStat is not null)
            {
                AddPlayerStats(player, playerStat);
                AccumulateTotals(playerStat, isAway);
            }
            else if (GameModel.Game.GameStatus == GameStatus.Completed)
                Model.Add(new BaseballGameStatsModel(GameModel.Game.LeagueId, player.TeamId, player.Id, GameModel.Game.SeasonId, GameModel.Game.Id, player.FirstName, player.LastName, player.PlayerDetail.Position));
        }
    }

    private void AddPlayerStats(
    PlayerModel player,
    Models.Stats.Baseball.BaseballStatsModel playerStat
   )
    {
        Model.Add(new BaseballGameStatsModel(
            GameModel.Game.LeagueId,
            player.TeamId,
            player.Id,
            GameModel.Game.SeasonId,
            GameModel.Game.Id,
            player.FirstName,
            player.LastName,
            player.PlayerDetail.Position,
            playerStat.HittingStats.AtBats,
            playerStat.HittingStats.Hits,
            playerStat.HittingStats.TotalBases,
            playerStat.HittingStats.Runs,
            playerStat.HittingStats.Doubles,
            playerStat.HittingStats.Triples,
            playerStat.HittingStats.HomeRuns,
            playerStat.HittingStats.RunsBattedIn,
            playerStat.HittingStats.StolenBases,
            playerStat.HittingStats.Strikeouts,
            playerStat.HittingStats.Walks,
            playerStat.HittingStats.HitByPitch,
            playerStat.HittingStats.SacrificeFly,
            playerStat.PitchingStats.Wins,
            playerStat.PitchingStats.Losses,
            playerStat.PitchingStats.Runs,
            playerStat.PitchingStats.Start,
            playerStat.PitchingStats.Saves,
            playerStat.PitchingStats.Innings,
            playerStat.PitchingStats.HitsAllowed,
            playerStat.PitchingStats.WalksAllowed,
            playerStat.PitchingStats.PitchingStrikeouts));
    }

    private void AccumulateTotals(Models.Stats.Baseball.BaseballStatsModel playerStat, bool isAway)
    {
        var hit = isAway ? AwayHit : HomeHit;
        var pitch = isAway ? AwayPitch : HomePitch;

        hit.AtBats += playerStat.HittingStats.AtBats;
        hit.Hits += playerStat.HittingStats.Hits;
        hit.TotalBases += playerStat.HittingStats.TotalBases;
        hit.Runs += playerStat.HittingStats.Runs;
        hit.Doubles += playerStat.HittingStats.Doubles;
        hit.Triples += playerStat.HittingStats.Triples;
        hit.HomeRuns += playerStat.HittingStats.HomeRuns;
        hit.RBIs += playerStat.HittingStats.RunsBattedIn;
        hit.SBs += playerStat.HittingStats.StolenBases;
        hit.Walks += playerStat.HittingStats.Walks;
        hit.HBPs += playerStat.HittingStats.HitByPitch;
        hit.SFs += playerStat.HittingStats.SacrificeFly;
        hit.Strikeouts += playerStat.HittingStats.Strikeouts;

        pitch.Wins += playerStat.PitchingStats.Wins;
        pitch.Losses += playerStat.PitchingStats.Losses;
        pitch.Runs += playerStat.PitchingStats.Runs;
        pitch.Saves += playerStat.PitchingStats.Saves;
        pitch.Innings = DataLoader.AddInnings(pitch.Innings, playerStat.PitchingStats.Innings);
        pitch.HitsAllowed += playerStat.PitchingStats.HitsAllowed;
        pitch.WalksAllowed += playerStat.PitchingStats.WalksAllowed;
        pitch.Strikeouts += playerStat.PitchingStats.PitchingStrikeouts;
    }

    private async Task GetImageAsync()
    {
        LeagueByIdResponse = await DataLoader.GetOrLoad(
            () => LeagueLocalCache.GetLeagueByIdCache(GameModel.Game.LeagueId.ToString()),
            () => LeagueService.GetLeague(GameModel.Game.LeagueId),
            (l) => LeagueLocalCache.SetLeagueByIdCache(GameModel.Game.LeagueId.ToString(), l)
        );

        AwayTeamByIdResponse = await DataLoader.GetOrLoad(
            () => TeamLocalCache.GetTeamByIdCache(GameModel.Game.AwayTeam.Id.ToString()),
            () => TeamService.GetTeamById(GameModel.Game.AwayTeam.Id),
            (t) => TeamLocalCache.SetTeamByIdCache(GameModel.Game.AwayTeam.Id.ToString(), t)
        );
        
        HomeTeamByIdResponse = await DataLoader.GetOrLoad(
            () => TeamLocalCache.GetTeamByIdCache(GameModel.Game.HomeTeam.Id.ToString()),
            () => TeamService.GetTeamById(GameModel.Game.HomeTeam.Id),
            (t) => TeamLocalCache.SetTeamByIdCache(GameModel.Game.HomeTeam.Id.ToString(), t)
        );
        GameModel.Game.AwayTeamImage = await ImageService.GetTeamImageAsync(LeagueByIdResponse.League, AwayTeamByIdResponse.Team);
        GameModel.Game.HomeTeamImage = await ImageService.GetTeamImageAsync(LeagueByIdResponse.League, HomeTeamByIdResponse.Team);
    }

}

