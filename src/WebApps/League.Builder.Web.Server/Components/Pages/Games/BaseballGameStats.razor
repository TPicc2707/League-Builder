@page "/baseballgamestats/{id}"
@using League.Builder.Web.Server.Services.Cache
@inject IStatsService StatsService
@inject IGameService GameService
@inject ILeagueService LeagueService
@inject ITeamService TeamService
@inject IPlayerService PlayerService
@inject IAWSService AWSService
@inject ISnackbar Snackbar
@inject NavigationManager NavManager
@inject ErrorState ErrorState
@inject KeycloakTokenService KeycloakTokenService
@inject IJSRuntime JsRuntime
@inject IHttpContextAccessor HttpContextAccessor
@inject IGameLocalCacheService GameLocalCache
@inject IPlayerLocalCacheService PlayerLocalCache
@inject IStatsLocalCacheService StatsLocalCache
@inject ILeagueLocalCacheService LeagueLocalCache
@inject ITeamLocalCacheService TeamLocalCache

<AuthorizeView Roles="@String.Concat(Roles.ReadStats, ", ", Roles.ReadGames, ", ", Roles.ReadPlayers)" Context="auth">
    <Authorized>
        @if (PageLoad)
        {
            <TeamHeader Game="GameModel.Game" />
            <MudItem Style="padding-top: 25px;">
                <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Centered="true" Color="Color.Primary" Class="border border-solid" Style="border-color: #000000; padding: 25px;">
                    <MudTabPanel Text="@($"{GameModel.Game.AwayTeam.TeamName} Stats")">
                        <BaseballHittingTable Stats="Model.Where(x => x.TeamId == GameModel.Game.AwayTeam.Id)" />
                        <BaseballHittingTotals Totals="AwayHittingTotals" />
                        <BaseballPitchingTable Stats="Model.Where(x => x.TeamId == GameModel.Game.AwayTeam.Id && x.Position == PositionFilter.BASEBALL)" />
                        <BaseballPitchingTotals Totals="AwayPitchingTotals" />
                    </MudTabPanel>
                    <MudTabPanel Text="@String.Concat(GameModel.Game.HomeTeam.TeamName + " Stats")">
                        <BaseballHittingTable Stats="Model.Where(x => x.TeamId == GameModel.Game.HomeTeam.Id)" />
                        <BaseballHittingTotals Totals="HomeHittingTotals" />
                        <BaseballPitchingTable Stats="Model.Where(x => x.TeamId == GameModel.Game.HomeTeam.Id && x.Position == PositionFilter.BASEBALL)" />
                        <BaseballPitchingTotals Totals="HomePitchingTotals" />
                    </MudTabPanel>
                </MudTabs>

            </MudItem>
        }
        else
        {
            <Loading />
        }
    </Authorized>
    <NotAuthorized>
        <MudText>You are not authorized to view this page...</MudText>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter]
    public string Id { get; set; }
    private bool PageLoad = false;
    List<BaseballGameStatsModel> Model = new List<BaseballGameStatsModel>();
    GetGameByIdResponse GameModel { get; set; }
    GetPlayersByTeamResponse AwayPlayersModel { get; set; }
    GetPlayersByTeamResponse HomePlayersModel { get; set; }
    GetBaseballStatsByTeamResponse AwayPlayerStatsModel { get; set; }
    GetBaseballStatsByTeamResponse HomePlayerStatsModel { get; set; }
    GetLeagueByIdResponse LeagueByIdResponse { get; set; }
    GetTeamByIdResponse AwayTeamByIdResponse { get; set; }
    GetTeamByIdResponse HomeTeamByIdResponse { get; set; }
    private IJSObjectReference? _module;

    private HittingTotalAccumalator AwayHit = new();
    private PitchingTotalAccumalator AwayPitch = new();

    private BaseballHittingTotalsModel AwayHittingTotals => new()
    {
        AtBats = AwayHit.AtBats,
        Runs = AwayHit.Runs,
        Hits = AwayHit.Hits,
        RBIs = AwayHit.RBIs,
        Walks = AwayHit.Walks,
        HBPs = AwayHit.HBPs,
        Strikeouts = AwayHit.Strikeouts,
        SBs = AwayHit.SBs,
        TBs = AwayHit.TotalBases,
        Doubles = AwayHit.Doubles,
        Triples = AwayHit.Triples,
        HomeRuns = AwayHit.HomeRuns,
        SFs = AwayHit.SFs
    };

    private BaseballPitchingTotalsModel AwayPitchingTotals => new()
    {
        Wins = AwayPitch.Wins,
        Losses = AwayPitch.Losses,
        Runs = AwayPitch.Runs,
        Saves = AwayPitch.Saves,
        Innings = AwayPitch.Innings,
        HitsAllowed = AwayPitch.HitsAllowed,
        WalksAllowed = AwayPitch.WalksAllowed,
        Strikeouts = AwayPitch.Strikeouts
    };

    private HittingTotalAccumalator HomeHit = new();
    private PitchingTotalAccumalator HomePitch = new();

    private BaseballHittingTotalsModel HomeHittingTotals => new()
    {
        AtBats = HomeHit.AtBats,
        Runs = HomeHit.Runs,
        Hits = HomeHit.Hits,
        RBIs = HomeHit.RBIs,
        Walks = HomeHit.Walks,
        HBPs = HomeHit.HBPs,
        Strikeouts = HomeHit.Strikeouts,
        SBs = HomeHit.SBs,
        TBs = HomeHit.TotalBases,
        Doubles = HomeHit.Doubles,
        Triples = HomeHit.Triples,
        HomeRuns = HomeHit.HomeRuns,
        SFs = HomeHit.SFs
    };

    private BaseballPitchingTotalsModel HomePitchingTotals => new()
    {
        Wins = HomePitch.Wins,
        Losses = HomePitch.Losses,
        Runs = HomePitch.Runs,
        Saves = HomePitch.Saves,
        Innings = HomePitch.Innings,
        HitsAllowed = HomePitch.HitsAllowed,
        WalksAllowed = HomePitch.WalksAllowed,
        Strikeouts = HomePitch.Strikeouts
    };


    protected override async Task OnInitializedAsync()
    {
        try
        {
            var gameId = Guid.Parse(Id);

            GameModel = await GameLocalCache.GetGameByIdCache(Id) 
                        ?? await GameService.GetGameById(gameId);

            if (GameModel is not null)
                await GameLocalCache.SetGameByIdCache(Id, GameModel);

            AwayPlayersModel = await PlayerLocalCache.GetPlayersByTeamCache(GameModel.Game.AwayTeam.Id.ToString())
                               ?? await PlayerService.GetPlayersByTeam(GameModel.Game.AwayTeam.Id);

            if (AwayPlayersModel is not null)
                await PlayerLocalCache.SetPlayersByTeamCache(GameModel.Game.AwayTeam.Id.ToString(), AwayPlayersModel);

            HomePlayersModel = await PlayerLocalCache.GetPlayersByTeamCache(GameModel.Game.HomeTeam.Id.ToString())
                               ?? await PlayerService.GetPlayersByTeam(GameModel.Game.HomeTeam.Id);
            if (HomePlayersModel is not null)
                await PlayerLocalCache.SetPlayersByTeamCache(GameModel.Game.HomeTeam.Id.ToString(), HomePlayersModel);

            AwayPlayerStatsModel = await StatsService.GetBaseballStatsByTeam(GameModel.Game.AwayTeam.Id)
                                   ?? await StatsService.GetBaseballStatsByTeam(GameModel.Game.AwayTeam.Id);
            if (AwayPlayerStatsModel is not null)
                await StatsLocalCache.SetBaseballStatsByTeamCache(GameModel.Game.HomeTeam.Id.ToString(), AwayPlayerStatsModel);

            HomePlayerStatsModel = await StatsLocalCache.GetBaseballStatsByTeamCache(GameModel.Game.HomeTeam.Id.ToString())
                                    ?? await StatsService.GetBaseballStatsByTeam(GameModel.Game.HomeTeam.Id);
            if (HomePlayerStatsModel is not null)
                await StatsLocalCache.SetBaseballStatsByTeamCache(GameModel.Game.HomeTeam.Id.ToString(), HomePlayerStatsModel);

            await GetImageAsync();

            foreach (var player in AwayPlayersModel.Players)
            {
                var playerStat = AwayPlayerStatsModel.BaseballStats.FirstOrDefault(x => x.PlayerId == player.Id && x.GameId == GameModel.Game.Id);
                if (playerStat is not null)
                {
                    Model.Add(new BaseballGameStatsModel(GameModel.Game.LeagueId, player.TeamId, player.Id, GameModel.Game.SeasonId, GameModel.Game.Id, player.FirstName, player.LastName, player.PlayerDetail.Position,
                                                        playerStat.HittingStats.AtBats, playerStat.HittingStats.Hits, playerStat.HittingStats.TotalBases, playerStat.HittingStats.Runs, playerStat.HittingStats.Doubles,
                                                        playerStat.HittingStats.Triples, playerStat.HittingStats.HomeRuns, playerStat.HittingStats.RunsBattedIn, playerStat.HittingStats.StolenBases,
                                                        playerStat.HittingStats.Strikeouts, playerStat.HittingStats.Walks, playerStat.HittingStats.HitByPitch, playerStat.HittingStats.SacrificeFly, playerStat.PitchingStats.Wins, playerStat.PitchingStats.Losses, playerStat.PitchingStats.Runs,
                                                        playerStat.PitchingStats.Start, playerStat.PitchingStats.Saves, playerStat.PitchingStats.Innings, playerStat.PitchingStats.HitsAllowed, playerStat.PitchingStats.WalksAllowed,
                                                        playerStat.PitchingStats.PitchingStrikeouts));

                    AwayHit.AtBats += playerStat.HittingStats.AtBats;
                    AwayHit.Hits += playerStat.HittingStats.Hits;
                    AwayHit.TotalBases += playerStat.HittingStats.TotalBases;
                    AwayHit.Runs += playerStat.HittingStats.Runs;
                    AwayHit.Doubles += playerStat.HittingStats.Doubles;
                    AwayHit.Triples += playerStat.HittingStats.Triples;
                    AwayHit.HomeRuns += playerStat.HittingStats.HomeRuns;
                    AwayHit.RBIs += playerStat.HittingStats.RunsBattedIn;
                    AwayHit.SBs += playerStat.HittingStats.StolenBases;
                    AwayHit.Walks += playerStat.HittingStats.Walks;
                    AwayHit.HBPs += playerStat.HittingStats.HitByPitch;
                    AwayHit.SFs += playerStat.HittingStats.SacrificeFly;
                    AwayHit.Strikeouts += playerStat.HittingStats.Strikeouts;

                    AwayPitch.Wins += playerStat.PitchingStats.Wins;
                    AwayPitch.Losses += playerStat.PitchingStats.Losses;
                    AwayPitch.Runs += playerStat.PitchingStats.Runs;
                    AwayPitch.Saves += playerStat.PitchingStats.Saves;
                    AwayPitch.Innings += playerStat.PitchingStats.Innings;
                    AwayPitch.HitsAllowed += playerStat.PitchingStats.HitsAllowed;
                    AwayPitch.WalksAllowed += playerStat.PitchingStats.WalksAllowed;
                    AwayPitch.Strikeouts += playerStat.PitchingStats.PitchingStrikeouts;

                }
                else if (GameModel.Game.GameStatus == GameStatus.Completed)
                    Model.Add(new BaseballGameStatsModel(GameModel.Game.LeagueId, player.TeamId, player.Id, GameModel.Game.SeasonId, GameModel.Game.Id, player.FirstName, player.LastName, player.PlayerDetail.Position));
            }
            foreach (var player in HomePlayersModel.Players)
            {
                var playerStat = HomePlayerStatsModel.BaseballStats.FirstOrDefault(x => x.PlayerId == player.Id && x.GameId == GameModel.Game.Id);
                if (playerStat is not null)
                {
                    Model.Add(new BaseballGameStatsModel(GameModel.Game.LeagueId, player.TeamId, player.Id, GameModel.Game.SeasonId, GameModel.Game.Id, player.FirstName, player.LastName, player.PlayerDetail.Position,
                                            playerStat.HittingStats.AtBats, playerStat.HittingStats.Hits, playerStat.HittingStats.TotalBases, playerStat.HittingStats.Runs, playerStat.HittingStats.Doubles,
                                            playerStat.HittingStats.Triples, playerStat.HittingStats.HomeRuns, playerStat.HittingStats.RunsBattedIn, playerStat.HittingStats.StolenBases,
                                            playerStat.HittingStats.Strikeouts, playerStat.HittingStats.Walks, playerStat.HittingStats.HitByPitch, playerStat.HittingStats.SacrificeFly, playerStat.PitchingStats.Wins, playerStat.PitchingStats.Losses, playerStat.PitchingStats.Runs,
                                            playerStat.PitchingStats.Start, playerStat.PitchingStats.Saves, playerStat.PitchingStats.Innings, playerStat.PitchingStats.HitsAllowed, playerStat.PitchingStats.WalksAllowed,
                                            playerStat.PitchingStats.PitchingStrikeouts));

                    HomeHit.AtBats += playerStat.HittingStats.AtBats;
                    HomeHit.Hits += playerStat.HittingStats.Hits;
                    HomeHit.TotalBases += playerStat.HittingStats.TotalBases;
                    HomeHit.Runs += playerStat.HittingStats.Runs;
                    HomeHit.Doubles += playerStat.HittingStats.Doubles;
                    HomeHit.Triples += playerStat.HittingStats.Triples;
                    HomeHit.HomeRuns += playerStat.HittingStats.HomeRuns;
                    HomeHit.RBIs += playerStat.HittingStats.RunsBattedIn;
                    HomeHit.SBs += playerStat.HittingStats.StolenBases;
                    HomeHit.Walks += playerStat.HittingStats.Walks;
                    HomeHit.HBPs += playerStat.HittingStats.HitByPitch;
                    HomeHit.SFs += playerStat.HittingStats.SacrificeFly;
                    HomeHit.Strikeouts += playerStat.HittingStats.Strikeouts;

                    HomePitch.Wins += playerStat.PitchingStats.Wins;
                    HomePitch.Losses += playerStat.PitchingStats.Losses;
                    HomePitch.Runs += playerStat.PitchingStats.Runs;
                    HomePitch.Saves += playerStat.PitchingStats.Saves;
                    HomePitch.Innings += playerStat.PitchingStats.Innings;
                    HomePitch.HitsAllowed += playerStat.PitchingStats.HitsAllowed;
                    HomePitch.WalksAllowed += playerStat.PitchingStats.WalksAllowed;
                    HomePitch.Strikeouts += playerStat.PitchingStats.PitchingStrikeouts;


                }
                else if (GameModel.Game.GameStatus == GameStatus.Completed)
                    Model.Add(new BaseballGameStatsModel(GameModel.Game.LeagueId, player.TeamId, player.Id, GameModel.Game.SeasonId, GameModel.Game.Id, player.FirstName, player.LastName, player.PlayerDetail.Position));
            }
            PageLoad = true;
        }
        catch (Exception ex)
        {
            if (KeycloakTokenService.ShouldForceLogout())
            {
                _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/authRefresh.js");
                await _module.InvokeVoidAsync("logout");
            }
            ErrorState.Message = ex.Message;
            NavManager.NavigateTo("/error");
        }
    }

    private async Task GetImageAsync()
    {
        LeagueByIdResponse = await LeagueLocalCache.GetLeagueByIdCache(GameModel.Game.LeagueId.ToString());
        if(LeagueByIdResponse == null)
        {
            LeagueByIdResponse = await LeagueService.GetLeague(GameModel.Game.LeagueId);
            await LeagueLocalCache.SetLeagueByIdCache(GameModel.Game.LeagueId.ToString(), LeagueByIdResponse);
        }
        AwayTeamByIdResponse = await TeamLocalCache.GetTeamByIdCache(GameModel.Game.AwayTeam.Id.ToString());
        if (AwayTeamByIdResponse == null)
        {
            AwayTeamByIdResponse = await TeamService.GetTeamById(GameModel.Game.AwayTeam.Id);
            await TeamLocalCache.SetTeamByIdCache(GameModel.Game.AwayTeam.Id.ToString(), AwayTeamByIdResponse);
        }
        HomeTeamByIdResponse = await TeamLocalCache.GetTeamByIdCache(GameModel.Game.HomeTeam.Id.ToString());
        if (HomeTeamByIdResponse == null)
        {
            HomeTeamByIdResponse = await TeamService.GetTeamById(GameModel.Game.HomeTeam.Id);
            await TeamLocalCache.SetTeamByIdCache(GameModel.Game.AwayTeam.Id.ToString(), HomeTeamByIdResponse);
        }
        var awayTeamKeyPath = $"/{LeagueByIdResponse.League.Sport}/{LeagueByIdResponse.League.Name}/teams/{AwayTeamByIdResponse.Team.TeamName}/{AwayTeamByIdResponse.Team.ImageFile}";
        GameModel.Game.AwayTeamImage = await AWSService.GetImage(awayTeamKeyPath);

        var homeTeamKeyPath = $"/{LeagueByIdResponse.League.Sport}/{LeagueByIdResponse.League.Name}/teams/{HomeTeamByIdResponse.Team.TeamName}/{HomeTeamByIdResponse.Team.ImageFile}";
        GameModel.Game.HomeTeamImage = await AWSService.GetImage(homeTeamKeyPath);
    }

}

