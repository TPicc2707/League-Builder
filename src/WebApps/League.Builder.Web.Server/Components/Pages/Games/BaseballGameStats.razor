@page "/baseballgamestats/{id}"
@using League.Builder.Web.Server.Services.Cache
@inject IStatsService StatsService
@inject IGameService GameService
@inject ILeagueService LeagueService
@inject ITeamService TeamService
@inject IPlayerService PlayerService
@inject IAWSService AWSService
@inject ISnackbar Snackbar
@inject NavigationManager NavManager
@inject ErrorState ErrorState
@inject KeycloakTokenService KeycloakTokenService
@inject IJSRuntime JsRuntime
@inject IHttpContextAccessor HttpContextAccessor
@inject IGameLocalCacheService GameLocalCache
@inject IPlayerLocalCacheService PlayerLocalCache
@inject IStatsLocalCacheService StatsLocalCache
@inject ILeagueLocalCacheService LeagueLocalCache
@inject ITeamLocalCacheService TeamLocalCache

<AuthorizeView Roles="@String.Concat(Roles.ReadStats, ", ", Roles.ReadGames, ", ", Roles.ReadPlayers)" Context="auth">
    <Authorized>
        @if (PageLoad)
        {
            <TeamHeader Game="GameModel.Game" />
            <MudItem Style="padding-top: 25px;">
                <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Centered="true" Color="Color.Primary" Class="border border-solid" Style="border-color: #000000; padding: 25px;">
                    <MudTabPanel Text="@($"{GameModel.Game.AwayTeam.TeamName} Stats")">
                        <BaseballHittingTable Stats="Model.Where(x => x.TeamId == GameModel.Game.AwayTeam.Id)" />
                        <BaseballHittingTotals Totals="AwayHittingTotals" />
                        <BaseballPitchingTable Stats="Model.Where(x => x.TeamId == GameModel.Game.AwayTeam.Id)" />
                        <BaseballPitchingTotals Totals="AwayPitchingTotals" />
                    </MudTabPanel>
                    <MudTabPanel Text="@String.Concat(GameModel.Game.HomeTeam.TeamName + " Stats")">
                        <BaseballHittingTable Stats="Model.Where(x => x.TeamId == GameModel.Game.HomeTeam.Id)" />
                        <BaseballHittingTotals Totals="HomeHittingTotals" />
                        <BaseballPitchingTable Stats="Model.Where(x => x.TeamId == GameModel.Game.HomeTeam.Id)" />
                        <BaseballPitchingTotals Totals="HomePitchingTotals" />
                    </MudTabPanel>
                </MudTabs>

            </MudItem>
        }
        else
        {
            <Loading />
        }
    </Authorized>
    <NotAuthorized>
        <MudText>You are not authorized to view this page...</MudText>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter]
    public string Id { get; set; }
    private bool PageLoad = false;
    List<BaseballGameStatsModel> Model = new List<BaseballGameStatsModel>();
    GetGameByIdResponse GameModel { get; set; }
    GetPlayersByTeamResponse AwayPlayersModel { get; set; }
    GetPlayersByTeamResponse HomePlayersModel { get; set; }
    GetBaseballStatsByTeamResponse AwayPlayerStatsModel { get; set; }
    GetBaseballStatsByTeamResponse HomePlayerStatsModel { get; set; }
    GetLeagueByIdResponse LeagueByIdResponse { get; set; }
    GetTeamByIdResponse AwayTeamByIdResponse { get; set; }
    GetTeamByIdResponse HomeTeamByIdResponse { get; set; }
    private IJSObjectReference? _module;

    private int AwayTotalAtBats = 0;
    private int AwayTotalHits = 0;
    private int AwayTotalRuns = 0;
    private int AwayTotalTBs = 0;
    private int AwayTotalWalks = 0;
    private int AwayTotalHBPs = 0;
    private int AwayTotalSFs = 0;
    private int AwayTotalStrikeouts = 0;
    private int AwayTotalDoubles = 0;
    private int AwayTotalTriples = 0;
    private int AwayTotalHomeRuns = 0;
    private int AwayTotalRBIs = 0;
    private int AwayTotalSBs = 0;
    private int AwayTotalWins = 0;
    private int AwayTotalLosses = 0;
    private int AwayTotalPitchingRuns = 0;
    private int AwayTotalSaves = 0;
    private decimal AwayTotalInnings = 0;
    private int AwayTotalHitsAllowed = 0;
    private int AwayTotalWalksAllowed = 0;
    private int AwayTotalPitchingStrikeouts = 0;

    private BaseballHittingTotalsModel AwayHittingTotals => new()
    {
        AtBats = AwayTotalAtBats,
        Runs = AwayTotalRuns,
        Hits = AwayTotalHits,
        RBIs = AwayTotalRBIs,
        Walks = AwayTotalWalks,
        HBPs = AwayTotalHBPs,
        Strikeouts = AwayTotalStrikeouts,
        SBs = AwayTotalSBs,
        TBs = AwayTotalTBs,
        Doubles = AwayTotalDoubles,
        Triples = AwayTotalTriples,
        HomeRuns = AwayTotalHomeRuns,
        SFs = AwayTotalSFs
    };

    private BaseballPitchingTotalsModel AwayPitchingTotals => new()
    {
        Wins = AwayTotalWins,
        Losses = AwayTotalLosses,
        Runs = AwayTotalPitchingRuns,
        Saves = AwayTotalSaves,
        Innings = AwayTotalInnings,
        HitsAllowed = AwayTotalHitsAllowed,
        WalksAllowed = AwayTotalWalksAllowed,
        Strikeouts = AwayTotalPitchingStrikeouts
    };


    private int HomeTotalAtBats = 0;
    private int HomeTotalHits = 0;
    private int HomeTotalRuns = 0;
    private int HomeTotalTBs = 0;
    private int HomeTotalWalks = 0;
    private int HomeTotalHBPs = 0;
    private int HomeTotalSFs = 0;
    private int HomeTotalStrikeouts = 0;
    private int HomeTotalDoubles = 0;
    private int HomeTotalTriples = 0;
    private int HomeTotalHomeRuns = 0;
    private int HomeTotalRBIs = 0;
    private int HomeTotalSBs = 0;
    private int HomeTotalWins = 0;
    private int HomeTotalLosses = 0;
    private int HomeTotalPitchingRuns = 0;
    private int HomeTotalSaves = 0;
    private decimal HomeTotalInnings = 0;
    private int HomeTotalHitsAllowed = 0;
    private int HomeTotalWalksAllowed = 0;
    private int HomeTotalPitchingStrikeouts = 0;

    private BaseballHittingTotalsModel HomeHittingTotals => new()
    {
        AtBats = HomeTotalAtBats,
        Runs = HomeTotalRuns,
        Hits = HomeTotalHits,
        RBIs = HomeTotalRBIs,
        Walks = HomeTotalWalks,
        HBPs = HomeTotalHBPs,
        Strikeouts = HomeTotalStrikeouts,
        SBs = HomeTotalSBs,
        TBs = HomeTotalTBs,
        Doubles = HomeTotalDoubles,
        Triples = HomeTotalTriples,
        HomeRuns = HomeTotalHomeRuns,
        SFs = HomeTotalSFs
    };

    private BaseballPitchingTotalsModel HomePitchingTotals => new()
    {
        Wins = HomeTotalWins,
        Losses = HomeTotalLosses,
        Runs = HomeTotalPitchingRuns,
        Saves = HomeTotalSaves,
        Innings = HomeTotalInnings,
        HitsAllowed = HomeTotalHitsAllowed,
        WalksAllowed = HomeTotalWalksAllowed,
        Strikeouts = HomeTotalPitchingStrikeouts
    };



    protected override async Task OnInitializedAsync()
    {
        try
        {
            var gameId = Guid.Parse(Id);
            GameModel = await GameLocalCache.GetGameByIdCache(Id);
            if (GameModel == null)
            {
                GameModel = await GameService.GetGameById(gameId);
                await GameLocalCache.SetGameByIdCache(Id, GameModel);
            }
            AwayPlayersModel = await PlayerLocalCache.GetPlayersByTeamCache(GameModel.Game.AwayTeam.Id.ToString());
            if (AwayPlayersModel == null)
            {
                AwayPlayersModel = await PlayerService.GetPlayersByTeam(GameModel.Game.AwayTeam.Id);
                await PlayerLocalCache.SetPlayersByTeamCache(GameModel.Game.AwayTeam.Id.ToString(), AwayPlayersModel);
            }
            HomePlayersModel = await PlayerLocalCache.GetPlayersByTeamCache(GameModel.Game.HomeTeam.Id.ToString());
            if (HomePlayersModel == null)
            {
                HomePlayersModel = await PlayerService.GetPlayersByTeam(GameModel.Game.HomeTeam.Id);
                await PlayerLocalCache.SetPlayersByTeamCache(GameModel.Game.HomeTeam.Id.ToString(), HomePlayersModel);
            }
            AwayPlayerStatsModel = await StatsLocalCache.GetBaseballStatsByTeamCache(GameModel.Game.AwayTeam.Id.ToString());
            if (AwayPlayerStatsModel == null)
            {
                AwayPlayerStatsModel = await StatsService.GetBaseballStatsByTeam(GameModel.Game.HomeTeam.Id);
                await StatsLocalCache.SetBaseballStatsByTeamCache(GameModel.Game.AwayTeam.Id.ToString(), AwayPlayerStatsModel);
            }
            HomePlayerStatsModel = await StatsLocalCache.GetBaseballStatsByTeamCache(GameModel.Game.HomeTeam.Id.ToString());
            if (HomePlayerStatsModel == null)
            {
                HomePlayerStatsModel = await StatsService.GetBaseballStatsByTeam(GameModel.Game.HomeTeam.Id);
                await StatsLocalCache.SetBaseballStatsByTeamCache(GameModel.Game.HomeTeam.Id.ToString(), HomePlayerStatsModel);
            }
            await GetImageAsync();
            foreach (var player in AwayPlayersModel.Players)
            {
                var playerStat = AwayPlayerStatsModel.BaseballStats.FirstOrDefault(x => x.PlayerId == player.Id && x.GameId == GameModel.Game.Id);
                if (playerStat is not null)
                {
                    Model.Add(new BaseballGameStatsModel(GameModel.Game.LeagueId, player.TeamId, player.Id, GameModel.Game.SeasonId, GameModel.Game.Id, player.FirstName, player.LastName,
                                                        playerStat.HittingStats.AtBats, playerStat.HittingStats.Hits, playerStat.HittingStats.TotalBases, playerStat.HittingStats.Runs, playerStat.HittingStats.Doubles,
                                                        playerStat.HittingStats.Triples, playerStat.HittingStats.HomeRuns, playerStat.HittingStats.RunsBattedIn, playerStat.HittingStats.StolenBases,
                                                        playerStat.HittingStats.Strikeouts, playerStat.HittingStats.Walks, playerStat.HittingStats.HitByPitch, playerStat.HittingStats.SacrificeFly, playerStat.PitchingStats.Wins, playerStat.PitchingStats.Losses, playerStat.PitchingStats.Runs,
                                                        playerStat.PitchingStats.Start, playerStat.PitchingStats.Saves, playerStat.PitchingStats.Innings, playerStat.PitchingStats.HitsAllowed, playerStat.PitchingStats.WalksAllowed,
                                                        playerStat.PitchingStats.PitchingStrikeouts));

                    AwayTotalAtBats += playerStat.HittingStats.AtBats;
                    AwayTotalHits += playerStat.HittingStats.Hits;
                    AwayTotalTBs += playerStat.HittingStats.TotalBases;
                    AwayTotalRuns += playerStat.HittingStats.Runs;
                    AwayTotalDoubles += playerStat.HittingStats.Doubles;
                    AwayTotalTriples += playerStat.HittingStats.Triples;
                    AwayTotalHomeRuns += playerStat.HittingStats.HomeRuns;
                    AwayTotalRBIs += playerStat.HittingStats.RunsBattedIn;
                    AwayTotalSBs += playerStat.HittingStats.StolenBases;
                    AwayTotalWalks += playerStat.HittingStats.Walks;
                    AwayTotalHBPs += playerStat.HittingStats.HitByPitch;
                    AwayTotalSFs += playerStat.HittingStats.SacrificeFly;
                    AwayTotalStrikeouts += playerStat.HittingStats.Strikeouts;

                    AwayTotalWins += playerStat.PitchingStats.Wins;
                    AwayTotalLosses += playerStat.PitchingStats.Losses;
                    AwayTotalPitchingRuns += playerStat.PitchingStats.Runs;
                    AwayTotalSaves += playerStat.PitchingStats.Saves;
                    AwayTotalInnings += playerStat.PitchingStats.Innings;
                    AwayTotalHitsAllowed += playerStat.PitchingStats.HitsAllowed;
                    AwayTotalWalksAllowed += playerStat.PitchingStats.WalksAllowed;
                    AwayTotalPitchingStrikeouts += playerStat.PitchingStats.PitchingStrikeouts;

                }
                else if (GameModel.Game.GameStatus == GameStatus.Completed)
                    Model.Add(new BaseballGameStatsModel(GameModel.Game.LeagueId, player.TeamId, player.Id, GameModel.Game.SeasonId, GameModel.Game.Id, player.FirstName, player.LastName));
            }
            foreach (var player in HomePlayersModel.Players)
            {
                var playerStat = HomePlayerStatsModel.BaseballStats.FirstOrDefault(x => x.PlayerId == player.Id && x.GameId == GameModel.Game.Id);
                if (playerStat is not null)
                {
                    Model.Add(new BaseballGameStatsModel(GameModel.Game.LeagueId, player.TeamId, player.Id, GameModel.Game.SeasonId, GameModel.Game.Id, player.FirstName, player.LastName,
                                            playerStat.HittingStats.AtBats, playerStat.HittingStats.Hits, playerStat.HittingStats.TotalBases, playerStat.HittingStats.Runs, playerStat.HittingStats.Doubles,
                                            playerStat.HittingStats.Triples, playerStat.HittingStats.HomeRuns, playerStat.HittingStats.RunsBattedIn, playerStat.HittingStats.StolenBases,
                                            playerStat.HittingStats.Strikeouts, playerStat.HittingStats.Walks, playerStat.HittingStats.HitByPitch, playerStat.HittingStats.SacrificeFly, playerStat.PitchingStats.Wins, playerStat.PitchingStats.Losses, playerStat.PitchingStats.Runs,
                                            playerStat.PitchingStats.Start, playerStat.PitchingStats.Saves, playerStat.PitchingStats.Innings, playerStat.PitchingStats.HitsAllowed, playerStat.PitchingStats.WalksAllowed,
                                            playerStat.PitchingStats.PitchingStrikeouts));

                    HomeTotalAtBats += playerStat.HittingStats.AtBats;
                    HomeTotalHits += playerStat.HittingStats.Hits;
                    HomeTotalTBs += playerStat.HittingStats.TotalBases;
                    HomeTotalRuns += playerStat.HittingStats.Runs;
                    HomeTotalDoubles += playerStat.HittingStats.Doubles;
                    HomeTotalTriples += playerStat.HittingStats.Triples;
                    HomeTotalHomeRuns += playerStat.HittingStats.HomeRuns;
                    HomeTotalRBIs += playerStat.HittingStats.RunsBattedIn;
                    HomeTotalSBs += playerStat.HittingStats.StolenBases;
                    HomeTotalWalks += playerStat.HittingStats.Walks;
                    HomeTotalHBPs += playerStat.HittingStats.HitByPitch;
                    HomeTotalSFs += playerStat.HittingStats.SacrificeFly;
                    HomeTotalStrikeouts += playerStat.HittingStats.Strikeouts;

                    HomeTotalWins += playerStat.PitchingStats.Wins;
                    HomeTotalLosses += playerStat.PitchingStats.Losses;
                    HomeTotalPitchingRuns += playerStat.PitchingStats.Runs;
                    HomeTotalSaves += playerStat.PitchingStats.Saves;
                    HomeTotalInnings += playerStat.PitchingStats.Innings;
                    HomeTotalHitsAllowed += playerStat.PitchingStats.HitsAllowed;
                    HomeTotalWalksAllowed += playerStat.PitchingStats.WalksAllowed;
                    HomeTotalPitchingStrikeouts += playerStat.PitchingStats.PitchingStrikeouts;


                }
                else if (GameModel.Game.GameStatus == GameStatus.Completed)
                    Model.Add(new BaseballGameStatsModel(GameModel.Game.LeagueId, player.TeamId, player.Id, GameModel.Game.SeasonId, GameModel.Game.Id, player.FirstName, player.LastName));
            }
            PageLoad = true;
        }
        catch (Exception ex)
        {
            if (KeycloakTokenService.ShouldForceLogout())
            {
                _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/authRefresh.js");
                await _module.InvokeVoidAsync("logout");
            }
            ErrorState.Message = ex.Message;
            NavManager.NavigateTo("/error");
        }
    }

    private async Task GetImageAsync()
    {
        LeagueByIdResponse = await LeagueLocalCache.GetLeagueByIdCache(GameModel.Game.LeagueId.ToString());
        if(LeagueByIdResponse == null)
        {
            LeagueByIdResponse = await LeagueService.GetLeague(GameModel.Game.LeagueId);
            await LeagueLocalCache.SetLeagueByIdCache(GameModel.Game.LeagueId.ToString(), LeagueByIdResponse);
        }
        AwayTeamByIdResponse = await TeamLocalCache.GetTeamByIdCache(GameModel.Game.AwayTeam.Id.ToString());
        if (AwayTeamByIdResponse == null)
        {
            AwayTeamByIdResponse = await TeamService.GetTeamById(GameModel.Game.AwayTeam.Id);
            await TeamLocalCache.SetTeamByIdCache(GameModel.Game.AwayTeam.Id.ToString(), AwayTeamByIdResponse);
        }
        HomeTeamByIdResponse = await TeamLocalCache.GetTeamByIdCache(GameModel.Game.HomeTeam.Id.ToString());
        if (HomeTeamByIdResponse == null)
        {
            HomeTeamByIdResponse = await TeamService.GetTeamById(GameModel.Game.HomeTeam.Id);
            await TeamLocalCache.SetTeamByIdCache(GameModel.Game.AwayTeam.Id.ToString(), HomeTeamByIdResponse);
        }
        var awayTeamKeyPath = $"/{LeagueByIdResponse.League.Sport}/{LeagueByIdResponse.League.Name}/teams/{AwayTeamByIdResponse.Team.TeamName}/{AwayTeamByIdResponse.Team.ImageFile}";
        GameModel.Game.AwayTeamImage = await AWSService.GetImage(awayTeamKeyPath);

        var homeTeamKeyPath = $"/{LeagueByIdResponse.League.Sport}/{LeagueByIdResponse.League.Name}/teams/{HomeTeamByIdResponse.Team.TeamName}/{HomeTeamByIdResponse.Team.ImageFile}";
        GameModel.Game.HomeTeamImage = await AWSService.GetImage(homeTeamKeyPath);
    }

}

