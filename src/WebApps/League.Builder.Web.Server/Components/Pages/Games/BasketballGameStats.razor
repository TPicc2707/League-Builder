@page "/basketballgamestats/{id}"
@using League.Builder.Web.Server.Services.Cache
@inject IStatsService StatsService
@inject IGameService GameService
@inject ILeagueService LeagueService
@inject ITeamService TeamService
@inject IPlayerService PlayerService
@inject IAWSService AWSService
@inject ISnackbar Snackbar
@inject NavigationManager NavManager
@inject ErrorState ErrorState
@inject KeycloakTokenService KeycloakTokenService
@inject IJSRuntime JsRuntime
@inject IHttpContextAccessor HttpContextAccessor
@inject IGameLocalCacheService GameLocalCache
@inject IPlayerLocalCacheService PlayerLocalCache
@inject IStatsLocalCacheService StatsLocalCache
@inject ILeagueLocalCacheService LeagueLocalCache
@inject ITeamLocalCacheService TeamLocalCache

<AuthorizeView Roles="@String.Concat(Roles.ReadStats, ", ", Roles.ReadGames, ", ", Roles.ReadPlayers)" Context="auth">
    <Authorized>
        @if (PageLoad)
        {
            <TeamHeader Game="GameModel.Game" />
            <MudItem Style="padding-top: 25px;">
                <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Color="Color.Primary" Centered="true" Class="border border-solid" Style="border-color: #000000; padding: 25px;">
                    <MudTabPanel Text="@($"{GameModel.Game.AwayTeam.TeamName} Stats")">
                        <BasketballStatsTable Stats="AwayStats" />
                        <BasketballStatsTotals Totals="AwayTotalsModel" />
                    </MudTabPanel>
                    <MudTabPanel Text="@($"{GameModel.Game.HomeTeam.TeamName} Stats")">
                        <BasketballStatsTable Stats="HomeStats" />
                        <BasketballStatsTotals Totals="HomeTotalsModel" />
                    </MudTabPanel>
                </MudTabs>
            </MudItem>
        }
        else
        {
            <Loading />
        }
    </Authorized>
    <NotAuthorized>
        <MudText>You are not authorized to view this page...</MudText>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter]
    public string Id { get; set; }
    private bool PageLoad = false;
    List<BasketballGameStatsModel> Model = new List<BasketballGameStatsModel>();
    GetGameByIdResponse GameModel { get; set; }
    GetPlayersByTeamResponse AwayPlayersModel { get; set; }
    GetPlayersByTeamResponse HomePlayersModel { get; set; }
    GetBasketballStatsByTeamResponse AwayPlayerStatsModel { get; set; }
    GetBasketballStatsByTeamResponse HomePlayerStatsModel { get; set; }
    GetLeagueByIdResponse LeagueByIdResponse { get; set; }
    GetTeamByIdResponse AwayTeamByIdResponse { get; set; }
    GetTeamByIdResponse HomeTeamByIdResponse { get; set; }
    private IJSObjectReference? _module;

    private TotalAccumulator AwayTotals = new();
    private TotalAccumulator HomeTotals = new();

    private BasketballTotalsModel AwayTotalsModel => new()
    {
        Points = AwayTotals.Points,
        FieldGoalsMade = AwayTotals.FieldGoalsMade,
        FieldGoalsAttempted = AwayTotals.FieldGoalsAttempted,
        ThreePointersMade = AwayTotals.ThreePointersMade,
        ThreePointersAttempted = AwayTotals.ThreePointersAttempted,
        FreeThrowsMade = AwayTotals.FreeThrowsMade,
        FreeThrowsAttempted = AwayTotals.FreeThrowsAttempted,
        Rebounds = AwayTotals.Rebounds,
        Assists = AwayTotals.Assists,
        Steals = AwayTotals.Steals,
        Blocks = AwayTotals.Blocks,
        Turnovers = AwayTotals.Turnovers,
        Fouls = AwayTotals.Fouls
    };

    private BasketballTotalsModel HomeTotalsModel => new()
    {
        Points = HomeTotals.Points,
        FieldGoalsMade = HomeTotals.FieldGoalsMade,
        FieldGoalsAttempted = HomeTotals.FieldGoalsAttempted,
        ThreePointersMade = HomeTotals.ThreePointersMade,
        ThreePointersAttempted = HomeTotals.ThreePointersAttempted,
        FreeThrowsMade = HomeTotals.FreeThrowsMade,
        FreeThrowsAttempted = HomeTotals.FreeThrowsAttempted,
        Rebounds = HomeTotals.Rebounds,
        Assists = HomeTotals.Assists,
        Steals = HomeTotals.Steals,
        Blocks = HomeTotals.Blocks,
        Turnovers = HomeTotals.Turnovers,
        Fouls = HomeTotals.Fouls
    };

    private IEnumerable<BasketballGameStatsModel> AwayStats =>
        Model.Where(x => x.TeamId == GameModel.Game.AwayTeam.Id);

    private IEnumerable<BasketballGameStatsModel> HomeStats =>
        Model.Where(x => x.TeamId == GameModel.Game.HomeTeam.Id);


    protected override async Task OnInitializedAsync()
    {
        try
        {
            var gameId = Guid.Parse(Id);

            GameModel = await GameLocalCache.GetGameByIdCache(Id)
                        ?? await GameService.GetGameById(gameId);

            if (GameModel is not null)
                await GameLocalCache.SetGameByIdCache(Id, GameModel);

            AwayPlayersModel = await PlayerLocalCache.GetPlayersByTeamCache(GameModel.Game.AwayTeam.Id.ToString())
                               ?? await PlayerService.GetPlayersByTeam(GameModel.Game.AwayTeam.Id);

            if (AwayPlayersModel is not null)
                await PlayerLocalCache.SetPlayersByTeamCache(GameModel.Game.AwayTeam.Id.ToString(), AwayPlayersModel);

            HomePlayersModel = await PlayerLocalCache.GetPlayersByTeamCache(GameModel.Game.HomeTeam.Id.ToString())
                               ?? await PlayerService.GetPlayersByTeam(GameModel.Game.HomeTeam.Id);
            if (HomePlayersModel is not null)
                await PlayerLocalCache.SetPlayersByTeamCache(GameModel.Game.HomeTeam.Id.ToString(), HomePlayersModel);

            AwayPlayerStatsModel = await StatsLocalCache.GetBasketballStatsByTeamCache(GameModel.Game.AwayTeam.Id.ToString())
                                   ?? await StatsService.GetBasketballStatsByTeam(GameModel.Game.HomeTeam.Id);

            if (AwayPlayerStatsModel is not null)
                await StatsLocalCache.SetBasketballStatsByTeamCache(GameModel.Game.AwayTeam.Id.ToString(), AwayPlayerStatsModel);

            HomePlayerStatsModel = await StatsLocalCache.GetBasketballStatsByTeamCache(GameModel.Game.HomeTeam.Id.ToString())
                                   ?? await StatsService.GetBasketballStatsByTeam(GameModel.Game.HomeTeam.Id);

            if (HomePlayerStatsModel is not null)
                await StatsLocalCache.SetBasketballStatsByTeamCache(GameModel.Game.HomeTeam.Id.ToString(), HomePlayerStatsModel);

            await GetImageAsync();

            foreach (var player in AwayPlayersModel.Players)
            {
                var playerStat = AwayPlayerStatsModel.BasketballStats.FirstOrDefault(x => x.PlayerId == player.Id && x.GameId == GameModel.Game.Id);
                if (playerStat is not null)
                {
                    Model.Add(new BasketballGameStatsModel(GameModel.Game.LeagueId, player.TeamId, player.Id, GameModel.Game.SeasonId, GameModel.Game.Id, player.FirstName, player.LastName,
                                                        playerStat.Stats.Start, playerStat.Stats.Minutes, playerStat.Stats.Points, playerStat.Stats.FieldGoalsMade, playerStat.Stats.FieldGoalsAttempted, playerStat.Stats.ThreePointersMade, playerStat.Stats.ThreePointersAttempted,
                                                        playerStat.Stats.FreeThrowsMade, playerStat.Stats.FreeThrowsAttempted, playerStat.Stats.Rebounds, playerStat.Stats.Assists, playerStat.Stats.Steals,
                                                        playerStat.Stats.Blocks, playerStat.Stats.Turnovers, playerStat.Stats.Fouls));

                    AwayTotals.Points += playerStat.Stats.Points;
                    AwayTotals.FieldGoalsMade += playerStat.Stats.FieldGoalsMade;
                    AwayTotals.FieldGoalsAttempted += playerStat.Stats.FieldGoalsAttempted;
                    AwayTotals.ThreePointersMade += playerStat.Stats.ThreePointersMade;
                    AwayTotals.ThreePointersAttempted += playerStat.Stats.ThreePointersAttempted;
                    AwayTotals.FreeThrowsMade += playerStat.Stats.FreeThrowsMade;
                    AwayTotals.FreeThrowsAttempted += playerStat.Stats.FreeThrowsAttempted;
                    AwayTotals.Rebounds += playerStat.Stats.Rebounds;
                    AwayTotals.Assists += playerStat.Stats.Assists;
                    AwayTotals.Steals += playerStat.Stats.Steals;
                    AwayTotals.Blocks += playerStat.Stats.Blocks;
                    AwayTotals.Turnovers += playerStat.Stats.Turnovers;
                    AwayTotals.Fouls += playerStat.Stats.Fouls;
                }
                else if (GameModel.Game.GameStatus == GameStatus.Completed)
                    Model.Add(new BasketballGameStatsModel(GameModel.Game.LeagueId, player.TeamId, player.Id, GameModel.Game.SeasonId, GameModel.Game.Id, player.FirstName, player.LastName));
            }
            foreach (var player in HomePlayersModel.Players)
            {
                var playerStat = HomePlayerStatsModel.BasketballStats.FirstOrDefault(x => x.PlayerId == player.Id && x.GameId == GameModel.Game.Id);
                if (playerStat is not null)
                {
                    Model.Add(new BasketballGameStatsModel(GameModel.Game.LeagueId, player.TeamId, player.Id, GameModel.Game.SeasonId, GameModel.Game.Id, player.FirstName, player.LastName,
                                                        playerStat.Stats.Start, playerStat.Stats.Minutes, playerStat.Stats.Points, playerStat.Stats.FieldGoalsMade, playerStat.Stats.FieldGoalsAttempted, playerStat.Stats.ThreePointersMade, playerStat.Stats.ThreePointersAttempted,
                                                        playerStat.Stats.FreeThrowsMade, playerStat.Stats.FreeThrowsAttempted, playerStat.Stats.Rebounds, playerStat.Stats.Assists, playerStat.Stats.Steals,
                                                        playerStat.Stats.Blocks, playerStat.Stats.Turnovers, playerStat.Stats.Fouls));

                    HomeTotals.Points += playerStat.Stats.Points;
                    HomeTotals.FieldGoalsMade += playerStat.Stats.FieldGoalsMade;
                    HomeTotals.FieldGoalsAttempted += playerStat.Stats.FieldGoalsAttempted;
                    HomeTotals.ThreePointersMade += playerStat.Stats.ThreePointersMade;
                    HomeTotals.ThreePointersAttempted += playerStat.Stats.ThreePointersAttempted;
                    HomeTotals.FreeThrowsMade += playerStat.Stats.FreeThrowsMade;
                    HomeTotals.FreeThrowsAttempted += playerStat.Stats.FreeThrowsAttempted;
                    HomeTotals.Rebounds += playerStat.Stats.Rebounds;
                    HomeTotals.Assists += playerStat.Stats.Assists;
                    HomeTotals.Steals += playerStat.Stats.Steals;
                    HomeTotals.Blocks += playerStat.Stats.Blocks;
                    HomeTotals.Turnovers += playerStat.Stats.Turnovers;
                    HomeTotals.Fouls += playerStat.Stats.Fouls;


                }
                else if (GameModel.Game.GameStatus == GameStatus.Completed)
                    Model.Add(new BasketballGameStatsModel(GameModel.Game.LeagueId, player.TeamId, player.Id, GameModel.Game.SeasonId, GameModel.Game.Id, player.FirstName, player.LastName));
            }
            PageLoad = true;
        }
        catch (Exception ex)
        {
            if (KeycloakTokenService.ShouldForceLogout())
            {
                _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/authRefresh.js");
                await _module.InvokeVoidAsync("logout");
            }
            ErrorState.Message = ex.Message;
            NavManager.NavigateTo("/error");
        }
    }

    private async Task GetImageAsync()
    {
        LeagueByIdResponse = await LeagueLocalCache.GetLeagueByIdCache(GameModel.Game.LeagueId.ToString());
        if(LeagueByIdResponse == null)
        {
            LeagueByIdResponse = await LeagueService.GetLeague(GameModel.Game.LeagueId);
            await LeagueLocalCache.SetLeagueByIdCache(GameModel.Game.LeagueId.ToString(), LeagueByIdResponse);
        }
        AwayTeamByIdResponse = await TeamLocalCache.GetTeamByIdCache(GameModel.Game.AwayTeam.Id.ToString());
        if (AwayTeamByIdResponse == null)
        {
            AwayTeamByIdResponse = await TeamService.GetTeamById(GameModel.Game.AwayTeam.Id);
            await TeamLocalCache.SetTeamByIdCache(GameModel.Game.AwayTeam.Id.ToString(), AwayTeamByIdResponse);
        }
        HomeTeamByIdResponse = await TeamLocalCache.GetTeamByIdCache(GameModel.Game.HomeTeam.Id.ToString());
        if (HomeTeamByIdResponse == null)
        {
            HomeTeamByIdResponse = await TeamService.GetTeamById(GameModel.Game.HomeTeam.Id);
            await TeamLocalCache.SetTeamByIdCache(GameModel.Game.AwayTeam.Id.ToString(), HomeTeamByIdResponse);
        }        
        var awayTeamKeyPath = $"/{LeagueByIdResponse.League.Sport}/{LeagueByIdResponse.League.Name}/teams/{AwayTeamByIdResponse.Team.TeamName}/{AwayTeamByIdResponse.Team.ImageFile}";
        GameModel.Game.AwayTeamImage = await AWSService.GetImage(awayTeamKeyPath);

        var homeTeamKeyPath = $"/{LeagueByIdResponse.League.Sport}/{LeagueByIdResponse.League.Name}/teams/{HomeTeamByIdResponse.Team.TeamName}/{HomeTeamByIdResponse.Team.ImageFile}";
        GameModel.Game.HomeTeamImage = await AWSService.GetImage(homeTeamKeyPath);
    }
}

