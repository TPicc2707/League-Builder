@page "/basketballgamestats/{id}"
@using League.Builder.Web.Server.Services.Cache
@inject IStatsService StatsService
@inject IGameService GameService
@inject ILeagueService LeagueService
@inject ITeamService TeamService
@inject IPlayerService PlayerService
@inject IAWSService AWSService
@inject ISnackbar Snackbar
@inject NavigationManager NavManager
@inject ErrorState ErrorState
@inject KeycloakTokenService KeycloakTokenService
@inject ImageService ImageService
@inject IJSRuntime JsRuntime
@inject IHttpContextAccessor HttpContextAccessor
@inject IGameLocalCacheService GameLocalCache
@inject IPlayerLocalCacheService PlayerLocalCache
@inject IStatsLocalCacheService StatsLocalCache
@inject ILeagueLocalCacheService LeagueLocalCache
@inject ITeamLocalCacheService TeamLocalCache

<AuthorizeView Roles="@String.Concat(Roles.ReadStats, ", ", Roles.ReadGames, ", ", Roles.ReadPlayers)" Context="auth">
    <Authorized>
        @if (PageLoad)
        {
            <TeamHeader Game="GameModel.Game" />
            <MudItem Style="padding-top: 25px;">
                <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Color="Color.Primary" Centered="true" Class="border border-solid" Style="border-color: #000000; padding: 25px;">
                    <MudTabPanel Text="@($"{GameModel.Game.AwayTeam.TeamName} Stats")">
                        <BasketballStatsTable Stats="AwayStats" />
                        <BasketballStatsTotals Totals="AwayTotalsModel" />
                    </MudTabPanel>
                    <MudTabPanel Text="@($"{GameModel.Game.HomeTeam.TeamName} Stats")">
                        <BasketballStatsTable Stats="HomeStats" />
                        <BasketballStatsTotals Totals="HomeTotalsModel" />
                    </MudTabPanel>
                </MudTabs>
            </MudItem>
        }
        else
        {
            <Loading />
        }
    </Authorized>
    <NotAuthorized>
        <MudText>You are not authorized to view this page...</MudText>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter]
    public string Id { get; set; }
    private bool PageLoad = false;
    List<BasketballGameStatsModel> Model = new List<BasketballGameStatsModel>();
    GetGameByIdResponse GameModel { get; set; }
    GetPlayersByTeamResponse AwayPlayersModel { get; set; }
    GetPlayersByTeamResponse HomePlayersModel { get; set; }
    GetBasketballStatsByTeamResponse AwayPlayerStatsModel { get; set; }
    GetBasketballStatsByTeamResponse HomePlayerStatsModel { get; set; }
    GetLeagueByIdResponse LeagueByIdResponse { get; set; }
    GetTeamByIdResponse AwayTeamByIdResponse { get; set; }
    GetTeamByIdResponse HomeTeamByIdResponse { get; set; }
    private IJSObjectReference? _module;

    private TotalAccumulator AwayTotals = new();
    private TotalAccumulator HomeTotals = new();

    private BasketballTotalsModel AwayTotalsModel => new()
    {
        Points = AwayTotals.Points,
        FieldGoalsMade = AwayTotals.FieldGoalsMade,
        FieldGoalsAttempted = AwayTotals.FieldGoalsAttempted,
        ThreePointersMade = AwayTotals.ThreePointersMade,
        ThreePointersAttempted = AwayTotals.ThreePointersAttempted,
        FreeThrowsMade = AwayTotals.FreeThrowsMade,
        FreeThrowsAttempted = AwayTotals.FreeThrowsAttempted,
        Rebounds = AwayTotals.Rebounds,
        Assists = AwayTotals.Assists,
        Steals = AwayTotals.Steals,
        Blocks = AwayTotals.Blocks,
        Turnovers = AwayTotals.Turnovers,
        Fouls = AwayTotals.Fouls
    };

    private BasketballTotalsModel HomeTotalsModel => new()
    {
        Points = HomeTotals.Points,
        FieldGoalsMade = HomeTotals.FieldGoalsMade,
        FieldGoalsAttempted = HomeTotals.FieldGoalsAttempted,
        ThreePointersMade = HomeTotals.ThreePointersMade,
        ThreePointersAttempted = HomeTotals.ThreePointersAttempted,
        FreeThrowsMade = HomeTotals.FreeThrowsMade,
        FreeThrowsAttempted = HomeTotals.FreeThrowsAttempted,
        Rebounds = HomeTotals.Rebounds,
        Assists = HomeTotals.Assists,
        Steals = HomeTotals.Steals,
        Blocks = HomeTotals.Blocks,
        Turnovers = HomeTotals.Turnovers,
        Fouls = HomeTotals.Fouls
    };

    private IEnumerable<BasketballGameStatsModel> AwayStats =>
        Model.Where(x => x.TeamId == GameModel.Game.AwayTeam.Id);

    private IEnumerable<BasketballGameStatsModel> HomeStats =>
        Model.Where(x => x.TeamId == GameModel.Game.HomeTeam.Id);


    protected override async Task OnInitializedAsync()
    {
        try
        {
            var gameId = Guid.Parse(Id);

            GameModel = await DataLoader.GetOrLoad(
                () => GameLocalCache.GetGameByIdCache(Id),
                () => GameService.GetGameById(gameId),
                (g) => GameLocalCache.SetGameByIdCache(Id, g)
            );

            AwayPlayersModel = await DataLoader.GetOrLoad(
                () => PlayerLocalCache.GetPlayersByTeamCache(GameModel.Game.AwayTeam.Id.ToString()),
                () => PlayerService.GetPlayersByTeam(GameModel.Game.AwayTeam.Id),
                (p) => PlayerLocalCache.SetPlayersByTeamCache(GameModel.Game.AwayTeam.Id.ToString(), p)
            );

            HomePlayersModel = await DataLoader.GetOrLoad(
                () => PlayerLocalCache.GetPlayersByTeamCache(GameModel.Game.HomeTeam.Id.ToString()),
                () => PlayerService.GetPlayersByTeam(GameModel.Game.HomeTeam.Id),
                (p) => PlayerLocalCache.SetPlayersByTeamCache(GameModel.Game.HomeTeam.Id.ToString(), p)
            );

            AwayPlayerStatsModel = await DataLoader.GetOrLoad(
                () => StatsLocalCache.GetBasketballStatsByTeamCache(GameModel.Game.AwayTeam.Id.ToString()),
                () => StatsService.GetBasketballStatsByTeam(GameModel.Game.AwayTeam.Id),
                (p) => StatsLocalCache.SetBasketballStatsByTeamCache(GameModel.Game.AwayTeam.Id.ToString(), p)
            );

            AwayPlayerStatsModel = await DataLoader.GetOrLoad(
                () => StatsLocalCache.GetBasketballStatsByTeamCache(GameModel.Game.HomeTeam.Id.ToString()),
                () => StatsService.GetBasketballStatsByTeam(GameModel.Game.HomeTeam.Id),
                (p) => StatsLocalCache.SetBasketballStatsByTeamCache(GameModel.Game.HomeTeam.Id.ToString(), p)
            );

            await GetImageAsync();

            ProcessTeamStats(AwayPlayersModel.Players, AwayPlayerStatsModel, true);
            ProcessTeamStats(HomePlayersModel.Players, HomePlayerStatsModel, false);

            PageLoad = true;
        }
        catch (Exception ex)
        {
            if (KeycloakTokenService.ShouldForceLogout())
            {
                _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/authRefresh.js");
                await _module.InvokeVoidAsync("logout");
            }
            ErrorState.Message = ex.Message;
            NavManager.NavigateTo("/error");
        }
    }

    private void ProcessTeamStats(IEnumerable<PlayerModel> players,
    GetBasketballStatsByTeamResponse stats,
    bool isAway)
    {
        foreach (var player in players)
        {
            var playerStat = stats.BasketballStats.FirstOrDefault(x => x.PlayerId == player.Id && x.GameId == GameModel.Game.Id);
            if (playerStat is not null)
            {
                AddPlayerStats(player, playerStat);
                AccumulateTotals(playerStat, isAway);
            }
            else if (GameModel.Game.GameStatus == GameStatus.Completed)
                Model.Add(new BasketballGameStatsModel(GameModel.Game.LeagueId, player.TeamId, player.Id, GameModel.Game.SeasonId, GameModel.Game.Id, player.FirstName, player.LastName));
        }
    }

    private void AddPlayerStats(
        PlayerModel player,
        Models.Stats.Basketball.BasketballStatsModel playerStat
       )
    {
        Model.Add(new BasketballGameStatsModel(GameModel.Game.LeagueId, player.TeamId, player.Id, GameModel.Game.SeasonId, GameModel.Game.Id, player.FirstName, player.LastName,
                                                        playerStat.Stats.Start, playerStat.Stats.Minutes, playerStat.Stats.Points, playerStat.Stats.FieldGoalsMade, playerStat.Stats.FieldGoalsAttempted, playerStat.Stats.ThreePointersMade, playerStat.Stats.ThreePointersAttempted,
                                                        playerStat.Stats.FreeThrowsMade, playerStat.Stats.FreeThrowsAttempted, playerStat.Stats.Rebounds, playerStat.Stats.Assists, playerStat.Stats.Steals,
                                                        playerStat.Stats.Blocks, playerStat.Stats.Turnovers, playerStat.Stats.Fouls));
    }

    private void AccumulateTotals(Models.Stats.Basketball.BasketballStatsModel playerStat, bool isAway)
    {
        if (isAway)
        {
            AwayTotals.Points += playerStat.Stats.Points;
            AwayTotals.FieldGoalsMade += playerStat.Stats.FieldGoalsMade;
            AwayTotals.FieldGoalsAttempted += playerStat.Stats.FieldGoalsAttempted;
            AwayTotals.ThreePointersMade += playerStat.Stats.ThreePointersMade;
            AwayTotals.ThreePointersAttempted += playerStat.Stats.ThreePointersAttempted;
            AwayTotals.FreeThrowsMade += playerStat.Stats.FreeThrowsMade;
            AwayTotals.FreeThrowsAttempted += playerStat.Stats.FreeThrowsAttempted;
            AwayTotals.Rebounds += playerStat.Stats.Rebounds;
            AwayTotals.Assists += playerStat.Stats.Assists;
            AwayTotals.Steals += playerStat.Stats.Steals;
            AwayTotals.Blocks += playerStat.Stats.Blocks;
            AwayTotals.Turnovers += playerStat.Stats.Turnovers;
            AwayTotals.Fouls += playerStat.Stats.Fouls;
        }
        else
        {
            HomeTotals.Points += playerStat.Stats.Points;
            HomeTotals.FieldGoalsMade += playerStat.Stats.FieldGoalsMade;
            HomeTotals.FieldGoalsAttempted += playerStat.Stats.FieldGoalsAttempted;
            HomeTotals.ThreePointersMade += playerStat.Stats.ThreePointersMade;
            HomeTotals.ThreePointersAttempted += playerStat.Stats.ThreePointersAttempted;
            HomeTotals.FreeThrowsMade += playerStat.Stats.FreeThrowsMade;
            HomeTotals.FreeThrowsAttempted += playerStat.Stats.FreeThrowsAttempted;
            HomeTotals.Rebounds += playerStat.Stats.Rebounds;
            HomeTotals.Assists += playerStat.Stats.Assists;
            HomeTotals.Steals += playerStat.Stats.Steals;
            HomeTotals.Blocks += playerStat.Stats.Blocks;
            HomeTotals.Turnovers += playerStat.Stats.Turnovers;
            HomeTotals.Fouls += playerStat.Stats.Fouls;
        }
    }

  
    private async Task GetImageAsync()
    {
        LeagueByIdResponse = await DataLoader.GetOrLoad(
            () => LeagueLocalCache.GetLeagueByIdCache(GameModel.Game.LeagueId.ToString()),
            () => LeagueService.GetLeague(GameModel.Game.LeagueId),
            (l) => LeagueLocalCache.SetLeagueByIdCache(GameModel.Game.LeagueId.ToString(), l)
        );

        AwayTeamByIdResponse = await DataLoader.GetOrLoad(
            () => TeamLocalCache.GetTeamByIdCache(GameModel.Game.AwayTeam.Id.ToString()),
            () => TeamService.GetTeamById(GameModel.Game.AwayTeam.Id),
            (t) => TeamLocalCache.SetTeamByIdCache(GameModel.Game.AwayTeam.Id.ToString(), t)
        );

        HomeTeamByIdResponse = await DataLoader.GetOrLoad(
            () => TeamLocalCache.GetTeamByIdCache(GameModel.Game.HomeTeam.Id.ToString()),
            () => TeamService.GetTeamById(GameModel.Game.HomeTeam.Id),
            (t) => TeamLocalCache.SetTeamByIdCache(GameModel.Game.HomeTeam.Id.ToString(), t)
        );
        GameModel.Game.AwayTeamImage = await ImageService.GetTeamImageAsync(LeagueByIdResponse.League, AwayTeamByIdResponse.Team);
        GameModel.Game.HomeTeamImage = await ImageService.GetTeamImageAsync(LeagueByIdResponse.League, HomeTeamByIdResponse.Team);
    }
}

