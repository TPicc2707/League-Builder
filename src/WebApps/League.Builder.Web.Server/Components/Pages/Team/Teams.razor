@page "/teams"
@using League.Builder.Web.Server.Services.Cache
@inject NavigationManager NavManager
@inject ILeagueService LeagueService
@inject ITeamService TeamService
@inject IAWSService AWSService
@inject IHttpContextAccessor HttpContextAccessor
@inject ITeamLocalCacheService TeamLocalCache
@inject ILeagueLocalCacheService LeagueLocalCache

<AuthorizeView Roles="@String.Concat(Roles.ReadTeams, ", ", Roles.ReadLeagues)" Context="auth">
    <Authorized>
        @if (PageLoad)
        {
            <MudItem Style="padding-top: 50px;">
                <MudExpansionPanels Class="border border-solid" Style="border-color: #000000">
                    <MudExpansionPanel Expanded="expandSearchPanel">
                        <TitleContent>
                            <MudText Typo="Typo.h5" Align="Align.Center" Style="font-weight:bold">Teams Search</MudText>
                        </TitleContent>
                        <ChildContent>
                            <MudItem>
                                <MudTabs Elevation="2" Centered="true" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6" Color="Color.Primary" Class="border border-solid" Style="border-color: #000000">
                                    <MudTabPanel Text="Search All">
                                        <MudButton OnClick="SearchAll" Variant="Variant.Filled" Class="ml-auto" FullWidth="true" Color="Color.Primary">Search All</MudButton>
                                    </MudTabPanel>
                                    <MudTabPanel Text="Team Name">
                                        <MudStack Row="true">
                                            <MudItem xs="9" md="9" lg="9">
                                                <MudTextField @bind-Value="teamName" Placeholder="Team Name" />
                                            </MudItem>
                                            <MudItem xs="3" md="3" lg="3">
                                                <MudButton Disabled="@(teamName == string.Empty ? true : false)" OnClick="SearchByTeamName" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" Style="width: 200px;">Search</MudButton>
                                            </MudItem>
                                        </MudStack>
                                    </MudTabPanel>
                                </MudTabs>
                            </MudItem>
                        </ChildContent>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            </MudItem>
            @if (Model != null)
            {
                <MudItem Style="padding-top: 25px;">
                    <MudExpansionPanels>
                        <MudExpansionPanel Expanded="true" Class="border border-solid" Style="border-color: #000000">
                            <TitleContent>
                                <MudText Typo="Typo.h5" Align="Align.Center" Style="font-weight:bold">Results</MudText>
                            </TitleContent>
                            <ChildContent>
                                <MudItem>
                                    <MudTable Items="@Model" Hover="true" SortLabel="Sort By" Class="border border-solid" Style="border-color: #000000">
                                        <HeaderContent>
                                            <MudTh Style="font-weight:bold" Class="mud-theme-primary"></MudTh>
                                            <MudTh Style="font-weight:bold" Class="mud-theme-primary"><MudTableSortLabel SortBy="new Func<TeamModel, object>(x => x.TeamName)">Name</MudTableSortLabel></MudTh>
                                            <MudTh Style="font-weight:bold" Class="mud-theme-primary"><MudTableSortLabel SortBy="new Func<TeamModel, object>(x => x.LeagueName)">League</MudTableSortLabel></MudTh>
                                            <MudTh Style="font-weight:bold" Class="mud-theme-primary">Description</MudTh>
                                            <MudTh Style="font-weight:bold" Class="mud-theme-primary"></MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd DataLabel="">
                                                <MudAvatar Size="Size.Small">
                                                    <MudImage Src="@context.Image" Alt="Team Image"></MudImage>
                                                </MudAvatar>
                                            </MudTd>
                                            <MudTd DataLabel="Team Name">
                                                <MudTooltip Text="Team Details" Color="Color.Secondary">
                                                    <MudLink Color="Color.Tertiary" Href="@($"/playersbyteam/{context.Id}")">@context.TeamName</MudLink>
                                                </MudTooltip>
                                             </MudTd>
                                            <MudTd DataLabel="League">@context.LeagueName</MudTd>
                                            <MudTd DataLabel="Description">@context.Description</MudTd>
                                            <MudTd DataLabel="Links">
                                                <AuthorizeView Roles="@Roles.ReadStats" Context="readStatsAuth">
                                                    <AuthorizeView Roles="@Roles.ReadGames" Context="teamGamesAuth">
                                                        <MudTooltip Text="Schedule" Color="Color.Secondary">
                                                            <MudIconButton Icon="@Icons.Material.Filled.CalendarMonth" Color="Color.Tertiary" Edge="Edge.Start" Href="@String.Concat("/teamgames/", context.Id)" />
                                                        </MudTooltip>
                                                    </AuthorizeView>
                                                    <MudTooltip Text="Stats" Color="Color.Secondary">
                                                        @if (context.Sport == SportName.BASEBALL)
                                                        {
                                                            <MudIconButton Icon="@Icons.Material.Filled.QueryStats" Color="Color.Tertiary" Edge="Edge.Start" Href="@String.Concat("/baseballteamstats/", context.Id)" />
                                                        }
                                                        @if (context.Sport == SportName.BASKETBALL)
                                                        {
                                                            <MudIconButton Icon="@Icons.Material.Filled.QueryStats" Color="Color.Tertiary" Edge="Edge.Start" Href="@String.Concat("/basketballteamstats/", context.Id)" />
                                                        }
                                                        @if (context.Sport == SportName.FOOTBALL)
                                                        {
                                                            <MudIconButton Icon="@Icons.Material.Filled.QueryStats" Color="Color.Tertiary" Edge="Edge.Start" Href="@String.Concat("/footballteamstats/", context.Id)" />
                                                        }
                                                    </MudTooltip>
                                                </AuthorizeView>
                                                <AuthorizeView Roles="@Roles.UpdateTeams" Context="updateAuth">
                                                    <MudTooltip Text="Update" Color="Color.Secondary">
                                                        <MudIconButton Icon="@Icons.Material.Filled.Update" Color="Color.Tertiary" Edge="Edge.Start" Href="@String.Concat("/updateteam/", context.Id)" />
                                                    </MudTooltip>
                                                </AuthorizeView>
                                            </MudTd>
                                        </RowTemplate>
                                        <PagerContent>
                                            <MudTablePager />
                                        </PagerContent>
                                    </MudTable>

                                </MudItem>
                            </ChildContent>
                        </MudExpansionPanel>
                    </MudExpansionPanels>
                </MudItem>
            }
            @if (isSearchLoading)
            {
                <Loading />
            }
        }
    </Authorized>
    <NotAuthorized>
        <MudText>You are not authorized to view this page...</MudText>
    </NotAuthorized>
</AuthorizeView>

@code {
    private bool PageLoad = false;
    private string teamName = string.Empty;
    private string prevTeamName = string.Empty;
    private GetTeamsResponse TeamsResponse { get; set; }
    private GetTeamsByNameResponse TeamsByNameResponse { get; set; }
    private GetLeaguesResponse LeaguesResponse { get; set; }
    private List<TeamModel> Model { get; set; }
    private bool expandSearchPanel = true;
    private bool isSearchLoading = false;
    private string sport = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        if (await AuthorizationStatus.IsUserAccessTokenExpired(HttpContextAccessor))
        {
            NavManager.NavigateTo("authentication/logout");
        }
        LeaguesResponse = await LeagueLocalCache.GetLeaguesCache();  //If a league is added need to delete local storage
        if (LeaguesResponse == null)
        {
            LeaguesResponse = await LeagueService.GetLeagues();
            await LeagueLocalCache.SetLeaguesCache(LeaguesResponse);
        }
        PageLoad = true;
    }

    private async Task SearchAll()
    {
        isSearchLoading = true;
        TeamsResponse = await TeamLocalCache.GetTeamsCache();  //If a team is added need to delete local storage
        if (TeamsResponse == null)
        {
            TeamsResponse = await TeamService.GetTeams(0, 1000);
            await TeamLocalCache.SetTeamsCache(TeamsResponse);
        }
        Model = TeamsResponse.Teams.Data.ToList();
        await GetImageAsync();
        expandSearchPanel = false;
        isSearchLoading = false;
    }

    private async Task SearchByTeamName()
    {
        isSearchLoading = true;
        if (prevTeamName == teamName)
        {
            TeamsByNameResponse = await TeamLocalCache.GetTeamsByNameCache();  //If a team is added need to delete local storage
            if (TeamsByNameResponse == null)
            {
                TeamsByNameResponse = await TeamService.GetTeamsByName(teamName);
                await TeamLocalCache.SetTeamsByNameCache(TeamsByNameResponse);
            }
        }
        else
        {
            TeamsByNameResponse = await TeamService.GetTeamsByName(teamName);
            await TeamLocalCache.SetTeamsByNameCache(TeamsByNameResponse);
        }
        Model = TeamsByNameResponse.Teams.ToList();
        await GetImageAsync();
        expandSearchPanel = false;
        isSearchLoading = false;
    }

    private async Task GetImageAsync()
    {
        foreach (var team in Model)
        {
            var league = LeaguesResponse.Leagues.FirstOrDefault(l => l.Id == team.LeagueId);
            team.LeagueName = league.Name;
            team.Sport = league.Sport;
            var keyPath = $"/{league.Sport}/{league.Name}/teams/{team.TeamName}/{team.ImageFile}";
            team.Image = await AWSService.GetImage(keyPath);
        }
    }

}
