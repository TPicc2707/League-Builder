@page "/basketballleaguestatsleaders/{id}"
@using League.Builder.Web.Server.Services.Cache
@inject NavigationManager NavManager
@inject ErrorState ErrorState
@inject ImageService ImageService
@inject ISeasonService SeasonService
@inject IStatsService StatsService
@inject ITeamService TeamService
@inject IPlayerService PlayerService
@inject ILeagueService LeagueService
@inject IHttpContextAccessor HttpContextAccessor
@inject IAWSService AWSService
@inject ISeasonLocalCacheService SeasonLocalCache
@inject ILeagueLocalCacheService LeagueLocalCache
@inject IStatsLocalCacheService StatsLocalCache
@inject ITeamLocalCacheService TeamLocalCache
@inject IPlayerLocalCacheService PlayerLocalCache
@inject IJSRuntime JsRuntime
@inject KeycloakTokenService KeycloakTokenService

<AuthorizeView Roles="@String.Concat(Roles.ReadStats, ", ", Roles.ReadPlayers, ", ", Roles.ReadTeams, ", ", Roles.ReadSeasons, ", ", Roles.ReadLeagues)" Context="auth">
    <Authorized>
        @if (PageLoad)
        {
            <MudItem Style="padding-top: 25px; padding-bottom: 25px;">
                <MudExpansionPanels>
                    <MudExpansionPanel Expanded="expandSearchPanel" Class="border border-solid stat-border" Style="border-color: #000000">
                        <TitleContent>
                            <MudText Typo="Typo.h5" Align="Align.Center" Style="font-weight:bold">@Season.Year Stat Leaders</MudText>
                        </TitleContent>
                        <ChildContent>
                            <MudStack Row="true">
                                <MudItem xs="8" md="8" lg="8">
                                    <MudSelect @bind-Value="seasonValue" Placeholder="@placeholder" Label="@placeholder">
                                        @foreach (var season in SeasonsModel.Seasons)
                                        {
                                            <MudSelectItem Value="season.Year">@season.Year</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="4" md="4" lg="4" Style="align-content: center; padding: 10px;">
                                    <MudButton Disabled="@(seasonValue <= 0 ? true : false)" OnClick="GetSeasonStatLeaders" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" Style="width: 200px;">Search</MudButton>
                                </MudItem>
                            </MudStack>
                        </ChildContent>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            </MudItem>

            <MudItem>
                <MudPaper Elevation="2" Class="border border-solid stat-border" Style="border-color: #000000;">
                    <BasketballStatsLeadersTable Leaders="@StatLeaders" />
                </MudPaper>
            </MudItem>
        }
        else
        {
            <Loading />
        }
    </Authorized>
    <NotAuthorized>
        <MudText>You are not authorized to view this page...</MudText>
    </NotAuthorized>
</AuthorizeView>
@code {
    [Parameter]
    public string Id { get; set; }
    private bool PageLoad = false;
    private SeasonModel Season;
    private List<BasketballStatLeaderModel> StatLeaders = new List<BasketballStatLeaderModel>();
    private string placeholder = "Season";
    private int seasonValue;
    private bool expandSearchPanel = false;
    private IJSObjectReference? _module;
    private GetPlayerByIdResponse PlayerModel { get; set; }
    private GetTeamByIdResponse TeamModel { get; set; }
    private GetLeagueByIdResponse LeagueModel { get; set; }
    private GetLeagueBasketballStatsBySeasonResponse StatsModel { get; set; }
    private GetSeasonsResponse SeasonsModel { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            SeasonsModel = await DataLoader.GetOrLoad(
                () => SeasonLocalCache.GetSeasonsCache(),
                () => SeasonService.GetSeasons(),
                (s) => SeasonLocalCache.SetSeasonsCache(s)
            );
            Season = SeasonsModel.Seasons.First();
            seasonValue = Season.Year;

            var leagueId = Guid.Parse(Id);
            LeagueModel = await DataLoader.GetOrLoad(
                () => LeagueLocalCache.GetLeagueByIdCache(Id),
                () => LeagueService.GetLeague(leagueId),
                (l) => LeagueLocalCache.SetLeagueByIdCache(Id, l)
            );
            await CreateStatsLeadersByLeague(leagueId);
            seasonValue = Season.Year;
            PageLoad = true;

        }
        catch (Exception ex)
        {
            if (KeycloakTokenService.ShouldForceLogout())
            {
                _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/authRefresh.js");
                await _module.InvokeVoidAsync("logout");
            }
            ErrorState.Message = ex.Message;
            NavManager.NavigateTo("/error");
        }
    }

    private async Task CreateStatsLeadersByLeague(Guid leagueId)
    {
        StatsModel = await DataLoader.GetOrLoad(
            () => StatsLocalCache.GetLeagueBasketballStatsBySeasonCache(leagueId.ToString(), Season.Id.ToString()),
            () => StatsService.GetLeagueBasketballStatsBySeason(leagueId, Season.Id),
            (s) => StatsLocalCache.SetLeagueBasketballStatsBySeasonCache(leagueId.ToString(), Season.Id.ToString(), s)
        );
        await BuildStatLeaders();
    }


    public async Task GetSeasonStatLeaders()
    {
        PageLoad = false;
        Season = SeasonsModel.Seasons.FirstOrDefault(s => s.Year == seasonValue);

        StatsModel = await DataLoader.GetOrLoad(
            () => StatsLocalCache.GetLeagueBasketballStatsBySeasonCache(LeagueModel.League.Id.ToString(), Season.Id.ToString()),
            () => StatsService.GetLeagueBasketballStatsBySeason(LeagueModel.League.Id, Season.Id),
            (s) => StatsLocalCache.SetLeagueBasketballStatsBySeasonCache(LeagueModel.League.Id.ToString(), Season.Id.ToString(), s)
        );

        await BuildStatLeaders();
        PageLoad = true;
    }

    private async Task GetImageAsync(BasketballStatLeaderModel stat)
        => stat.Image = await ImageService.GetPlayerImageAsync(LeagueModel.League, TeamModel.Team, PlayerModel.Player);

    private async Task BuildStatLeaders()
    {
        StatLeaders.Clear();

        foreach (var stat in StatsModel.BasketballStats)
        {
            var leader = StatLeaders.FirstOrDefault(s => s.PlayerId == stat.PlayerId);

            if (leader is null)
            {
                PlayerModel = await DataLoader.GetOrLoad(
                    () => PlayerLocalCache.GetPlayerByIdCache(stat.PlayerId.ToString()),
                    () => PlayerService.GetPlayerById(stat.PlayerId),
                    (p) => PlayerLocalCache.SetPlayerByIdCache(p, stat.PlayerId.ToString())
                );

                TeamModel = await DataLoader.GetOrLoad(
                    () => TeamLocalCache.GetTeamByIdCache(stat.TeamId.ToString()),
                    () => TeamService.GetTeamById(stat.TeamId),
                    (t) => TeamLocalCache.SetTeamByIdCache(stat.TeamId.ToString(), t)
                );

                leader = CreateLeader(stat);
                await GetImageAsync(leader);
                StatLeaders.Add(leader);
            }
            else
                UpdateLeader(leader, stat);
        }
    }

    private BasketballStatLeaderModel CreateLeader(BasketballStatsModel stat)
    {
        var s = stat.Stats;

        var leader = new BasketballStatLeaderModel
        {
            PlayerId = PlayerModel.Player.Id,
            PlayerName = $"{PlayerModel.Player.FirstName} {PlayerModel.Player.LastName}",
            Team = TeamModel.Team.TeamName,

            GamesPlayed = s.Minutes > 0 ? 1 : 0,
            Starts = s.Start ? 1 : 0,
            Minutes = s.Minutes,

            Points = s.Points,
            FieldGoalsMade = s.FieldGoalsMade,
            FieldGoalsAttempted = s.FieldGoalsAttempted,
            FieldGoalPercentage = SafePct(s.FieldGoalsMade, s.FieldGoalsAttempted),

            ThreePointersMade = s.ThreePointersMade,
            ThreePointersAttempted = s.ThreePointersAttempted,
            ThreePointerPercentage = SafePct(s.ThreePointersMade, s.ThreePointersAttempted),

            FreeThrowsMade = s.FreeThrowsMade,
            FreeThrowsAttempted = s.FreeThrowsAttempted,
            FreeThrowPercentage = SafePct(s.FreeThrowsMade, s.FreeThrowsAttempted),

            Rebounds = s.Rebounds,
            Assists = s.Assists,
            Steals = s.Steals,
            Blocks = s.Blocks,
            Turnovers = s.Turnovers

        };

        ComputePerGame(leader);
        return leader;
    }

    private void UpdateLeader(BasketballStatLeaderModel leader, BasketballStatsModel stat)
    {
        var s = stat.Stats;

        leader.GamesPlayed += s.Minutes > 0 ? 1 : 0;
        leader.Starts += s.Start ? 1 : 0;
        leader.Minutes += s.Minutes;

        leader.Points += s.Points;
        leader.FieldGoalsMade += s.FieldGoalsMade;
        leader.FieldGoalsAttempted += s.FieldGoalsAttempted;
        leader.FieldGoalPercentage = SafePct(leader.FieldGoalsMade, leader.FieldGoalsAttempted);

        leader.ThreePointersMade += s.ThreePointersMade;
        leader.ThreePointersAttempted += s.ThreePointersAttempted;
        leader.ThreePointerPercentage = SafePct(leader.ThreePointersMade, leader.ThreePointersAttempted);

        leader.FreeThrowsMade += s.FreeThrowsMade;
        leader.FreeThrowsAttempted += s.FreeThrowsAttempted;
        leader.FreeThrowPercentage = SafePct(leader.FreeThrowsMade, leader.FreeThrowsAttempted);

        leader.Rebounds += s.Rebounds;
        leader.Assists += s.Assists;
        leader.Steals += s.Steals;
        leader.Blocks += s.Blocks;
        leader.Turnovers += s.Turnovers;

        ComputePerGame(leader);
    }

    private void ComputePerGame(BasketballStatLeaderModel l)
    {
        l.PointsPerGame = SafePerGame(l.Points, l.GamesPlayed);
        l.ReboundsPerGame = SafePerGame(l.Rebounds, l.GamesPlayed);
        l.AssistsPerGame = SafePerGame(l.Assists, l.GamesPlayed);
        l.StealsPerGame = SafePerGame(l.Blocks, l.GamesPlayed);
        l.BlocksPerGame = SafePerGame(l.Turnovers, l.GamesPlayed);
        l.TurnoversPerGame = SafePerGame(l.Turnovers, l.GamesPlayed);

        l.FieldGoalsMadePerGame = SafePerGame(l.FieldGoalsMade, l.GamesPlayed);
        l.FieldGoalsAttemptedPerGame = SafePerGame(l.FieldGoalsAttempted, l.GamesPlayed);

        l.ThreePointersMadePerGame = SafePerGame(l.ThreePointersMade, l.GamesPlayed);
        l.ThreePointersAttemptedPerGame = SafePerGame(l.ThreePointersAttempted, l.GamesPlayed);

        l.FreeThrowsMadePerGame = SafePerGame(l.FreeThrowsMade, l.GamesPlayed);
        l.FreeThrowsAttemptedPerGame = SafePerGame(l.FreeThrowsAttempted, l.GamesPlayed);
    }

    private decimal SafePct(int made, int attempted) =>
        attempted == 0 ? 0 : (decimal)made / attempted * 100;

    private decimal SafePerGame(int total, int games) =>
        games == 0 ? 0 : (decimal)total / games * 100;

}
