@page "/baseballleaguestatsleaders/{id}"
@using League.Builder.Web.Server.Services.Cache
@inject NavigationManager NavManager
@inject ErrorState ErrorState
@inject ISeasonService SeasonService
@inject IStatsService StatsService
@inject ITeamService TeamService
@inject IPlayerService PlayerService
@inject ILeagueService LeagueService
@inject ImageService ImageService
@inject IHttpContextAccessor HttpContextAccessor
@inject IAWSService AWSService
@inject ISeasonLocalCacheService SeasonLocalCache
@inject ILeagueLocalCacheService LeagueLocalCache
@inject IStatsLocalCacheService StatsLocalCache
@inject ITeamLocalCacheService TeamLocalCache
@inject IPlayerLocalCacheService PlayerLocalCache
@inject IJSRuntime JsRuntime
@inject KeycloakTokenService KeycloakTokenService


<AuthorizeView Roles="@String.Concat(Roles.ReadStats, ", ", Roles.ReadPlayers, ", ", Roles.ReadTeams, ", ", Roles.ReadSeasons, ", ", Roles.ReadLeagues)" Context="auth">
    <Authorized>
        @if (PageLoad)
        {
            <MudItem Style="padding-top: 25px; padding-bottom: 25px;">
                <MudExpansionPanels>
                    <MudExpansionPanel Expanded="expandSearchPanel" Class="border border-solid stat-border" Style="border-color: #000000">
                        <TitleContent>
                            <MudText Typo="Typo.h5" Align="Align.Center" Class="stat-header">@Season.Year Stat Leaders</MudText>
                        </TitleContent>
                        <ChildContent>
                            <MudStack Row="true">
                                <MudItem xs="8" md="8" lg="8">
                                    <MudSelect @bind-Value="seasonValue" Placeholder="@placeholder" Label="@placeholder">
                                        @foreach (var season in SeasonsModel.Seasons)
                                        {
                                            <MudSelectItem Value="@season.Year">@season.Year</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="4" md="4" lg="4" Style="align-content: center; padding: 10px;">
                                    <MudButton Disabled="@(seasonValue <= 0 ? true : false)" OnClick="GetSeasonStatLeaders" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" Style="width: 200px;">Search</MudButton>
                                </MudItem>
                            </MudStack>
                        </ChildContent>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            </MudItem>
            <MudItem Class="stat-padding">
                <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Centered="true" Color="Color.Primary" Class="border border-solid stat-border" Style="padding: 25px;">
                    <MudTabPanel Text="Hitting">
                        <BaseballHittingLeadersTable Leaders="@StatLeaders.Where(x => x.Position != PositionFilter.BASEBALL)" />
                    </MudTabPanel>
                    <MudTabPanel Text="Pitching">
                        <BaseballPitchingLeadersTable Leaders="@StatLeaders.Where(x => x.Position == PositionFilter.BASEBALL)" />
                    </MudTabPanel>
                </MudTabs>
            </MudItem> 
        }
        else
        {
            <Loading />
        }
    </Authorized>
    <NotAuthorized>
        <MudText>You are not authorized to view this page...</MudText>
    </NotAuthorized>
</AuthorizeView>
@code {
    [Parameter]
    public string Id { get; set; }
    private bool PageLoad = false;
    private Justify _justify = Justify.SpaceEvenly;
    private SeasonModel Season;
    private List<BaseballStatLeaderModel> StatLeaders = new List<BaseballStatLeaderModel>();
    private string placeholder = "Season";
    private int seasonValue;
    private bool expandSearchPanel = false;
    private IJSObjectReference? _module;
    private GetPlayerByIdResponse PlayerModel { get; set; }
    private GetTeamByIdResponse TeamModel { get; set; }
    private GetLeagueByIdResponse LeagueModel { get; set; }
    private GetLeagueBaseballStatsBySeasonResponse StatsModel { get; set; }
    private GetSeasonsResponse SeasonsModel { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            SeasonsModel = await DataLoader.GetOrLoad(
                () => SeasonLocalCache.GetSeasonsCache(),
                () => SeasonService.GetSeasons(),
                (s) => SeasonLocalCache.SetSeasonsCache(s)
            );
            Season = SeasonsModel.Seasons.First();
            seasonValue = Season.Year;

            var leagueId = Guid.Parse(Id);
            LeagueModel = await DataLoader.GetOrLoad(
                () => LeagueLocalCache.GetLeagueByIdCache(Id),
                () => LeagueService.GetLeague(leagueId),
                (l) => LeagueLocalCache.SetLeagueByIdCache(Id, l)
            );

            await CreateStatsLeadersByLeague(leagueId);
            PageLoad = true;
        }
        catch (Exception ex)
        {
            if (KeycloakTokenService.ShouldForceLogout())
            {
                _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/authRefresh.js");
                await _module.InvokeVoidAsync("logout");
            }
            ErrorState.Message = ex.Message;
            NavManager.NavigateTo("/error");
        }
    }

    private async Task CreateStatsLeadersByLeague(Guid leagueId)
    {
        StatsModel = await DataLoader.GetOrLoad(
            () => StatsLocalCache.GetLeagueBaseballStatsBySeasonCache(leagueId.ToString(), Season.Id.ToString()),
            () => StatsService.GetLeagueBaseballStatsBySeason(leagueId, Season.Id),
            (s) => StatsLocalCache.SetLeagueBaseballStatsBySeasonCache(leagueId.ToString(), Season.Id.ToString(), s)
        );
        await BuildStatLeaders();
    }


    public async Task GetSeasonStatLeaders()
    {
        PageLoad = false;
        Season = SeasonsModel.Seasons.FirstOrDefault(s => s.Year == seasonValue);

        StatsModel = await DataLoader.GetOrLoad(
            () => StatsLocalCache.GetLeagueBaseballStatsBySeasonCache(LeagueModel.League.Id.ToString(), Season.Id.ToString()),
            () => StatsService.GetLeagueBaseballStatsBySeason(LeagueModel.League.Id, Season.Id),
            (s) => StatsLocalCache.SetLeagueBaseballStatsBySeasonCache(LeagueModel.League.Id.ToString(), Season.Id.ToString(), s)
        );

        await BuildStatLeaders();
        PageLoad = true;
    }

    private async Task GetImageAsync(BaseballStatLeaderModel stat)
        => stat.Image = await ImageService.GetPlayerImageAsync(LeagueModel.League, TeamModel.Team, PlayerModel.Player);

    private async Task BuildStatLeaders()
    {
        StatLeaders.Clear();

        foreach (var stat in StatsModel.BaseballStats)
        {
            var leader = StatLeaders.FirstOrDefault(s => s.PlayerId == stat.PlayerId);
            if (leader is null)
            {
                PlayerModel = await DataLoader.GetOrLoad(
                    () => PlayerLocalCache.GetPlayerByIdCache(stat.PlayerId.ToString()),
                    () => PlayerService.GetPlayerById(stat.PlayerId),
                    (p) => PlayerLocalCache.SetPlayerByIdCache(p, stat.PlayerId.ToString())
                );

                TeamModel = await DataLoader.GetOrLoad(
                    () => TeamLocalCache.GetTeamByIdCache(stat.TeamId.ToString()),
                    () => TeamService.GetTeamById(stat.TeamId),
                    (t) => TeamLocalCache.SetTeamByIdCache(stat.TeamId.ToString(), t)
                );
                leader = CreateLeader(stat);
                await GetImageAsync(leader);
                StatLeaders.Add(leader);
            }
            else
            {
                UpdateLeader(leader, stat);
            }
        }
    }

    private BaseballStatLeaderModel CreateLeader(BaseballStatsModel stat)
    {
        var h = stat.HittingStats;
        var p = stat.PitchingStats;

        var obp = SafeOBP(h.Hits, h.Walks, h.HitByPitch, h.SacrificeFly);
        var slg = SafeSlugging(h.TotalBases, h.AtBats);

        return new BaseballStatLeaderModel
        {
            PlayerId = PlayerModel.Player.Id,
            PlayerName = String.Concat(PlayerModel.Player.FirstName, " ", PlayerModel.Player.LastName),
            Position = PlayerModel.Player.PlayerDetail.Position,
            Team = TeamModel.Team.TeamName,

            AtBats = h.AtBats,
            Hits = h.Hits,
            Runs = h.Runs,
            Average = SafeAvg(h.Hits, h.AtBats),
            RunsBattedIn = h.RunsBattedIn,
            Doubles = h.Doubles,
            Triples = h.Triples,
            HomeRuns = h.HomeRuns,
            TotalBases = h.TotalBases,
            Slugging = slg,
            StolenBases = h.StolenBases,
            Strikeouts = h.Strikeouts,
            Walks = h.Walks,
            HitByPitch = h.HitByPitch,
            SacrificeFly = h.SacrificeFly,
            OnBasePercentage = obp,
            OnBasePlusSlugging = SafeOPS(obp, slg),

            PitchingStarts = p.Start ? 1 : 0,
            PitchingWins = p.Wins,
            PitchingLosses = p.Losses,
            InningsPitched = p.Innings,
            HitsAllowed = p.HitsAllowed,
            RunsAllowed = p.Runs,
            WalksAllowed = p.WalksAllowed,
            PitchingStrikeouts = p.PitchingStrikeouts,
            Saves = p.Saves,
            EarnedRunAverage = SafeERA(p.Runs, p.Innings),
            WalksHitsPerInning = SafeWHIP(p.WalksAllowed, p.HitsAllowed, p.Innings),
            GamesPlayed = h.AtBats > 0 || p.Innings > 0 ? 1 : 0
        };
    }

    private void UpdateLeader(BaseballStatLeaderModel leader, BaseballStatsModel stat)
    {
        var h = stat.HittingStats;
        var p = stat.PitchingStats;

        leader.AtBats += h.AtBats;
        leader.Hits += h.Hits;
        leader.Runs += h.Runs;
        leader.Average = SafeAvg(leader.Hits, leader.AtBats);
        leader.RunsBattedIn += h.RunsBattedIn;
        leader.Doubles += h.Doubles;
        leader.Triples += h.Triples;
        leader.HomeRuns += h.HomeRuns;
        leader.TotalBases += h.TotalBases;
        leader.Slugging = SafeSlugging(leader.TotalBases, leader.AtBats);
        leader.StolenBases += h.StolenBases;
        leader.Strikeouts += h.Strikeouts;
        leader.Walks += h.Walks;
        leader.HitByPitch += h.HitByPitch;
        leader.SacrificeFly += h.SacrificeFly;
        leader.OnBasePercentage = SafeOBP(leader.Hits, leader.Walks, leader.HitByPitch, leader.SacrificeFly);
        leader.OnBasePlusSlugging = SafeOPS(leader.OnBasePercentage, leader.Slugging);

        leader.PitchingStarts += p.Start ? 1 : 0;
        leader.PitchingWins += p.Wins;
        leader.PitchingLosses += p.Losses;
        leader.InningsPitched = DataLoader.AddInnings(leader.InningsPitched, p.Innings);
        leader.HitsAllowed += p.HitsAllowed;
        leader.RunsAllowed += p.Runs;
        leader.WalksAllowed += p.WalksAllowed;
        leader.PitchingStrikeouts += p.PitchingStrikeouts;
        leader.Saves += p.Saves;
        leader.EarnedRunAverage = SafeERA(p.Runs, leader.InningsPitched);
        leader.WalksHitsPerInning = SafeWHIP(leader.WalksAllowed, leader.HitsAllowed, leader.InningsPitched);
        leader.GamesPlayed += h.AtBats > 0 || p.Innings > 0 ? 1 : 0;

    }

    private decimal SafeAvg(int numerator, int denominator) =>
        denominator == 0 ? 0 : (decimal)numerator / denominator;

    private decimal SafeSlugging(int totalBases, int atBats) =>
        atBats == 0 ? 0 : (decimal)totalBases / atBats;

    private decimal SafeOBP(int hits, int walks, int hbp, int sf)
    {
        var num = hits + walks + hbp;
        var den = num + sf;
        return den == 0 ? 0 : (decimal)num / den;
    }

    private decimal SafeOPS(decimal obp, decimal slg) => obp + slg;

    private decimal SafeERA(int runs, decimal innings) =>
        innings == 0 ? 0 : (decimal)runs / innings * 9;

    private decimal SafeWHIP(int walks, int hits, decimal innings) =>
        innings == 0 ? 0 : (decimal)(walks + hits) / innings;

}
