@page "/playoffs/{id}"
@using League.Builder.Web.Server.Services.Cache
@inject IStandingsService StandingsService
@inject ISeasonService SeasonService
@inject ITeamService TeamService
@inject NavigationManager NavManager
@inject IHttpContextAccessor HttpContextAccessor
@inject ILeagueService LeagueService
@inject IAWSService AWSService
@inject ILeagueLocalCacheService LeagueLocalCache
@inject ITeamLocalCacheService TeamLocalCache
@inject ISeasonLocalCacheService SeasonLocalCache
@inject IStandingsLocalCacheService StandingsLocalCache


<AuthorizeView Roles="@String.Concat(Roles.ReadStandings, ", ", Roles.ReadSeasons, ", ", Roles.ReadGames)" Context="auth">
    <Authorized>
        @if (PageLoad)
        {
            <MudItem Style="padding-top: 50px;">
                <MudPaper Class="border border-solid" Style="border-color: #000000; padding: 25px;">
                    <MudText Typo="Typo.h4" Align="Align.Center" Style="font-weight:bold">@Season.Year Playoffs</MudText>
                </MudPaper>
            </MudItem>

            @if(LeagueModel.League.TotalPlayoffTeams == PlayoffTeams.TwoTeams)
            {
                <TwoTeamPlayoff Standings="Standings" />
            }

            @if (LeagueModel.League.TotalPlayoffTeams == PlayoffTeams.FourTeams)
            {
                <FourTeamPlayoff Standings="Standings" />
            }

            @if (LeagueModel.League.TotalPlayoffTeams == PlayoffTeams.EightTeams)
            {
                <EightTeamPlayoff Standings="Standings" />
            }
        }
        else
        {
            <Loading />    
        }
    </Authorized>
    <NotAuthorized>
        <NoAccess />
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter]
    public string Id { get; set; }
    private bool PageLoad = false;
    private SeasonModel Season;
    private GetSeasonsResponse SeasonsModel { get; set; }
    private IEnumerable<StandingsModel> Standings;

    private GetSeasonByYearResponse SeasonModel { get; set; }
    private GetStandingsByLeagueResponse Model { get; set; }
    private GetLeagueByIdResponse LeagueModel { get; set; }
    private GetTeamByIdResponse TeamByIdResponse { get; set; }


    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (await AuthorizationStatus.IsUserAccessTokenExpired(HttpContextAccessor))
            {
                NavManager.NavigateTo("authentication/logout");
            }

            var leagueId = Guid.Parse(Id);
            SeasonsModel = await SeasonLocalCache.GetSeasonsCache();
            if (SeasonsModel == null)
            {
                SeasonsModel = await SeasonService.GetSeasons();
                await SeasonLocalCache.SetSeasonsCache(SeasonsModel);
            }
            Season = SeasonsModel.Seasons.First();
            Model = await StandingsLocalCache.GetStandingsByLeagueCache(Id);
            if (Model == null)
            {
                Model = await StandingsService.GetStandingsByLeague(leagueId);
                await StandingsLocalCache.SetStandingsByLeagueCache(Id, Model);
            }
            Standings = Model.Standings.Where(x => x.SeasonId == Season.Id);
            LeagueModel = await LeagueLocalCache.GetLeagueByIdCache(Id);
            if (LeagueModel == null)
            {
                LeagueModel = await LeagueService.GetLeague(leagueId);
                await LeagueLocalCache.SetLeagueByIdCache(Id, LeagueModel);
            }
            await GetImageAsync();
            CalculatePlayoffTeams();
            Standings = Standings.Where(x => x.SeasonId == Season.Id && x.StandingsDetail.PlayoffTeam == true).OrderByDescending(x => x.WinPercentage);
            PageLoad = true;

        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            NavManager.NavigateTo("/error");
        }
    }


    private async Task GetImageAsync()
    {
        foreach (var standing in Model.Standings)
        {
            standing.WinPercentage = standing.StandingsDetail.Wins != 0 | standing.StandingsDetail.GamesPlayed != 0 ? (decimal)standing.StandingsDetail.Wins / standing.StandingsDetail.GamesPlayed : 0;
            TeamByIdResponse = await TeamLocalCache.GetTeamByIdCache(standing.Team.Id.ToString());
            if(TeamByIdResponse == null)
            {
                TeamByIdResponse = await TeamService.GetTeamById(standing.Team.Id);
                await TeamLocalCache.SetTeamByIdCache(standing.Team.Id.ToString(), TeamByIdResponse);
            }
            var keyPath = $"/{LeagueModel.League.Sport}/{LeagueModel.League.Name}/teams/{TeamByIdResponse.Team.TeamName}/{TeamByIdResponse.Team.ImageFile}";
            standing.TeamImage = await AWSService.GetImage(keyPath);
        }
    }

    private void CalculatePlayoffTeams()
    {
        var playoffTeams = Model.Standings.Where(x => x.SeasonId == Season.Id).OrderByDescending(x => x.WinPercentage).Take(LeagueModel.League.TotalPlayoffTeams);

        foreach (var playoffTeam in playoffTeams)
            playoffTeam.ProjectedPlayoffTeam = true;
    }
}
