@page "/playoffs/{id}"
@using League.Builder.Web.Server.Services.Cache
@inject IStandingsService StandingsService
@inject ISeasonService SeasonService
@inject ITeamService TeamService
@inject NavigationManager NavManager
@inject ErrorState ErrorState
@inject IHttpContextAccessor HttpContextAccessor
@inject ILeagueService LeagueService
@inject IAWSService AWSService
@inject ILeagueLocalCacheService LeagueLocalCache
@inject ITeamLocalCacheService TeamLocalCache
@inject ISeasonLocalCacheService SeasonLocalCache
@inject IStandingsLocalCacheService StandingsLocalCache
@inject IJSRuntime JsRuntime
@inject KeycloakTokenService KeycloakTokenService
@inject ImageService ImageService


<AuthorizeView Roles="@String.Concat(Roles.ReadStandings, ", ", Roles.ReadSeasons, ", ", Roles.ReadGames)" Context="auth">
    <Authorized>
        @if (PageLoad)
        {
            <MudPaper Class="border border-solid" Style="border-color: #000000; margin-top: 50px; padding: 25px;">
                <MudText Typo="Typo.h4" Align="Align.Center" Style="font-weight:bold">
                    @Season.Year Playoffs
                </MudText>
            </MudPaper>

            @switch (LeagueModel.League.TotalPlayoffTeams)
            {
                case PlayoffTeams.TwoTeams:
                    <TwoTeamPlayoff Standings="Standings" />
                    break;
                case PlayoffTeams.FourTeams:
                    <FourTeamPlayoff Standings="Standings" />
                    break;
                case PlayoffTeams.EightTeams:
                    <EightTeamPlayoff Standings="Standings" />
                    break;
                default:
                    <Loading />
                    break;
            }
        }
    </Authorized>
    <NotAuthorized>
        <NoAccess />
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter]
    public string Id { get; set; }
    private bool PageLoad = false;
    private SeasonModel Season;
    private GetSeasonsResponse SeasonsModel { get; set; }
    private IEnumerable<StandingsModel> Standings;
    private IJSObjectReference? _module;
    private GetSeasonByYearResponse SeasonModel { get; set; }
    private GetStandingsByLeagueResponse Model { get; set; }
    private GetLeagueByIdResponse LeagueModel { get; set; }
    private GetTeamByIdResponse TeamByIdResponse { get; set; }


    protected override async Task OnInitializedAsync()
    {
        try
        {
            var leagueId = Guid.Parse(Id);

            SeasonsModel = await DataLoader.GetOrLoad(
                () => SeasonLocalCache.GetSeasonsCache(),
                () => SeasonService.GetSeasons(),
                (s) => SeasonLocalCache.SetSeasonsCache(s)
            );
            Season = SeasonsModel.Seasons.First();

            Model = await DataLoader.GetOrLoad(
                () => StandingsLocalCache.GetStandingsByLeagueCache(Id),
                () => StandingsService.GetStandingsByLeague(leagueId),
                (s) => StandingsLocalCache.SetStandingsByLeagueCache(Id, s)
            );
            Standings = Model.Standings.Where(x => x.SeasonId == Season.Id).ToList();

            foreach (var s in Standings)
            {
                var detail = s.StandingsDetail;
                s.WinPercentage = CalculateWinPercentage(detail.Wins, detail.GamesPlayed);
            }

            LeagueModel = await DataLoader.GetOrLoad(
                () => LeagueLocalCache.GetLeagueByIdCache(Id),
                () => LeagueService.GetLeague(leagueId),
                (l) => LeagueLocalCache.SetLeagueByIdCache(Id, l)
            );

            CalculatePlayoffTeams();

            await GetImageAsync();
            PageLoad = true;
        }
        catch (Exception ex)
        {
            if (KeycloakTokenService.ShouldForceLogout())
            {
                _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/authRefresh.js");
                await _module.InvokeVoidAsync("logout");
            }
            ErrorState.Message = ex.Message;
            NavManager.NavigateTo("/error");
        }
    }


    private async Task GetImageAsync()
    {
        foreach (var standing in Model.Standings)
        {
            TeamByIdResponse = await DataLoader.GetOrLoad(
               () => TeamLocalCache.GetTeamByIdCache(standing.Team.Id.ToString()),
               () => TeamService.GetTeamById(standing.Team.Id),
               (t) => TeamLocalCache.SetTeamByIdCache(standing.Team.Id.ToString(), t)
            );

            standing.TeamImage = await ImageService.GetTeamImageAsync(LeagueModel.League, TeamByIdResponse.Team);
        }
    }

    private void CalculatePlayoffTeams()
    {
        var playoffTeams = Standings.OrderByDescending(x => x.WinPercentage).Take(LeagueModel.League.TotalPlayoffTeams);

        foreach (var playoffTeam in playoffTeams)
            playoffTeam.ProjectedPlayoffTeam = true;
    }

    private static decimal CalculateWinPercentage(int wins, int gamesPlayed)
    {
        return gamesPlayed == 0 ? 0 : (decimal)wins / gamesPlayed;
    }
}
