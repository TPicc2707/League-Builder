@page "/leaguegames/{id}"
@using League.Builder.Web.Server.Components.Pages.Games
@inject IGameService GamesService
@inject ISeasonService SeasonService
@inject ILeagueService LeagueService
@inject ITeamService TeamService
@inject IDialogService DialogService
@inject IAWSService AWSService
@inject NavigationManager NavManager
@inject ErrorState ErrorState
@inject IHttpContextAccessor HttpContextAccessor
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IGameLocalCacheService GameLocalCache
@inject ISeasonLocalCacheService SeasonLocalCache
@inject ILeagueLocalCacheService LeagueLocalCache
@inject ITeamLocalCacheService TeamLocalCache
@inject IJSRuntime JsRuntime
@inject KeycloakTokenService KeycloakTokenService
@inject ImageService ImageService

<AuthorizeView Roles="@String.Concat(Roles.ReadGames, ", ", Roles.ReadSeasons)" Context="auth">
    <Authorized>
        @if (PageLoad)
        {
            <MudItem Class="py-25">
                <MudExpansionPanels>
                    <MudExpansionPanel Expanded="expandSearchPanel" Class="border border-solid" Style="border-color: #000000">
                        <TitleContent>
                            <MudText Typo="Typo.h5" Align="Align.Center" Class="font-bold">@Season.Year Schedule</MudText>
                        </TitleContent>
                        <ChildContent>
                            @SearchPanel
                        </ChildContent>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            </MudItem>
            <MudItem>
                <MudPaper Elevation="2" Class="border border-solid border-black p-25">
                    @GameTable
                </MudPaper>
            </MudItem>
        }
        else
        {
            <Loading />
        }
    </Authorized>
    <NotAuthorized>
        <NoAccess />
    </NotAuthorized>
</AuthorizeView>
@code {
    [Parameter]
    public string Id { get; set; }

    private bool PageLoad = false;
    private SeasonModel Season;
    private string seasonPlaceholder = "Season";
    private string monthPlaceholder = "Month";
    private string dayPlaceholder = "Day";
    private int seasonValue;
    private int monthValue = DateTime.Now.Month;
    private int dayValue = 1;

    private int Month;
    private int Day;

    private bool expandSearchPanel = false;
    private List<int> daysOfMonth;

    private string NavigateEditSportLineup = string.Empty;
    private string NavigateSportLineup = string.Empty;
    private string NavigateEditSportStats = string.Empty;
    private string NavigateSportStats = string.Empty;

    private bool editStats = false;

    private GetLeagueByIdResponse LeagueModel { get; set; }
    private GetSeasonsResponse SeasonsModel { get; set; }
    private GetSeasonByYearResponse SeasonModel { get; set; }
    private GetLeagueGamesByDateResponse LeagueGamesModel { get; set; }

    private IJSObjectReference? _module;
    private Guid LeagueId => Guid.Parse(Id);
    private string CurrentDateString => new DateTime(Season.Year, Month, Day).ToString("yyyy-MM-dd");
    private bool CanCreateGames;
    private bool CanUpdateGames;
    private bool CanReadGames;
    private bool CanReadStats;
    private bool CanUpdateLeagues;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            CanCreateGames = user.IsInRole(Roles.CreateGames);
            CanUpdateGames = user.IsInRole(Roles.UpdateGames);
            CanReadGames = user.IsInRole(Roles.ReadGames);
            CanReadStats = user.IsInRole(Roles.ReadStats);
            CanUpdateLeagues = user.IsInRole(Roles.UpdateLeagues);

            LeagueModel = await DataLoader.GetOrLoad(
                () => LeagueLocalCache.GetLeagueByIdCache(Id),
                () => LeagueService.GetLeague(LeagueId),
                (l) => LeagueLocalCache.SetLeagueByIdCache(Id, l)
            );

            await ConfigureNavigation(LeagueModel.League.Sport);

            SeasonsModel = await DataLoader.GetOrLoad(
                () => SeasonLocalCache.GetSeasonsCache(),
                () => SeasonService.GetSeasons(),
                (s) => SeasonLocalCache.SetSeasonsCache(s)
            );

            Season = SeasonsModel.Seasons.First();
            seasonValue = Season.Year;

            Month = monthValue;
            Day = dayValue;

            await LoadGamesAsync();
            PageLoad = true;

        }
        catch (Exception ex)
        {
            await HandleError(ex);
        }
    }

    private async Task LoadGamesAsync()
    {
        LeagueGamesModel = await GamesService.GetLeagueGamesByDate(LeagueId, CurrentDateString);
        await GetImageAsync();
        AdjustDaysOfMonth(Month);
    }

    private async Task GetSeasonGames()
    {
        try
        {
            PageLoad = false;
            SeasonModel = await DataLoader.GetOrLoad(
                () => SeasonLocalCache.GetSeasonByYearCache(seasonValue),
                () => SeasonService.GetSeasonByYear(seasonValue),
                (s) => SeasonLocalCache.SetSeasonByYearCache(seasonValue, s)
            );

            Season = SeasonModel.Season;
            Month = monthValue;
            Day = dayValue;

            await LoadGamesAsync();
            StateHasChanged();
            PageLoad = true;

        }
        catch (Exception ex)
        {
            await HandleError(ex);
        }
    }

    private async Task ConfigureNavigation(string sport)
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        bool hasUpdateStats = user.IsInRole(Roles.UpdateStats);
        bool hasCreateStats = user.IsInRole(Roles.CreateStats);

        editStats = hasUpdateStats && hasCreateStats;

        NavigateEditSportLineup = sport switch
        {
            SportName.BASEBALL => "/createbaseballgamelineup/",
            SportName.BASKETBALL => "/createbasketballgamelineup/",
            SportName.FOOTBALL => "/createfootballgamelineup/",
            _ => ""
        };

        NavigateSportLineup = sport switch
        {
            SportName.BASEBALL => "/baseballgamelineup/",
            SportName.BASKETBALL => "/basketballgamelineup/",
            SportName.FOOTBALL => "/footballgamelineup/",
            _ => ""
        };

        if (editStats)
        {
            NavigateEditSportStats = sport switch
            {
                SportName.BASEBALL => "/editbaseballgamestats/",
                SportName.BASKETBALL => "/editbasketballgamestats/",
                SportName.FOOTBALL => "/editfootballgamestats/",
                _ => ""
            };
        }
        else
        {
            NavigateSportStats = sport switch
            {
                SportName.BASEBALL => "/baseballgamestats/",
                SportName.BASKETBALL => "/basketballgamestats/",
                SportName.FOOTBALL => "/footballgamestats/",
                _ => ""
            };
        }

    }

    private async Task NavigateToDeleteGame(Guid id)
    {
        var idString = id.ToString();
        NavManager.NavigateTo($"/deleteGame/{idString}");
    }


    private async Task OpenDialogAsync(Guid id)
    {
        var parameters = new DialogParameters<DeleteGameMessageBox> { { x => x.Id, id } };
        var options = new DialogOptions { CloseOnEscapeKey = true };

        var dialog = await DialogService.ShowAsync<DeleteGameMessageBox>("Delete Game", parameters, options);

        var result = await dialog.Result;

        if (!result.Canceled)
        {
            PageLoad = false;
            var leagueId = Guid.Parse(Id);
            Month = monthValue;
            Day = dayValue;
            seasonValue = Season.Year;
            LeagueGamesModel = await GamesService.GetLeagueGamesByDate(leagueId, CurrentDateString);
            PageLoad = true;
        }

    }

    private async Task GetImageAsync()
    {
        foreach (var game in LeagueGamesModel.Games)
        {
            var away = await DataLoader.GetOrLoad(
                () => TeamLocalCache.GetTeamByIdCache(game.AwayTeam.Id.ToString()),
                () => TeamService.GetTeamById(game.AwayTeam.Id),
                (t) => TeamLocalCache.SetTeamByIdCache(game.AwayTeam.Id.ToString(), t)
            );
            var home = await DataLoader.GetOrLoad(
                () => TeamLocalCache.GetTeamByIdCache(game.HomeTeam.Id.ToString()),
                () => TeamService.GetTeamById(game.HomeTeam.Id),
                (t) => TeamLocalCache.SetTeamByIdCache(game.HomeTeam.Id.ToString(), t)
            );

            game.AwayTeamImage = await ImageService.GetTeamImageAsync(LeagueModel.League, away.Team);
            game.HomeTeamImage = await ImageService.GetTeamImageAsync(LeagueModel.League, home.Team);
        }
    }

    private void AdjustDaysOfMonth(int value)
    {
        daysOfMonth = Constants.DaysOfMonth();

        monthValue = value;

        if (monthValue is 4 or 6 or 11)
            daysOfMonth.Remove(31);

        if (monthValue is 2)
        {
            daysOfMonth.Remove(30);
            daysOfMonth.Remove(31);
        }
    }

    private async Task HandleError(Exception ex)
    {
        if (KeycloakTokenService.ShouldForceLogout())
        {
            _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/authRefresh.js");
            await _module.InvokeVoidAsync("logout");
        }
        ErrorState.Message = ex.Message;
        NavManager.NavigateTo("/error");
    }

    private RenderFragment SearchPanel =>@<MudStack Row="true" Justify="Justify.FlexStart">
        <MudItem xs="3">
             <MudSelect T="int" ValueChanged="AdjustDaysOfMonth" Value="@monthValue" Label="@monthPlaceholder">
                @foreach(var m in Constants.Months())
                {
                    <MudSelectItem Value="@m.Value">@m.Key</MudSelectItem>
                }
             </MudSelect>
        </MudItem>
        <MudItem xs="3">
            <MudSelect @bind-Value="dayValue" Label="@dayPlaceholder">
                @foreach (var d in daysOfMonth)
                {
                    <MudSelectItem Value="@d">@d</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="3">
            <MudSelect @bind-Value="seasonValue" Label="@seasonPlaceholder">
                @foreach (var s in SeasonsModel.Seasons)
                {
                    <MudSelectItem Value="@s.Year">@s.Year</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="3" Class="d-flex align-center px-2">
            <MudButton Disabled="seasonValue <= 0"
                       OnClick="GetSeasonGames"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       Style="width: 200px">
                Search
            </MudButton>
        </MudItem>
    </MudStack>
    ;

    private RenderFragment GameTable =>@<MudTable T="GameModel" Items="@LeagueGamesModel.Games" Hover="true"
                  Class="border border-solid border-black">
            <ToolBarContent>
                @if (CanCreateGames)
                {
                    <MudStack Justify="Justify.FlexStart">
                        <MudButton Href="@($"/creategame/{Id}")"
                                   Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   Class="ml-auto" Style="width: 200px">
                            Create
                        </MudButton>
                    </MudStack>
                }
            </ToolBarContent>
            <HeaderContent>
                <MudTh Class="font-bold mud-theme-primary">
                    <MudTableSortLabel T="GameModel" SortBy="@(x => x.AwayTeam.TeamName)">Away Team</MudTableSortLabel>
                </MudTh>
                <MudTh Class="font-bold mud-theme-primary">
                    <MudTableSortLabel T="GameModel" SortBy="@(x => x.HomeTeam.TeamName)">Home Team</MudTableSortLabel>
                </MudTh>
                <MudTh Class="font-bold mud-theme-primary">
                    Score
                </MudTh>
                <MudTh Class="font-bold mud-theme-primary">
                    <MudTableSortLabel T="GameModel" SortBy="@(x => x.GameDetail.StartTime)">Start Time</MudTableSortLabel>
                </MudTh>
                <MudTh Class="font-bold mud-theme-primary">
                    End Time
                </MudTh>
                <MudTh Class="font-bold mud-theme-primary">
                    Status
                </MudTh>
                <MudTh></MudTh>
                <MudTh></MudTh>
                <MudTh></MudTh>
            </HeaderContent>
            <RowTemplate Context="game">
                <MudTd>
                    <MudStack Row="true">
                        <MudAvatar Size="Size.Small">
                            <MudImage Src="@game.AwayTeamImage" />
                        </MudAvatar>
                        @game.AwayTeam.TeamName
                    </MudStack>
                </MudTd>

                <MudTd>
                    <MudStack Row="true">
                        <MudAvatar Size="Size.Small">
                    <MudImage Src="@game.HomeTeamImage" />
                        </MudAvatar>
                        @game.HomeTeam.TeamName
                    </MudStack>
                </MudTd>

                <MudTd>@game.GameDetail.AwayTeamScore - @game.GameDetail.HomeTeamScore</MudTd>
                <MudTd>@game.GameDetail.StartTime.ToString("hh:mm tt")</MudTd>
                <MudTd>
                    @if(game.GameStatus == GameStatus.Completed)
                    {
                        @game.GameDetail.EndTime?.ToString("hh:mm tt")
                    }
                </MudTd>
                <MudTd>@Constants.GameStatus(game.GameStatus)</MudTd>
                <MudTd>
                    @if(game.GameStatus is not GameStatus.Completed and not GameStatus.InProgress)
                    {
                        @if(CanCreateGames)
                        {
                            <MudLink Href="@($"{NavigateEditSportLineup}{game.Id}")" Target="_blank">
                                <MudIcon Icon="@Icons.Material.Filled.EventNote" />
                            </MudLink>
                        }
                    }
                    else 
                    {
                        if (CanReadGames)
                        {
                    <MudLink Href="@($"{NavigateSportLineup}{game.Id}")" Target="_blank">
                                <MudIcon Icon="@Icons.Material.Filled.EventNote" />
                            </MudLink>
                        }
                    }
                </MudTd>
                <MudTd>
                    @if (CanUpdateGames)
                    {
                <MudLink Href="@($"/updategame/{game.Id}")" Target="_blank">
                            <MudIcon Icon="@Icons.Material.Filled.Edit" />
                        </MudLink>
                    }
                </MudTd>
                <MudTd>
                    @if(game.GameStatus is GameStatus.Completed or GameStatus.InProgress)
                    {
                        @if(CanReadStats){
                            <MudLink Href="@($"{(editStats ? NavigateEditSportStats : NavigateSportStats)}{game.Id}")" Target="_blank">
                                <MudIcon Icon="@Icons.Material.Filled.QueryStats" />
                            </MudLink>
                        }
                    }
                </MudTd>
        </RowTemplate>
    </MudTable>;
        
}
