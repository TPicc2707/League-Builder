@page "/leaguegames/{id}"
@using League.Builder.Web.Server.Components.Pages.Games
@inject IGameService GamesService
@inject ISeasonService SeasonService
@inject ILeagueService LeagueService
@inject ITeamService TeamService
@inject IDialogService DialogService
@inject IAWSService AWSService
@inject NavigationManager NavManager
@inject IHttpContextAccessor HttpContextAccessor
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ILocalStorageService LocalStorage
@inject IGameLocalCacheService GameLocalCache

<AuthorizeView Roles="@String.Concat(Roles.ReadGames, ", ", Roles.ReadSeasons)" Context="auth">
    <Authorized>
        @if (PageLoad)
        {
            <MudItem Style="padding-top: 25px; padding-bottom: 25px;">
                <MudExpansionPanels>
                    <MudExpansionPanel Expanded="expandSearchPanel" Class="border border-solid" Style="border-color: #000000">
                        <TitleContent>
                            <MudText Typo="Typo.h5" Align="Align.Center" Style="font-weight:bold">@Season.Year Schedule</MudText>
                        </TitleContent>
                        <ChildContent>
                            <MudStack Justify="Justify.FlexStart" Row="true">
                                <MudItem xs="3" md="3" lg="3">
                                    <MudSelect T="int" ValueChanged="AdjustDaysOfMonth" Value="@monthValue" Placeholder="@monthPlaceholder" Label="@monthPlaceholder">
                                        @foreach (var months in Constants.Months())
                                        {
                                            <MudSelectItem Value="months.Value">@months.Key</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="3" md="3" lg="3">
                                    <MudSelect @bind-Value="dayValue" Placeholder="@dayPlaceholder" Label="@dayPlaceholder">
                                        @foreach (var day in daysOfMonth)
                                        {
                                            <MudSelectItem Value="day">@day</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="3" md="3" lg="3">
                                    <MudSelect @bind-Value="seasonValue" Placeholder="@seasonPlaceholder" Label="@seasonPlaceholder">
                                        @foreach (var season in SeasonsModel.Seasons)
                                        {
                                            <MudSelectItem Value="season.Year">@season.Year</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="3" md="3" lg="3" Style="align-content: center; padding: 10px;">
                                    <MudButton Disabled="@(seasonValue <= 0 ? true : false)" OnClick="GetSeasonGames" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" Style="width: 200px;">Search</MudButton>
                                </MudItem>
                            </MudStack>
                        </ChildContent>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            </MudItem>
            <MudItem>
                <MudPaper Elevation="2" Class="border border-solid" Style="border-color: #000000; padding: 25px;">
                    <AuthorizeView Roles="@Roles.CreateGames" Context="createGameAuth">
                        <Authorized>
                            <MudItem>
                                <MudTable Items="@LeagueGamesModel.Games" Hover="true" SortLabel="Sort By" Class="border border-solid" Style="border-color: #000000">
                                    <ColGroup>
                                        <col />
                                        <col />
                                        <col />
                                        <col />
                                        <col />
                                        <col style="width: 60px;" />
                                    </ColGroup>
                                    <ToolBarContent>
                                        <MudStack Justify="Justify.FlexStart">
                                            <MudButton Target="_top" OnClick="NavigateToCreateGame" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" style="width: 200px;">Create</MudButton>
                                        </MudStack>
                                    </ToolBarContent>
                                    <HeaderContent>
                                        <MudTh Style="font-weight:bold" Class="mud-theme-primary"><MudTableSortLabel SortBy="new Func<GameModel, object>(x => x.AwayTeam.TeamName)">Away Team</MudTableSortLabel></MudTh>
                                        <MudTh Style="font-weight:bold" Class="mud-theme-primary"><MudTableSortLabel SortBy="new Func<GameModel, object>(x => x.HomeTeam.TeamName)">Home Team</MudTableSortLabel></MudTh>
                                        <MudTh Style="font-weight:bold" Class="mud-theme-primary">Score</MudTh>
                                        <MudTh Style="font-weight:bold" Class="mud-theme-primary"><MudTableSortLabel InitialDirection="SortDirection.Ascending" SortBy="new Func<GameModel, object>(x => x.GameDetail.StartTime)">Start Time</MudTableSortLabel></MudTh>
                                        <MudTh Style="font-weight:bold" Class="mud-theme-primary">End Time</MudTh>
                                        <MudTh Style="font-weight:bold" Class="mud-theme-primary">Status</MudTh>
                                        <MudTh Class="mud-theme-primary"></MudTh>
                                        <MudTh Class="mud-theme-primary"></MudTh>
                                        <MudTh Class="mud-theme-primary"></MudTh>
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd DataLabel="Away Team">
                                            <MudStack Row="true">
                                                <MudAvatar Size="Size.Small">
                                                    <MudImage Src="@context.AwayTeamImage" Alt="Team Image"></MudImage>
                                                </MudAvatar>
                                                @context.AwayTeam.TeamName
                                            </MudStack>
                                        </MudTd>
                                        <MudTd DataLabel="Home Team">
                                            <MudStack Row="true">
                                                <MudAvatar Size="Size.Small">
                                                    <MudImage Src="@context.HomeTeamImage" Alt="Team Image"></MudImage>
                                                </MudAvatar>
                                                @context.HomeTeam.TeamName
                                            </MudStack>
                                        </MudTd>
                                        <MudTd DataLabel="Score">@context.GameDetail.AwayTeamScore - @context.GameDetail.HomeTeamScore</MudTd>
                                        <MudTd DataLabel="Start Time">@context.GameDetail.StartTime.ToString("hh:mm tt")</MudTd>
                                        @if (context.GameStatus == GameStatus.Completed)
                                        {
                                            <MudTd DataLabel="Start Time">@context.GameDetail.EndTime.Value.ToString("hh:mm tt")</MudTd>
                                        }
                                        else
                                        {
                                            <MudTd></MudTd>
                                        }
                                        <MudTd DataLabel="Status">@Constants.GameStatus(context.GameStatus)</MudTd>
                                        @if (context.GameStatus != GameStatus.Completed && context.GameStatus != GameStatus.InProgress)
                                        {
                                            <AuthorizeView Roles="@Roles.CreateGames" Context="statAuth">
                                                <Authorized>
                                                    <MudTd DataLabel="Stats">
                                                        <MudTooltip Text="Game Lineup" Color="Color.Secondary">
                                                            <MudLink Target="_blank" Color="Color.Tertiary" OnClick="@(() => NavigateToCreateGameLineup(context.Id))">
                                                                <MudIcon Icon="@Icons.Material.Filled.EventNote" />
                                                            </MudLink>
                                                        </MudTooltip>
                                                    </MudTd>
                                                </Authorized>
                                                <NotAuthorized>
                                                    <MudTd></MudTd>
                                                </NotAuthorized>
                                            </AuthorizeView>
                                        }
                                        else
                                        {
                                            <AuthorizeView Roles="@Roles.ReadGames" Context="statAuth">
                                                <Authorized>
                                                    <MudTd DataLabel="Stats">
                                                        <MudTooltip Text="Game Lineup" Color="Color.Secondary">
                                                            <MudLink Target="_blank" Color="Color.Tertiary" OnClick="@(() => NavigateToGameLineup(context.Id))">
                                                                <MudIcon Icon="@Icons.Material.Filled.EventNote" />
                                                            </MudLink>
                                                        </MudTooltip>
                                                    </MudTd>
                                                </Authorized>
                                                <NotAuthorized>
                                                    <MudTd></MudTd>
                                                </NotAuthorized>
                                            </AuthorizeView>
                                        }
                                        <AuthorizeView Roles="@Roles.UpdateGames" Context="updateAuth">
                                            <Authorized>
                                                <MudTd DataLabel="Edit">
                                                    <MudTooltip Text="Edit Game" Color="Color.Secondary">
                                                        <MudLink Target="_blank" Color="Color.Tertiary" OnClick="@(() => NavigateToUpdateGame(context.Id))">
                                                            <MudIcon Icon="@Icons.Material.Filled.Edit" />
                                                        </MudLink>
                                                    </MudTooltip>
                                                </MudTd>
                                            </Authorized>
                                            <NotAuthorized>
                                                <MudTd></MudTd>
                                            </NotAuthorized>
                                        </AuthorizeView>
                                        @if (context.GameStatus == GameStatus.Completed || context.GameStatus == GameStatus.InProgress)
                                        {
                                            <AuthorizeView Roles="@Roles.ReadStats" Context="statAuth">
                                                <Authorized>
                                                    <MudTd DataLabel="Stats">
                                                        <MudTooltip Text="Game Stats" Color="Color.Secondary">
                                                            <MudLink Target="_blank" Color="Color.Tertiary" OnClick="@(() => NavigateToGameStats(context.Id, context.LeagueId))">
                                                                <MudIcon Icon="@Icons.Material.Filled.QueryStats" />
                                                            </MudLink>
                                                        </MudTooltip>
                                                    </MudTd>
                                                </Authorized>
                                                <NotAuthorized>
                                                    <MudTd></MudTd>
                                                </NotAuthorized>
                                            </AuthorizeView>
                                        }
                                        else
                                        {
                                            <MudTd></MudTd>
                                        }
                                    </RowTemplate>
                                </MudTable>

                            </MudItem>
                        </Authorized>
                        <NotAuthorized>
                            <MudItem>
                                <MudTable Items="@LeagueGamesModel.Games" Hover="true" SortLabel="Sort By" Class="border border-solid" Style="border-color: #000000">
                                    <ColGroup>
                                        <col />
                                        <col />
                                        <col />
                                        <col />
                                        <col />
                                        <col style="width: 60px;" />
                                    </ColGroup>
                                    <HeaderContent>
                                        <MudTh Style="font-weight:bold" Class="mud-theme-primary"><MudTableSortLabel InitialDirection="SortDirection.Ascending" SortBy="new Func<GameModel, object>(x => x.AwayTeam.TeamName)">Away Team</MudTableSortLabel></MudTh>
                                        <MudTh Style="font-weight:bold" Class="mud-theme-primary"><MudTableSortLabel InitialDirection="SortDirection.Ascending" SortBy="new Func<GameModel, object>(x => x.HomeTeam.TeamName)">Home Team</MudTableSortLabel></MudTh>
                                        <MudTh Style="font-weight:bold" Class="mud-theme-primary">Score</MudTh>
                                        <MudTh Style="font-weight:bold" Class="mud-theme-primary"><MudTableSortLabel SortBy="new Func<GameModel, object>(x => x.GameDetail.StartTime)">Start Time</MudTableSortLabel></MudTh>
                                        <MudTh Style="font-weight:bold" Class="mud-theme-primary">End Time</MudTh>
                                        <MudTh Style="font-weight:bold" Class="mud-theme-primary">Status</MudTh>
                                        <MudTh Class="mud-theme-primary"></MudTh>
                                        <MudTh Class="mud-theme-primary"></MudTh>
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd DataLabel="Away Team">
                                            <MudStack Row="true">
                                                <MudAvatar Size="Size.Small">
                                                    <MudImage Src="@context.AwayTeamImage" Alt="Team Image"></MudImage>
                                                </MudAvatar>
                                                @context.AwayTeam.TeamName
                                            </MudStack>
                                        </MudTd>
                                        <MudTd DataLabel="Home Team">
                                            <MudStack Row="true">
                                                <MudAvatar Size="Size.Small">
                                                    <MudImage Src="@context.HomeTeamImage" Alt="Team Image"></MudImage>
                                                </MudAvatar>
                                                @context.HomeTeam.TeamName
                                            </MudStack>
                                        </MudTd>
                                        <MudTd DataLabel="Score">@context.GameDetail.AwayTeamScore - @context.GameDetail.HomeTeamScore</MudTd>
                                        <MudTd DataLabel="Start Time">@context.GameDetail.StartTime.ToString("hh:mm tt")</MudTd>
                                        @if (context.GameStatus == GameStatus.Completed)
                                        {
                                            <MudTd DataLabel="Start Time">@context.GameDetail.EndTime.Value.ToString("hh:mm tt")</MudTd>
                                        }
                                        else
                                        {
                                            <MudTd></MudTd>
                                        }
                                        <MudTd DataLabel="Status">@Constants.GameStatus(context.GameStatus)</MudTd>
                                        @if (context.GameStatus != GameStatus.Completed && context.GameStatus != GameStatus.InProgress)
                                        {
                                            <MudTd></MudTd>
                                        }
                                        else
                                        {
                                            <AuthorizeView Roles="@Roles.ReadGames" Context="statAuth">
                                                <Authorized>
                                                    <MudTd DataLabel="Stats">
                                                        <MudTooltip Text="Game Lineup" Color="Color.Secondary">
                                                            <MudLink Target="_blank" Color="Color.Tertiary" OnClick="@(() => NavigateToGameLineup(context.Id))">
                                                                <MudIcon Icon="@Icons.Material.Filled.EventNote" />
                                                            </MudLink>
                                                        </MudTooltip>
                                                    </MudTd>
                                                </Authorized>
                                                <NotAuthorized>
                                                    <MudTd></MudTd>
                                                </NotAuthorized>
                                            </AuthorizeView>
                                        }
                                        @if (context.GameStatus == GameStatus.Completed || context.GameStatus == GameStatus.InProgress)
                                        {
                                            <AuthorizeView Roles="@Roles.ReadStats" Context="statAuth">
                                                <Authorized>
                                                    <MudTd DataLabel="Stats">
                                                        <MudTooltip Text="Game Stats" Color="Color.Secondary">
                                                            <MudLink Target="_blank" Color="Color.Tertiary" OnClick="@(() => NavigateToGameStats(context.Id, context.LeagueId))">
                                                                <MudIcon Icon="@Icons.Material.Filled.QueryStats" />
                                                            </MudLink>
                                                        </MudTooltip>
                                                    </MudTd>
                                                </Authorized>
                                                <NotAuthorized>
                                                    <MudTd></MudTd>
                                                </NotAuthorized>
                                            </AuthorizeView>
                                        }
                                        else
                                        {
                                            <MudTd></MudTd>
                                        }
                                    </RowTemplate>
                                </MudTable>
                            </MudItem>
                        </NotAuthorized>
                    </AuthorizeView>
                </MudPaper>

            </MudItem>
        }
        else
        {
            <Loading />
        }
    </Authorized>
    <NotAuthorized>
        <NoAccess />
    </NotAuthorized>
</AuthorizeView>
@code {
    [Parameter]
    public string Id { get; set; }
    private bool PageLoad = false;
    private Justify _justify = Justify.SpaceEvenly;
    private SeasonModel Season;
    private List<GameModel> Games = new();
    private string seasonPlaceholder = "Season";
    private string monthPlaceholder = "Month";
    private string dayPlaceholder = "Day";
    private int seasonValue;
    private int monthValue = DateTime.Now.Month;
    private int dayValue = 1;
    private int Month;
    private int Day;
    private int GameCount = 0;
    private bool expandSearchPanel = false;
    private List<int> daysOfMonth;

    private GetSeasonsResponse SeasonsModel { get; set; }
    private GetSeasonByYearResponse SeasonModel { get; set; }
    private GetLeagueGamesByDateResponse LeagueGamesModel { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (await AuthorizationStatus.IsUserAccessTokenExpired(HttpContextAccessor))
            {
                NavManager.NavigateTo("authentication/logout");
            }

            var leagueId = Guid.Parse(Id);
            SeasonsModel = await LocalStorage.GetItemAsync<GetSeasonsResponse>("Seasons");
            if (SeasonsModel == null)
            {
                SeasonsModel = await SeasonService.GetSeasons();
                await LocalStorage.SetItemAsync("Seasons", SeasonsModel);
            }
            Season = SeasonsModel.Seasons.First();
            Month = monthValue;
            Day = dayValue;
            seasonValue = Season.Year;
            var date = new DateTime(Season.Year, Month, Day).ToString("yyyy-MM-dd");
            LeagueGamesModel = await GamesService.GetLeagueGamesByDate(leagueId, date);
            await GetImageAsync();
            AdjustDaysOfMonth(Month);
            PageLoad = true;

        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            NavManager.NavigateTo("/error");
        }
    }

    private async Task GetSeasonGames()
    {
        try
        {
            PageLoad = false;
            var leagueId = Guid.Parse(Id);
            SeasonModel = await LocalStorage.GetItemAsync<GetSeasonByYearResponse>($"SeasonByYear: {seasonValue}");
            if (SeasonModel == null)
            {
                SeasonModel = await SeasonService.GetSeasonByYear(seasonValue);
                await LocalStorage.SetItemAsync($"SeasonByYear: {seasonValue}", SeasonModel);
            }
            Season = SeasonModel.Season;
            Month = monthValue;
            Day = dayValue;
            var date = new DateTime(Season.Year, Month, Day).ToString("yyyy-MM-dd");
            LeagueGamesModel = await GamesService.GetLeagueGamesByDate(leagueId, date);
            await GetImageAsync();
            AdjustDaysOfMonth(Month);
            StateHasChanged();
            PageLoad = true;

        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            NavManager.NavigateTo("/error");
        }
    }

    private async Task NavigateToUpdateGame(Guid id)
    {
        var idString = id.ToString();
        NavManager.NavigateTo($"/updategame/{idString}");
    }

    private async Task NavigateToDeleteGame(Guid id)
    {
        var idString = id.ToString();
        NavManager.NavigateTo($"/deleteGame/{idString}");
    }

    private async Task NavigateToCreateGame()
    {
        NavManager.NavigateTo($"/creategame/{Id}");
    }

    private async Task NavigateToCreateGameLineup(Guid id)
    {
        var idString = id.ToString();
        var leagueId = Guid.Parse(Id);
        var league = await LocalStorage.GetItemAsync<GetLeagueByIdResponse>($"League: {Id}");
        if (league == null)
        {
            league = await LeagueService.GetLeague(leagueId);
            await LocalStorage.SetItemAsync($"League: {Id}", league);
        }

        if (league.League.Sport == SportName.BASEBALL)
            NavManager.NavigateTo($"/createbaseballgamelineup/{idString}");

        if (league.League.Sport == SportName.FOOTBALL)
            NavManager.NavigateTo($"/editfootballgamestats/{idString}");

        if (league.League.Sport == SportName.BASKETBALL)
            NavManager.NavigateTo($"/editbasketballgamestats/{idString}");
    }

    private async Task NavigateToGameLineup(Guid id)
    {
        var idString = id.ToString();
        var leagueId = Guid.Parse(Id);
        var league = await LocalStorage.GetItemAsync<GetLeagueByIdResponse>($"League: {Id}");
        if (league == null)
        {
            league = await LeagueService.GetLeague(leagueId);
            await LocalStorage.SetItemAsync($"League: {Id}", league);
        }

        if (league.League.Sport == SportName.BASEBALL)
            NavManager.NavigateTo($"/baseballgamelineup/{idString}");

        if (league.League.Sport == SportName.FOOTBALL)
            NavManager.NavigateTo($"/editfootballgamestats/{idString}");

        if (league.League.Sport == SportName.BASKETBALL)
            NavManager.NavigateTo($"/editbasketballgamestats/{idString}");
    }

    private async Task NavigateToGameStats(Guid id, Guid leagueId)
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var claims = user.Claims;
            var canEditStats = claims.Where(c => c.Value.Contains(Roles.UpdateStats)).Any();
            var canCreateStats = claims.Where(c => c.Value.Contains(Roles.CreateStats)).Any();

            var idString = id.ToString();
            var league = await LocalStorage.GetItemAsync<GetLeagueByIdResponse>($"League: {Id}");
            if (league == null)
            {
                league = await LeagueService.GetLeague(leagueId);
                await LocalStorage.SetItemAsync($"League: {Id}", league);
            }

            if (canEditStats && canCreateStats)
            {
                if (league.League.Sport == SportName.BASEBALL)
                    NavManager.NavigateTo($"/editbaseballgamestats/{idString}");

                if (league.League.Sport == SportName.FOOTBALL)
                    NavManager.NavigateTo($"/editfootballgamestats/{idString}");

                if (league.League.Sport == SportName.BASKETBALL)
                    NavManager.NavigateTo($"/editbasketballgamestats/{idString}");
            }
            else
            {
                if (league.League.Sport == SportName.BASEBALL)
                    NavManager.NavigateTo($"/baseballgamestats/{idString}");

                if (league.League.Sport == SportName.FOOTBALL)
                    NavManager.NavigateTo($"/footballgamestats/{idString}");

                if (league.League.Sport == SportName.BASKETBALL)
                    NavManager.NavigateTo($"/basketballgamestats/{idString}");

            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            NavManager.NavigateTo("/error");
        }
    }

    private async Task OpenDialogAsync(Guid id)
    {
        var parameters = new DialogParameters<DeleteGameMessageBox> { { x => x.Id, id } };
        var options = new DialogOptions { CloseOnEscapeKey = true };

        var dialog = await DialogService.ShowAsync<DeleteGameMessageBox>("Delete Game", parameters, options);

        var result = await dialog.Result;

        if (!result.Canceled)
        {
            PageLoad = false;
            var leagueId = Guid.Parse(Id);
            Month = monthValue;
            Day = dayValue;
            seasonValue = Season.Year;
            var date = new DateTime(Season.Year, Month, Day).ToString("yyyy-MM-dd");
            LeagueGamesModel = await GamesService.GetLeagueGamesByDate(leagueId, date);
            PageLoad = true;
        }

    }

    private async Task GetImageAsync()
    {
        var leagueId = Guid.Parse(Id);
        var league = await LocalStorage.GetItemAsync<GetLeagueByIdResponse>($"League: {Id}");
        if (league == null)
        {
            league = await LeagueService.GetLeague(leagueId);
            await LocalStorage.SetItemAsync($"League: {Id}", league);
        }

        foreach (var games in LeagueGamesModel.Games)
        {
            var awayTeam = await LocalStorage.GetItemAsync<GetTeamByIdResponse>($"Team: {games.AwayTeam.Id.ToString()}");
            if (awayTeam == null)
            {
                awayTeam = await TeamService.GetTeamById(games.AwayTeam.Id);
                await LocalStorage.SetItemAsync($"Team: {games.AwayTeam.Id.ToString()}", awayTeam);
            }
            var homeTeam = await LocalStorage.GetItemAsync<GetTeamByIdResponse>($"Team: {games.HomeTeam.Id.ToString()}");
            if (homeTeam == null)
            {
                homeTeam = await TeamService.GetTeamById(games.HomeTeam.Id);
                await LocalStorage.SetItemAsync($"Team: {games.HomeTeam.Id.ToString()}", homeTeam);
            }

            var awayTeamKeyPath = $"/{league.League.Sport}/{league.League.Name}/teams/{awayTeam.Team.TeamName}/{awayTeam.Team.ImageFile}";
            games.AwayTeamImage = await AWSService.GetImage(awayTeamKeyPath);

            var homeTeamKeyPath = $"/{league.League.Sport}/{league.League.Name}/teams/{homeTeam.Team.TeamName}/{homeTeam.Team.ImageFile}";
            games.HomeTeamImage = await AWSService.GetImage(homeTeamKeyPath);
        }
    }

    private void AdjustDaysOfMonth(int value)
    {
        daysOfMonth = Constants.DaysOfMonth();

        monthValue = value;

        if (monthValue == 4 || monthValue == 6 || monthValue == 11)
            daysOfMonth.Remove(31);

        if (monthValue == 2)
        {
            daysOfMonth.Remove(30);
            daysOfMonth.Remove(31);
        }
    }
}
