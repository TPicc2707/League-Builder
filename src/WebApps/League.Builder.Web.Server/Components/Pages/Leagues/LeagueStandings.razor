@page "/leaguestandings/{id}"
@inject IStandingsService StandingsService
@inject ISeasonService SeasonService
@inject ITeamService TeamService
@inject NavigationManager NavManager;
@inject IHttpContextAccessor HttpContextAccessor
@inject ILeagueService LeagueService
@inject IAWSService AWSService

<AuthorizeView Roles="@String.Concat(Roles.ReadStandings, ", ", Roles.ReadSeasons)" Context="auth">
    <Authorized>
        @if (PageLoad)
        {
            <MudItem Style="padding-top: 25px; padding-bottom: 25px;">
                <MudExpansionPanels>
                    <MudExpansionPanel Expanded="expandSearchPanel" Class="border border-solid" Style="border-color: #000000">
                        <TitleContent>
                            <MudText Typo="Typo.h5" Align="Align.Center" Style="font-weight:bold">@Season.Year Standings</MudText>
                        </TitleContent>
                        <ChildContent>
                            <MudStack Justify="Justify.FlexStart" Row="true" Style="padding-top: 25px;">
                                <MudItem xs="6" md="6" lg="6">
                                    <MudSelect @bind-Value="seasonValue" Placeholder="@placeholder" Label="@placeholder">
                                        @foreach (var season in SeasonsModel.Seasons)
                                        {
                                            <MudSelectItem Value="season.Year">@season.Year</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="3" md="3" lg="3">

                                </MudItem>
                                <MudItem xs="3" md="3" lg="3" Style="align-content: center; padding: 10px;">
                                    <MudButton Disabled="@(seasonValue <= 0 ? true : false)" OnClick="GetSeasonStandings" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" Style="width: 200px;">Search</MudButton>
                                </MudItem>
                            </MudStack>
                        </ChildContent>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            </MudItem>
            <MudPaper Class="border border-solid" Style="border-color: #000000; padding: 25px 25px 25px 25px;">
                <MudItem>
                    <MudTable Items="@Standings" Hover="true" SortLabel="Sort By" Class="border border-solid" Style="border-color: #000000">
                        <HeaderContent>
                            <MudTh Class="mud-theme-primary"></MudTh>
                            <MudTh Style="font-weight:bold" Class="mud-theme-primary"><MudTableSortLabel SortBy="new Func<StandingsModel, object>(x => x.Team.TeamName)">Team Name</MudTableSortLabel></MudTh>
                            <MudTh Style="font-weight:bold" Class="mud-theme-primary"><MudTableSortLabel SortBy="new Func<StandingsModel, object>(x => x.StandingsDetail.GamesPlayed)">GP</MudTableSortLabel></MudTh>
                            <MudTh Style="font-weight:bold" Class="mud-theme-primary"><MudTableSortLabel SortBy="new Func<StandingsModel, object>(x => x.StandingsDetail.Wins)">W</MudTableSortLabel></MudTh>
                            <MudTh Style="font-weight:bold" Class="mud-theme-primary"><MudTableSortLabel SortBy="new Func<StandingsModel, object>(x => x.StandingsDetail.Losses)">L</MudTableSortLabel></MudTh>
                            <MudTh Style="font-weight:bold" Class="mud-theme-primary"><MudTableSortLabel SortBy="new Func<StandingsModel, object>(x => x.WinPercentage)">PCT</MudTableSortLabel></MudTh>
                            <MudTh Style="font-weight:bold" Class="mud-theme-primary"><MudTableSortLabel InitialDirection="SortDirection.Ascending" SortBy="new Func<StandingsModel, object>(x => x.GamesBack)">GB</MudTableSortLabel></MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>
                                <MudAvatar Size="Size.Small">
                                    <MudImage Src="@context.TeamImage" Alt="Player Image"></MudImage>
                                </MudAvatar>
                            </MudTd>
                            @if (context.PlayoffTeam)
                            {
                                <MudTd DataLabel="Team Name">
                                    <MudStack Row="true">
                                        x - @context.Team.TeamName
                                    </MudStack>
                                </MudTd>
                            }
                            else
                            {
                                <MudTd DataLabel="Team Name">
                                    <MudStack Row="true">
                                        @context.Team.TeamName
                                    </MudStack>
                                </MudTd>
                            }
                            <MudTd DataLabel="Games Played">@context.StandingsDetail.GamesPlayed</MudTd>
                            <MudTd DataLabel="Wins">@context.StandingsDetail.Wins</MudTd>
                            <MudTd DataLabel="Losses">@context.StandingsDetail.Losses</MudTd>
                            <MudTd DataLabel="Win Percentage">@context.WinPercentage.ToString("#0.000")</MudTd>
                            <MudTd DataLabel="Games Back">
                                @if(context.GamesBack != 0)
                                {
                                    @context.GamesBack.ToString("#0.0")
                                }
                                else
                                {
                                    @firstPlacePlaceholder
                                }
                                </MudTd>
                        </RowTemplate>
                    </MudTable>

                </MudItem>
                <MudItem xs="12" Style="margin-top: 25px; margin-right: 10px;">
                    <MudText Typo="Typo.body2" Align="Align.End">
                        x - : Clinched Playoff Berth
                    </MudText>
                </MudItem>
            </MudPaper>
        }
        else
        {
            <Loading />
        }
    </Authorized>
    <NotAuthorized>
        <MudText>You are not authorized to view this page...</MudText>
    </NotAuthorized>
</AuthorizeView>
@code {
    [Parameter]
    public string Id { get; set; }
    private bool PageLoad = false;
    private Justify _justify = Justify.SpaceEvenly;
    private SeasonModel Season;
    private string placeholder = "Season";
    private string firstPlacePlaceholder = "--";
    private int seasonValue;
    private bool expandSearchPanel = false;
    private IEnumerable<StandingsModel> Standings;

    private GetSeasonsResponse SeasonsModel { get; set; }
    private GetSeasonByYearResponse SeasonModel { get; set; }
    private GetStandingsByLeagueResponse Model { get; set; }
    private GetLeagueByIdResponse LeagueModel { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (await AuthorizationStatus.IsUserAccessTokenExpired(HttpContextAccessor))
        {
            NavManager.NavigateTo("authentication/logout");
        }

        var leagueId = Guid.Parse(Id);
        SeasonsModel = await SeasonService.GetSeasons();
        Season = SeasonsModel.Seasons.First();
        Model = await StandingsService.GetStandingsByLeague(leagueId);
        Standings = Model.Standings.Where(x => x.SeasonId == Season.Id);
        LeagueModel = await LeagueService.GetLeague(leagueId);
        await GetImageAsync();
        CalculateGamesBack();
        CalculatePlayoffTeams();
        seasonValue = Season.Year;
        PageLoad = true;
    }

    private async Task GetSeasonStandings()
    {
        PageLoad = false;
        SeasonModel = await SeasonService.GetSeasonByYear(seasonValue);
        Season = SeasonModel.Season;
        CalculateGamesBack();
        StateHasChanged();
        PageLoad = true;
    }

    private async Task GetImageAsync()
    {
        foreach (var standing in Model.Standings)
        {
            standing.WinPercentage = standing.StandingsDetail.Wins != 0 | standing.StandingsDetail.GamesPlayed != 0 ? (decimal)standing.StandingsDetail.Wins / standing.StandingsDetail.GamesPlayed : 0;
            var team = await TeamService.GetTeamById(standing.Team.Id);
            var keyPath = $"/{LeagueModel.League.Sport}/{LeagueModel.League.Name}/teams/{team.Team.TeamName}/{team.Team.ImageFile}";
            standing.TeamImage = await AWSService.GetImage(keyPath);
        }
    }

    private void CalculateGamesBack()
    {
        var firstPlaceTeam = Model.Standings.Where(x => x.SeasonId == Season.Id).OrderByDescending(x => x.WinPercentage).FirstOrDefault();

        foreach (var standing in Model.Standings.Where(x => x.SeasonId == Season.Id))
        {
            var differenceWins = firstPlaceTeam.StandingsDetail.Wins - standing.StandingsDetail.Wins;
            var differenceLosses = standing.StandingsDetail.Losses - firstPlaceTeam.StandingsDetail.Losses;
            var difference = differenceWins + differenceLosses;
            standing.GamesBack = difference != 0 ? (decimal)difference / 2 : 0;
        }
    }

    private void CalculatePlayoffTeams()
    {
        var playoffTeams = Model.Standings.Where(x => x.SeasonId == Season.Id).OrderByDescending(x => x.WinPercentage).Take(LeagueModel.League.TotalPlayoffTeams);

        foreach(var playoffTeam in playoffTeams)
            playoffTeam.PlayoffTeam = true;
    }
}
