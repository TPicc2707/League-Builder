@page "/leaguestandings/{id}"
@using League.Builder.Web.Server.Services.Cache
@inject IStandingsService StandingsService
@inject ISeasonService SeasonService
@inject ITeamService TeamService
@inject NavigationManager NavManager
@inject ErrorState ErrorState
@inject IHttpContextAccessor HttpContextAccessor
@inject ILeagueService LeagueService
@inject IAWSService AWSService
@inject ILeagueLocalCacheService LeagueLocalCache
@inject ITeamLocalCacheService TeamLocalCache
@inject ISeasonLocalCacheService SeasonLocalCache
@inject IStandingsLocalCacheService StandingsLocalCache
@inject IJSRuntime JsRuntime
@inject KeycloakTokenService KeycloakTokenService
@inject ImageService ImageService

<AuthorizeView Roles="@String.Concat(Roles.ReadStandings, ", ", Roles.ReadSeasons)" Context="auth">
    <Authorized>
        @if (PageLoad)
        {
            <MudItem Style="padding: 25px 0;">
                <MudExpansionPanels>
                    <MudExpansionPanel Expanded="expandSearchPanel" Class="border border-solid" Style="border-color: #000000">
                        <TitleContent>
                            <MudText Typo="Typo.h5" Align="Align.Center" Style="font-weight:bold">@Season.Year Standings</MudText>
                        </TitleContent>
                        <ChildContent>
                            <MudStack Justify="Justify.FlexStart" Row="true" Style="padding-top: 25px;">
                                <MudItem xs="6" md="6" lg="6">
                                    <MudSelect @bind-Value="seasonValue" Label="Season">
                                        @foreach (var season in SeasonsModel.Seasons)
                                        {
                                            <MudSelectItem Value="@season.Year">@season.Year</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="3" md="3" lg="3" Style="align-content: center; padding: 10px;">
                                    <MudButton Disabled="@(seasonValue <= 0)" OnClick="GetSeasonStandings" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" Style="width: 200px;">Search</MudButton>
                                </MudItem>
                                <MudItem xs="3" md="3" lg="3" Style="align-content: center; padding: 10px;">
                                    <MudButton OnClick="NavigateToPlayoffs" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" Style="width: 200px;">Playoffs</MudButton>
                                </MudItem>
                            </MudStack>
                        </ChildContent>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            </MudItem>
            <MudPaper Class="border border-solid pa-6" Style="border-color: #000000;">
                <MudItem>
                    <MudTable Items="@Standings" Hover="true" SortLabel="Sort By" Class="border border-solid" Style="border-color: #000000">
                        <HeaderContent>
                            <MudTh Class="mud-theme-primary"></MudTh>
                            <MudTh Class="mud-theme-primary font-bold"><MudTableSortLabel SortBy="new Func<StandingsModel, object>(x => x.Team.TeamName)">Team Name</MudTableSortLabel></MudTh>
                            <MudTh Class="mud-theme-primary font-bold"><MudTableSortLabel SortBy="new Func<StandingsModel, object>(x => x.StandingsDetail.GamesPlayed)">GP</MudTableSortLabel></MudTh>
                            <MudTh Class="mud-theme-primary font-bold"><MudTableSortLabel SortBy="new Func<StandingsModel, object>(x => x.StandingsDetail.Wins)">W</MudTableSortLabel></MudTh>
                            <MudTh Class="mud-theme-primary font-bold"><MudTableSortLabel SortBy="new Func<StandingsModel, object>(x => x.StandingsDetail.Losses)">L</MudTableSortLabel></MudTh>
                            <MudTh Class="mud-theme-primary font-bold"><MudTableSortLabel SortBy="new Func<StandingsModel, object>(x => x.WinPercentage)">PCT</MudTableSortLabel></MudTh>
                            <MudTh Class="mud-theme-primary font-bold"><MudTableSortLabel InitialDirection="SortDirection.Ascending" SortBy="new Func<StandingsModel, object>(x => x.GamesBack)">GB</MudTableSortLabel></MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>
                                <MudAvatar Size="Size.Small">
                                    <MudImage Src="@context.TeamImage" Alt="Team Image"></MudImage>
                                </MudAvatar>
                            </MudTd>
                            <MudTd DataLabel="Team Name">
                                @(context.ProjectedPlayoffTeam ? $"x - {context.Team.TeamName}" : context.Team.TeamName)
                            </MudTd>
                            <MudTd DataLabel="Games Played">@context.StandingsDetail.GamesPlayed</MudTd>
                            <MudTd DataLabel="Wins">@context.StandingsDetail.Wins</MudTd>
                            <MudTd DataLabel="Losses">@context.StandingsDetail.Losses</MudTd>
                            <MudTd DataLabel="Win Percentage">@context.WinPercentage.ToString("#0.000")</MudTd>
                            <MudTd DataLabel="Games Back">
                                @(context.GamesBack == 0
                                    ? firstPlacePlaceholder
                                    : context.GamesBack.ToString("#0.0"))
                                </MudTd>
                        </RowTemplate>
                    </MudTable>

                </MudItem>
                <MudItem xs="12" Style="margin-top: 25px; margin-right: 10px;">
                    <MudText Typo="Typo.body2" Align="Align.End">
                        x - : Clinched Playoff Berth
                    </MudText>
                </MudItem>
            </MudPaper>
        }
        else
        {
            <Loading />
        }
    </Authorized>
    <NotAuthorized>
        <NoAccess />
    </NotAuthorized>
</AuthorizeView>
@code {
    [Parameter]
    public string Id { get; set; }
    private bool PageLoad = false;
    private Justify _justify = Justify.SpaceEvenly;
    private SeasonModel Season;
    private string placeholder = "Season";
    private string firstPlacePlaceholder = "--";
    private int seasonValue;
    private bool expandSearchPanel = false;
    private IEnumerable<StandingsModel> Standings;
    private IJSObjectReference? _module;
    private GetSeasonsResponse SeasonsModel { get; set; }
    private GetSeasonByYearResponse SeasonModel { get; set; }
    private GetStandingsByLeagueResponse Model { get; set; }
    private GetLeagueByIdResponse LeagueModel { get; set; }
    private GetTeamByIdResponse TeamByIdResponse { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var leagueId = Guid.Parse(Id);
            SeasonsModel = await DataLoader.GetOrLoad(
                () => SeasonLocalCache.GetSeasonsCache(),
                () => SeasonService.GetSeasons(),
                (s) => SeasonLocalCache.SetSeasonsCache(s)
            );
            Season = SeasonsModel.Seasons.First();
            seasonValue = Season.Year;

            Model = await DataLoader.GetOrLoad(
                () => StandingsLocalCache.GetStandingsByLeagueCache(Id),
                () => StandingsService.GetStandingsByLeague(leagueId),
                (s) => StandingsLocalCache.SetStandingsByLeagueCache(Id, s)
            );
            Standings = Model.Standings.Where(x => x.SeasonId == Season.Id);

            foreach(var s in Standings)
            {
                var d = s.StandingsDetail;
                s.WinPercentage = CalculateWinPercentage(d.Wins, d.GamesPlayed);
            }

            LeagueModel = await DataLoader.GetOrLoad(
                () => LeagueLocalCache.GetLeagueByIdCache(Id),
                () => LeagueService.GetLeague(leagueId),
                (l) => LeagueLocalCache.SetLeagueByIdCache(Id, l)
            );

            CalculateGamesBack();
            CalculatePlayoffTeams();

            await GetImageAsync();

            PageLoad = true;

        }
        catch (Exception ex)
        {
            await HandleError(ex);
        }
    }

    private async Task GetSeasonStandings()
    {
        try
        {
            PageLoad = false;

            SeasonModel = await DataLoader.GetOrLoad(
                () => SeasonLocalCache.GetSeasonByYearCache(seasonValue),
                () => SeasonService.GetSeasonByYear(seasonValue),
                (s) => SeasonLocalCache.SetSeasonByYearCache(seasonValue, s)
            );
            Season = SeasonModel.Season;
            Standings = Model.Standings.Where(x => x.SeasonId == Season.Id);

            foreach (var s in Standings)
            {
                var d = s.StandingsDetail;
                s.WinPercentage = CalculateWinPercentage(d.Wins, d.GamesPlayed);
            }

            CalculateGamesBack();
            CalculatePlayoffTeams();

            await GetImageAsync();

            StateHasChanged();
            PageLoad = true;

        }
        catch (Exception ex)
        {
            await HandleError(ex);
        }
    }

    private async Task NavigateToPlayoffs()
    {
        NavManager.NavigateTo($"/playoffs/{Id}");
    }

    private async Task GetImageAsync()
    {
        foreach (var standing in Standings)
        {
            TeamByIdResponse = await DataLoader.GetOrLoad(
                () => TeamLocalCache.GetTeamByIdCache(standing.Team.Id.ToString()),
                () => TeamService.GetTeamById(standing.Team.Id),
                (t) => TeamLocalCache.SetTeamByIdCache(standing.Team.Id.ToString(), t)
            );
            standing.TeamImage = await ImageService.GetTeamImageAsync(LeagueModel.League, TeamByIdResponse.Team);
        }
    }

    private void CalculateGamesBack()
    {
        var first = Standings.OrderByDescending(x => x.WinPercentage).FirstOrDefault();

        if(first is null)
            return;

        foreach (var s in Standings)
        {
            var diffWins = first.StandingsDetail.Wins - s.StandingsDetail.Wins;
            var diffLosses = s.StandingsDetail.Losses - first.StandingsDetail.Losses;
            var diff = diffWins + diffLosses;
            s.GamesBack = diff == 0 ? 0 : (decimal)diff / 2;
        }
    }

    private void CalculatePlayoffTeams()
    {
        var playoffTeams = Standings.OrderByDescending(x => x.WinPercentage).Take(LeagueModel.League.TotalPlayoffTeams);

        foreach(var playoffTeam in playoffTeams)
            playoffTeam.ProjectedPlayoffTeam = true;
    }

    private async Task HandleError(Exception ex)
    {
        if (KeycloakTokenService.ShouldForceLogout())
        {
            _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/authRefresh.js");
            await _module.InvokeVoidAsync("logout");
        }
        ErrorState.Message = ex.Message;
        NavManager.NavigateTo("/error");
    }

    private static decimal CalculateWinPercentage(int wins, int gamesPlayed)
        => gamesPlayed == 0 ? 0 : (decimal)wins / gamesPlayed;
}
