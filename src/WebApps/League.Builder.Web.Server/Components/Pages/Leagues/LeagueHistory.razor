@page "/leaguehistory/{id}"
@inject ILeagueService LeagueService
@inject ITeamService TeamService
@inject ISeasonService SeasonService
@inject IStandingsService StandingsService
@inject IAWSService AWSService
@inject NavigationManager NavManager
@inject IHttpContextAccessor HttpContextAccessor
@inject ILeagueLocalCacheService LeagueLocalCache
@inject ITeamLocalCacheService TeamLocalCache
@inject ISeasonLocalCacheService SeasonLocalCache
@inject IStandingsLocalCacheService StandingsLocalCache


<AuthorizeView Roles="@String.Concat(Roles.ReadLeagues, ", ", Roles.ReadTeams, ", ", Roles.ReadSeasons, ", ", Roles.ReadGames)" Context="Auth">
    <Authorized>
        @if (PageLoad)
        {
            <MudItem Style="padding-top: 50px;">
                <MudPaper Class="border border-solid" Style="border-color: #000000; padding: 25px;">
                    <MudText Typo="Typo.h4" Align="Align.Center" Style="font-weight:bold">@LeagueByIdResponse.League.Name History</MudText>
                </MudPaper>
            </MudItem>
            <MudItem Style="padding-top: 50px;">
                <MudExpansionPanels>
                    <MudExpansionPanel Expanded="true" Class="border border-solid" Style="border-color: #000000; padding-left: 25px; padding-right: 25px;">
                        <TitleContent>
                            <MudText Typo="Typo.h5" Align="Align.Center" Style="font-weight:bold">Champions</MudText>
                        </TitleContent>
                        <ChildContent>
                            @if(Champs.Count > 0)
                            {
                                <MudItem>
                                    <MudTable Items="Champs" Hover="true" SortLabel="Sort By" Class="border border-solid" Style="border-color: #000000">
                                        <HeaderContent>
                                            <MudTh Style="font-weight:bold" Class="mud-theme-primary"></MudTh>
                                            <MudTh Style="font-weight:bold" Class="mud-theme-primary"><MudTableSortLabel SortBy="new Func<LeagueChampion, object>(x => x.Year)">Year</MudTableSortLabel></MudTh>
                                            <MudTh Style="font-weight:bold" Class="mud-theme-primary"><MudTableSortLabel SortBy="new Func<LeagueChampion, object>(x => x.TeamName)">Team</MudTableSortLabel></MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd DataLabel="Year">@context.Year</MudTd>
                                            <MudTd DataLabel="Team">
                                                <MudStack Row="true">
                                                    <MudAvatar Size="Size.Small">
                                                        <MudImage Src="@context.Image" Alt="Team Image"></MudImage>
                                                    </MudAvatar>
                                                    <MudText>@context.TeamName (@context.Wins - @context.Losses)</MudText>
                                                </MudStack>
                                            </MudTd>
                                        </RowTemplate>
                                        <PagerContent>
                                            <MudTablePager />
                                        </PagerContent>
                                    </MudTable>
                                </MudItem>
                            }
                        </ChildContent>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            </MudItem>
        }
        else
        {
            <Loading />
        }
    </Authorized>
    <NotAuthorized>
        <MudText>You are not authorized to view this page...</MudText>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter]
    public string Id { get; set; }
    public bool PageLoad = false;
    public GetLeagueByIdResponse LeagueByIdResponse { get; set; }
    public GetTeamsByLeagueResponse TeamsByLeagueResponse { get; set; }
    public GetSeasonsResponse GetSeasonsResponse { get; set; }
    public GetStandingsByLeagueResponse GetStandingsByLeagueResponse { get; set; }
    public List<LeagueChampion> Champs { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        if (await AuthorizationStatus.IsUserAccessTokenExpired(HttpContextAccessor))
        {
            NavManager.NavigateTo("authentication/logout");
        }

        var leagueId = Guid.Parse(Id);
        LeagueByIdResponse = await LeagueLocalCache.GetLeagueByIdCache(Id);
        if (LeagueByIdResponse == null)
        {
            LeagueByIdResponse = await LeagueService.GetLeague(leagueId);
            await LeagueLocalCache.SetLeagueByIdCache(Id, LeagueByIdResponse);
        }
        TeamsByLeagueResponse = await TeamLocalCache.GetTeamsByLeagueCache(Id);
        if(TeamsByLeagueResponse == null)
        {
            TeamsByLeagueResponse = await TeamService.GetTeamsByLeague(leagueId);
            await TeamLocalCache.SetTeamsByLeagueCache(Id, TeamsByLeagueResponse);
        }
        GetSeasonsResponse = await SeasonLocalCache.GetSeasonsCache();
        if(GetSeasonsResponse == null)
        {
            GetSeasonsResponse = await SeasonService.GetSeasons();
            await SeasonLocalCache.SetSeasonsCache(GetSeasonsResponse);
        }
        GetStandingsByLeagueResponse = await StandingsLocalCache.GetStandingsByLeagueCache(Id);
        if(GetStandingsByLeagueResponse == null)
        {
            GetStandingsByLeagueResponse = await StandingsService.GetStandingsByLeague(leagueId);
            await StandingsLocalCache.SetStandingsByLeagueCache(Id, GetStandingsByLeagueResponse);
        }

        foreach(var standing in GetStandingsByLeagueResponse.Standings)
        {
            LeagueChampion champion = new LeagueChampion();

            if (standing.StandingsDetail.Champion)
            {
                champion.TeamId = standing.Team.Id;
                champion.TeamName = standing.Team.TeamName;
                champion.Year = GetSeasonsResponse.Seasons.FirstOrDefault(x => x.Id == standing.SeasonId).Year;
                champion.Wins = standing.StandingsDetail.Wins;
                champion.Losses = standing.StandingsDetail.Losses;
                await GetImageAsync(champion);
                Champs.Add(champion);
            }
        }

        PageLoad = true;
    }

    private async Task GetImageAsync(LeagueChampion champion)
    {
        var team = TeamsByLeagueResponse.Teams.FirstOrDefault(x => x.Id == champion.TeamId);
        var keyPath = $"/{LeagueByIdResponse.League.Sport}/{LeagueByIdResponse.League.Name}/teams/{team.TeamName}/{team.ImageFile}";
        champion.Image = await AWSService.GetImage(keyPath);
    }

    public class LeagueChampion
    {
        public Guid TeamId { get; set; }
        public string TeamName { get; set; } = default!;
        public string Image { get; set; } = default!;
        public int Year { get; set; }
        public int Wins { get; set; }
        public int Losses { get; set; }
    }
}