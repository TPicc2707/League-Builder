@page "/footballleaguestatsleaders/{id}"
@using League.Builder.Web.Server.Services.Cache
@inject NavigationManager NavManager
@inject ErrorState ErrorState
@inject ISeasonService SeasonService
@inject IStatsService StatsService
@inject ITeamService TeamService
@inject IPlayerService PlayerService
@inject ILeagueService LeagueService
@inject IHttpContextAccessor HttpContextAccessor
@inject IAWSService AWSService
@inject ISeasonLocalCacheService SeasonLocalCache
@inject ILeagueLocalCacheService LeagueLocalCache
@inject IStatsLocalCacheService StatsLocalCache
@inject ITeamLocalCacheService TeamLocalCache
@inject IPlayerLocalCacheService PlayerLocalCache
@inject IJSRuntime JsRuntime
@inject KeycloakTokenService KeycloakTokenService
@inject ImageService ImageService

<AuthorizeView Roles="@String.Concat(Roles.ReadStats, ", ", Roles.ReadPlayers, ", ", Roles.ReadTeams, ", ", Roles.ReadSeasons, ", ", Roles.ReadLeagues)" Context="auth">
    <Authorized>
        @if (PageLoad)
        {
            <MudItem Style="padding-top: 25px; padding-bottom: 25px;">
                <MudExpansionPanels>
                    <MudExpansionPanel Expanded="expandSearchPanel" Class="border border-solid stat-border" Style="border-color: #000000">
                        <TitleContent>
                            <MudText Typo="Typo.h5" Align="Align.Center" Class="font-bold">@Season.Year Stat Leaders</MudText>
                        </TitleContent>
                        <ChildContent>
                            <MudStack Row="true">
                                <MudItem xs="8" md="8" lg="8">
                                    <MudSelect @bind-Value="seasonValue" Placeholder="@placeholder" Label="@placeholder">
                                        @foreach (var season in SeasonsModel.Seasons)
                                        {
                                            <MudSelectItem Value="@season.Year">@season.Year</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="4" md="4" lg="4" Style="align-content: center; padding: 10px;">
                                    <MudButton Disabled="@(seasonValue <= 0 ? true : false)" OnClick="GetSeasonStatLeaders" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" Style="width: 200px;">Search</MudButton>
                                </MudItem>
                            </MudStack>
                        </ChildContent>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            </MudItem>

            <MudItem Class="stat-padding">
                <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Centered="true" Class="border border-solid stat-border p-25">
                    <MudTabPanel Text="Passing">
                        <FootballPassingLeadersTable Leaders="@StatLeaders.Where(x => x.PassingAttempts > 0)" />
                    </MudTabPanel>
                    <MudTabPanel Text="Rushing">
                        <FootballRushingLeadersTable Leaders="@StatLeaders.Where(x => x.RushingAttempts > 0)" />
                    </MudTabPanel>
                    <MudTabPanel Text="Receiving">
                        <FootballReceivingLeadersTable Leaders="@StatLeaders.Where(x => x.Targets > 0)" />
                    </MudTabPanel>
                    <MudTabPanel Text="Defensive">
                        <FootballDefensiveLeadersTable Leaders="@StatLeaders.Where(x => x.Tackles > 0)" />
                    </MudTabPanel>
                    <MudTabPanel Text="Kicking">
                        <FootballKickingLeadersTable Leaders="@StatLeaders.Where(x => x.ExtraPointsAttempted > 0 || x.FieldGoalsAttempted > 0 || x.Punts > 0)" />
                    </MudTabPanel>
                </MudTabs>
            </MudItem>
        }
        else
        {
            <Loading />
        }
    </Authorized>
    <NotAuthorized>
        <MudText>You are not authorized to view this page...</MudText>
    </NotAuthorized>
</AuthorizeView>
@code {
    [Parameter]
    public string Id { get; set; }
    private bool PageLoad = false;
    private Justify _justify = Justify.SpaceEvenly;
    private SeasonModel Season;
    private List<FootballStatLeaderModel> StatLeaders = new List<FootballStatLeaderModel>();
    private string placeholder = "Season";
    private int seasonValue;
    private bool expandSearchPanel = false;
    private IJSObjectReference? _module;
    private GetPlayerByIdResponse PlayerModel { get; set; }
    private GetTeamByIdResponse TeamModel { get; set; }
    private GetLeagueByIdResponse LeagueModel { get; set; }
    private GetLeagueFootballStatsBySeasonResponse StatsModel { get; set; }
    private GetSeasonsResponse SeasonsModel { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            SeasonsModel = await DataLoader.GetOrLoad(
                () => SeasonLocalCache.GetSeasonsCache(),
                () => SeasonService.GetSeasons(),
                (s) => SeasonLocalCache.SetSeasonsCache(s)
            );
            Season = SeasonsModel.Seasons.First();
            seasonValue = Season.Year;

            var leagueId = Guid.Parse(Id);
            LeagueModel = await DataLoader.GetOrLoad(
                () => LeagueLocalCache.GetLeagueByIdCache(Id),
                () => LeagueService.GetLeague(leagueId),
                (l) => LeagueLocalCache.SetLeagueByIdCache(Id, l)
            );
            await CreateStatsLeadersByLeague(leagueId);
            PageLoad = true;

        }
        catch (Exception ex)
        {
            if (KeycloakTokenService.ShouldForceLogout())
            {
                _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/authRefresh.js");
                await _module.InvokeVoidAsync("logout");
            }
            ErrorState.Message = ex.Message;
            NavManager.NavigateTo("/error");
        }
    }

    private async Task CreateStatsLeadersByLeague(Guid leagueId)
    {
        StatsModel = await DataLoader.GetOrLoad(
            () => StatsLocalCache.GetLeagueFootballStatsBySeasonCache(leagueId.ToString(), Season.Id.ToString()),
            () => StatsService.GetLeagueFootballStatsBySeason(leagueId, Season.Id),
            (s) => StatsLocalCache.SetLeagueFootballStatsBySeasonCache(leagueId.ToString(), Season.Id.ToString(), s)
        );

        StatsModel = await StatsService.GetLeagueFootballStatsBySeason(leagueId, Season.Id);
        await BuildStatLeaders();
    }


    public async Task GetSeasonStatLeaders()
    {
        PageLoad = false;
        Season = SeasonsModel.Seasons.FirstOrDefault(s => s.Year == seasonValue);

        StatsModel = await DataLoader.GetOrLoad(
            () => StatsLocalCache.GetLeagueFootballStatsBySeasonCache(LeagueModel.League.Id.ToString(), Season.Id.ToString()),
            () => StatsService.GetLeagueFootballStatsBySeason(LeagueModel.League.Id, Season.Id),
            (s) => StatsLocalCache.SetLeagueFootballStatsBySeasonCache(LeagueModel.League.Id.ToString(), Season.Id.ToString(), s)
        );

        await BuildStatLeaders();
        PageLoad = true;
    }

    private async Task GetImageAsync(FootballStatLeaderModel stat)
        => stat.Image = await ImageService.GetPlayerImageAsync(LeagueModel.League, TeamModel.Team, PlayerModel.Player);

    private async Task BuildStatLeaders()
    {
        StatLeaders.Clear();

        foreach (var stat in StatsModel.FootballStats)
        {
            var leader = StatLeaders.FirstOrDefault(s => s.PlayerId == stat.PlayerId);
            if (leader is null)
            {
                PlayerModel = await DataLoader.GetOrLoad(
                    () => PlayerLocalCache.GetPlayerByIdCache(stat.PlayerId.ToString()),
                    () => PlayerService.GetPlayerById(stat.PlayerId),
                    (p) => PlayerLocalCache.SetPlayerByIdCache(p, stat.PlayerId.ToString())
                );

                TeamModel = await DataLoader.GetOrLoad(
                    () => TeamLocalCache.GetTeamByIdCache(stat.TeamId.ToString()),
                    () => TeamService.GetTeamById(stat.TeamId),
                    (t) => TeamLocalCache.SetTeamByIdCache(stat.TeamId.ToString(), t)
                );

                leader = CreateLeader(stat);
                await GetImageAsync(leader);
                StatLeaders.Add(leader);
            }
            else
                UpdateLeader(leader, stat);
        }
    }

    private FootballStatLeaderModel CreateLeader(FootballStatsModel stat)
    {
        var of = stat.OffensiveStats;
        var d = stat.DefensiveStats;
        var k = stat.KickingStats;

        var leader = new FootballStatLeaderModel
        {
            PlayerId = PlayerModel.Player.Id,
            PlayerName = $"{PlayerModel.Player.FirstName} {PlayerModel.Player.LastName}",
            Team = TeamModel.Team.TeamName,

            GamesPlayed = of.PassingAttempts > 0 || of.RushingAttempts > 0 || of.Targets > 0 || d.Tackles > 0 || k.ExtraPointsAttempted > 0 || k.FieldGoalsAttempted > 0 || k.Punts > 0 ? 1 : 0,

            PassingCompletions = of.PassingCompletions,
            PassingAttempts = of.PassingAttempts,
            PassingCompletionPercentage = SafePct(of.PassingCompletions, of.PassingAttempts),
            PassingYards = of.PassingYards,
            LongestPassingPlay = of.LongestPassingPlay,
            PassingYardsPerPlay = SafePerGame(of.PassingYards, of.PassingAttempts),
            PassingTouchdowns = of.PassingTouchdowns,
            PassingInterceptions = of.PassingInterceptions,
            Sacks = of.Sacks,

            RushingAttempts = of.RushingAttempts,
            RushingYards = of.RushingYards,
            RushingYardsAverage = SafePerGame(of.RushingYards, of.RushingAttempts),
            LongestRushingPlay = of.LongestRushingPlay,
            RushingTouchdowns = of.RushingTouchdowns,
            RushingFumbles = of.RushingFumbles,
            RushingFumblesLost = of.RushingFumblesLost,

            Receptions = of.Receptions,
            Targets = of.Targets,
            ReceivingYards = of.ReceivingYards,
            ReceivingYardsPerPlay = SafePerGame(of.ReceivingYards, of.Receptions),
            ReceivingTouchdowns = stat.OffensiveStats.ReceivingTouchdowns,
            ReceivingFumbles = stat.OffensiveStats.ReceivingFumbles,
            ReceivingFumblesLost = stat.OffensiveStats.ReceivingFumblesLost,
            YardsAfterCatch = stat.OffensiveStats.YardsAfterCatch,

            Tackles = d.Tackles,
            DefensiveSacks = d.Sacks,
            PassesDefended = d.PassesDefended,
            DefensiveInterceptions = d.DefensiveInterceptions,
            DefensiveInterceptionYards = d.DefensiveInterceptionYards,
            LongestDefensiveInterceptionPlay = d.LongestDefensiveInterceptionPlay,
            DefensiveTouchdowns = d.DefensiveTouchdowns,
            ForcedFumbles = d.ForcedFumbles,
            RecoveredFumbles = d.RecoveredFumbles,

            ExtraPointsMade = k.ExtraPointsMade,
            ExtraPointsAttempted = k.ExtraPointsAttempted,
            ExtraPointPercentage = SafePct(k.ExtraPointsMade, k.ExtraPointsAttempted),
            FieldGoalsMade = k.FieldGoalsMade,
            FieldGoalsAttempted = k.FieldGoalsAttempted,
            FieldGoalPercentage = SafePct(k.FieldGoalsMade, k.FieldGoalsAttempted),
            LongestKick = stat.KickingStats.LongestKick,
            Points = stat.KickingStats.Points,
            Punts = stat.KickingStats.Punts,
            PuntingYards = stat.KickingStats.PuntingYards,
            LongestPunt = stat.KickingStats.LongestPunt
        };

        ComputePerGame(leader);
        return leader;
    }

    private void UpdateLeader(FootballStatLeaderModel leader, FootballStatsModel stat)
    {
        var of = stat.OffensiveStats;
        var d = stat.DefensiveStats;
        var k = stat.KickingStats;

        leader.GamesPlayed = of.PassingAttempts > 0 || of.RushingAttempts > 0 || of.Targets > 0 || d.Tackles > 0 || k.ExtraPointsAttempted > 0 || k.FieldGoalsAttempted > 0 || k.Punts > 0 ? 1 : 0;

        leader.PassingCompletions += of.PassingCompletions;
        leader.PassingAttempts += of.PassingAttempts;
        leader.PassingCompletionPercentage = SafePct(leader.PassingCompletions, leader.PassingAttempts);
        leader.PassingYards += of.PassingYards;
        leader.LongestPassingPlay = of.LongestPassingPlay > leader.LongestPassingPlay ? of.LongestPassingPlay : leader.LongestPassingPlay;
        leader.PassingYardsPerPlay = SafePerGame(leader.PassingYards, leader.PassingAttempts);
        leader.PassingTouchdowns += stat.OffensiveStats.PassingTouchdowns;
        leader.PassingInterceptions += stat.OffensiveStats.PassingInterceptions;
        leader.Sacks += stat.OffensiveStats.Sacks;

        leader.RushingAttempts += stat.OffensiveStats.RushingAttempts;
        leader.RushingYards += stat.OffensiveStats.RushingYards;
        leader.RushingYardsAverage = SafePerGame(leader.RushingYards, leader.RushingAttempts);
        leader.LongestRushingPlay = of.LongestRushingPlay > leader.LongestRushingPlay ? of.LongestRushingPlay : leader.LongestRushingPlay;
        leader.RushingTouchdowns += stat.OffensiveStats.RushingTouchdowns;
        leader.RushingFumbles += stat.OffensiveStats.RushingFumbles;
        leader.RushingFumblesLost += stat.OffensiveStats.RushingFumblesLost;

        leader.Receptions += of.Receptions;
        leader.Targets += of.Targets;
        leader.ReceivingYards += of.ReceivingYards;
        leader.ReceivingYardsPerPlay = SafePerGame(leader.ReceivingYards, leader.Receptions);
        leader.ReceivingTouchdowns += of.ReceivingTouchdowns;
        leader.ReceivingFumbles += of.ReceivingFumbles;
        leader.ReceivingFumblesLost += of.ReceivingFumblesLost;

        leader.Tackles += d.Tackles;
        leader.DefensiveSacks += d.Sacks;
        leader.PassesDefended += d.PassesDefended;
        leader.DefensiveInterceptions += d.DefensiveInterceptions;
        leader.DefensiveInterceptionYards += d.DefensiveInterceptionYards;
        leader.LongestDefensiveInterceptionPlay += d.LongestDefensiveInterceptionPlay;
        leader.DefensiveTouchdowns += d.DefensiveTouchdowns;
        leader.ForcedFumbles += d.ForcedFumbles;
        leader.RecoveredFumbles += d.RecoveredFumbles;

        leader.ExtraPointsMade += k.ExtraPointsMade;
        leader.ExtraPointsAttempted += k.ExtraPointsAttempted;
        leader.ExtraPointPercentage = SafePct(leader.ExtraPointsMade, leader.ExtraPointsAttempted);
        leader.FieldGoalsMade += k.FieldGoalsMade;
        leader.FieldGoalsAttempted = k.FieldGoalsAttempted;
        leader.FieldGoalPercentage = SafePct(leader.FieldGoalsMade, leader.FieldGoalsAttempted);
        leader.LongestKick += k.LongestKick;
        leader.Points += k.Points;
        leader.Punts += k.Punts;
        leader.PuntingYards += k.PuntingYards;
        leader.LongestPunt += k.LongestPunt;

        ComputePerGame(leader);
    }

    private void ComputePerGame(FootballStatLeaderModel l)
    {
        l.PassingYardsPerGame = SafePerGame(l.PassingYards, l.GamesPlayed);
        l.RushingYardsPerGame = SafePerGame(l.RushingYards, l.GamesPlayed);
        l.ReceivingYardsPerGame = SafePerGame(l.ReceivingYards, l.GamesPlayed);

    }

    private decimal SafePct(int comp, int attempted) =>
        attempted == 0 ? 0 : (decimal)comp / attempted * 100;

    private decimal SafePerGame(int yards, int attempted) =>
        attempted == 0 ? 0 : (decimal)yards / attempted;
}

