@page "/leagues"
@using League.Builder.Web.Server.Services.Cache
@inject NavigationManager NavManager
@inject ErrorState ErrorState
@inject ILeagueService LeagueService
@inject IAWSService AWSService
@inject IHttpContextAccessor HttpContextAccessor
@inject ILeagueLocalCacheService LeagueLocalCache
@inject IJSRuntime JsRuntime
@inject KeycloakTokenService KeycloakTokenService
@inject AuthenticationStateProvider AuthenticationStateProvider

<AuthorizeView Roles="@Roles.ReadLeagues" Context="auth">
    <Authorized>
        <MudItem Style="padding-top: 50px;">
            <MudExpansionPanels>
                <MudExpansionPanel Class="border border-solid" style="border-color: #000000" Expanded="expandSearchPanel">
                    <TitleContent>
                        <MudText Typo="Typo.h5" Align="Align.Center" Style="font-weight:bold">League Search</MudText>
                    </TitleContent>
                    <ChildContent>
                        <MudItem>
                            <MudTabs Elevation="2" Centered="true" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6" Color="Color.Primary" Class="border border-solid" Style="border-color: #000000">
                                <MudTabPanel Text="Search All">
                                    <MudButton OnClick="@(() => ExecuteSearch(SearchAllInternal))" 
                                            Variant="Variant.Filled" 
                                            Color="Color.Primary" 
                                            Class="ml-auto" 
                                            FullWidth="true">
                                            Search All
                                    </MudButton>
                                </MudTabPanel>
                                <MudTabPanel Text="Sport">
                                    <MudStack Row="true">
                                        <MudItem xs="8">
                                            <MudSelect @bind-Value="sport" Label="Sport">
                                                @foreach (var sport in Constants.Sports())
                                                {
                                                    <MudSelectItem Value="@sport">@sport</MudSelectItem>
                                                }
                                            </MudSelect>
                                        </MudItem>
                                        <MudItem xs="4" Style="align-content: center">
                                            <MudButton Disabled="@(string.IsNullOrEmpty(sport))" 
                                                       OnClick="@(() => ExecuteSearch(SearchBySportInternal))" 
                                                       Variant="Variant.Filled" Color="Color.Primary" 
                                                       Class="ml-auto" 
                                                       Style="width: 200px;">
                                                       Search
                                            </MudButton>
                                        </MudItem>
                                    </MudStack>
                                </MudTabPanel>
                                <MudTabPanel Text="Name">
                                    <MudStack Row="true">
                                        <MudItem xs="9">
                                            <MudTextField @bind-Value="name" Placeholder="Name" />
                                        </MudItem>
                                        <MudItem xs="3">
                                            <MudButton Disabled="@(string.IsNullOrEmpty(name))"
                                                       OnClick="@(() => ExecuteSearch(SearchByNameInternal))" 
                                                       Variant="Variant.Filled" 
                                                       Color="Color.Primary" 
                                                       Class="ml-auto" 
                                                       Style="width: 200px;">
                                                       Search
                                            </MudButton>
                                        </MudItem>
                                    </MudStack>
                                </MudTabPanel>
                            </MudTabs>
                        </MudItem>
                    </ChildContent>
                </MudExpansionPanel>
            </MudExpansionPanels>
        </MudItem>
        @if (Model != null)
        {
            <MudItem Style="padding-top: 25px;">
                <MudExpansionPanels>
                    <MudExpansionPanel Expanded="true" Class="border border-solid" Style="border-color: #000000; padding-left: 25px; padding-right: 25px;">
                        <TitleContent>
                            <MudText Typo="Typo.h5" Align="Align.Center" Style="font-weight:bold">Results</MudText>
                        </TitleContent>
                        <ChildContent>
                            <AuthorizeView Roles="@Roles.CreateLeagues" Context="createAuth">
                                <Authorized>
                                    <MudItem>
                                        <MudTable Items="@Model" Hover="true" SortLabel="Sort By" Class="border border-solid" Style="border-color: #000000">
                                            <ToolBarContent>
                                                <MudStack Justify="Justify.FlexStart">
                                                    <MudButton Href="/createleague/" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" style="width: 200px;">Create</MudButton>
                                                </MudStack>
                                            </ToolBarContent>
                                            <HeaderContent>
                                                <MudTh Style="font-weight:bold" Class="mud-theme-primary"></MudTh>
                                                <MudTh Style="font-weight:bold" Class="mud-theme-primary"><MudTableSortLabel SortBy="new Func<LeagueModel, object>(x => x.Name)">Name</MudTableSortLabel></MudTh>
                                                <MudTh Style="font-weight:bold" Class="mud-theme-primary">Owner</MudTh>
                                                <MudTh Style="font-weight:bold" Class="mud-theme-primary">Sport</MudTh>
                                                <MudTh Style="font-weight:bold" Class="mud-theme-primary"></MudTh>
                                            </HeaderContent>
                                            <RowTemplate>
                                                <MudTd DataLabel="">
                                                    <LeagueAvatar Src="@context.Image" Size="Size.Small" />
                                                </MudTd>
                                                <MudTd DataLabel="League Name">
                                                    <MudTooltip Text="League Details" Color="Color.Secondary">
                                                        <MudLink Color="Color.Tertiary" Href="@($"/teamsbyleague/{context.Id}")">@context.Name</MudLink>
                                                    </MudTooltip>
                                                </MudTd>                                                
                                                <MudTd DataLabel="Owner">@String.Concat(context.OwnerFirstName, " ", context.OwnerLastName)</MudTd>
                                                <MudTd DataLabel="Description">@context.Sport</MudTd>
                                                <MudTd DataLabel="Links">
                                                    @if (CanReadGames)
                                                    {
                                                        <LeagueActionIcon Tooltip="Games"
                                                                          Icon="@Icons.Material.Filled.CalendarMonth"
                                                                          Href="@($"/leaguegames/{context.Id}")" />
                                                    }
                                                    @if (CanReadStandings)
                                                    {
                                                        <LeagueActionIcon Tooltip="Standings"
                                                                          Icon="@Icons.Material.Filled.BarChart"
                                                                          Href="@($"/leaguestandings/{context.Id}")" />
                                                    }
                                                    @if (CanReadStats)
                                                    {
                                                        @StatsIcon(context)
                                                    }
                                                    @if (CanReadLeagues)
                                                    {
                                                        <LeagueActionIcon Tooltip="League History"
                                                                          Icon="@Icons.Material.Filled.MenuBook"
                                                                          Href="@($"/leaguehistory/{context.Id}")" />
                                                    }
                                                    @if (CanUpdateLeagues)
                                                    {
                                                        <LeagueActionIcon Tooltip="Settings"
                                                                          Icon="@Icons.Material.Filled.Settings"
                                                                          Href="@($"/updateleaguesettings/{context.Id}")" />
                                                        <LeagueActionIcon Tooltip="Update"
                                                                          Icon="@Icons.Material.Filled.Update"
                                                                          Href="@($"/updateleague/{context.Id}")" />
                                                    }
                                                </MudTd>
                                            </RowTemplate>
                                            <PagerContent>
                                                <MudTablePager />
                                            </PagerContent>
                                        </MudTable>
                                    </MudItem>
                                </Authorized>
                                <NotAuthorized>
                                    <MudItem>
                                        <MudTable Items="@Model" Hover="true" SortLabel="Sort By" Class="border border-solid" Style="border-color: #000000">
                                            <HeaderContent>
                                                <MudTh Style="font-weight:bold" Class="mud-theme-primary"></MudTh>
                                                <MudTh Style="font-weight:bold" Class="mud-theme-primary"><MudTableSortLabel SortBy="new Func<LeagueModel, object>(x => x.Name)">Name</MudTableSortLabel></MudTh>
                                                <MudTh Style="font-weight:bold" Class="mud-theme-primary">Description</MudTh>
                                                <MudTh Style="font-weight:bold" Class="mud-theme-primary"></MudTh>
                                            </HeaderContent>
                                            <RowTemplate>
                                                <MudTd DataLabel="">
                                                    <LeagueAvatar Src="@context.Image" Size="Size.Small" />
                                                </MudTd>
                                                <MudTd DataLabel="League Name">
                                                    <MudTooltip Text="League Details" Color="Color.Secondary">
                                                        <MudLink Color="Color.Tertiary" Href="@($"/teamsbyleague/{context.Id}")">@context.Name</MudLink>
                                                    </MudTooltip>
                                                </MudTd>
                                                <MudTd DataLabel="Description">@context.Description</MudTd>
                                                <MudTd DataLabel="Links">
                                                    <MudTooltip Text="Email" Color="Color.Secondary">
                                                        <MudIconButton Icon="@Icons.Material.Filled.Email" Color="Color.Tertiary" Edge="Edge.Start" />
                                                    </MudTooltip>
                                                    @if (CanReadGames)
                                                    {
                                                        <LeagueActionIcon Tooltip="Games"
                                                                          Icon="@Icons.Material.Filled.CalendarMonth"
                                                                          Href="@($"/leaguegames/{context.Id}")" />
                                                    }
                                                    @if (CanReadStandings)
                                                    {
                                                        <LeagueActionIcon Tooltip="Standings"
                                                                          Icon="@Icons.Material.Filled.BarChart"
                                                                          Href="@($"/leaguestandings/{context.Id}")" />
                                                    }
                                                    @if (CanReadStats)
                                                    {
                                                        @StatsIcon(context)
                                                    }
                                                    @if (CanReadLeagues)
                                                    {
                                                        <LeagueActionIcon Tooltip="League History"
                                                                          Icon="@Icons.Material.Filled.MenuBook"
                                                                          Href="@($"/leaguehistory/{context.Id}")" />
                                                    }
                                                    @if(CanUpdateLeagues)
                                                    {
                                                        <LeagueActionIcon Tooltip="Settings"
                                                                          Icon="@Icons.Material.Filled.Settings"
                                                                          Href="@($"/updateleaguesettings/{context.Id}")" />
                                                        <LeagueActionIcon Tooltip="Update"
                                                                          Icon="@Icons.Material.Filled.Update"
                                                                          Href="@($"/updateleague/{context.Id}")" />
                                                    }
                                                </MudTd>
                                            </RowTemplate>
                                            <PagerContent>
                                                <MudTablePager />
                                            </PagerContent>
                                        </MudTable>
                                    </MudItem>
                                </NotAuthorized>
                            </AuthorizeView>
                        </ChildContent>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            </MudItem>
        }
        @if (isSearchLoading)
        {
            <Loading />
        }
    </Authorized>
    <NotAuthorized>
        <NoAccess />
    </NotAuthorized>
</AuthorizeView>

@code {
    private string sport = string.Empty;
    private string name = string.Empty;
    private string lastNameSearched = string.Empty;
    private GetLeaguesResponse LeaguesResponse { get; set; }
    private GetLeaguesBySportResponse LeaguesBySportResponse { get; set; }
    private GetLeaguesByNameResponse LeaguesByNameResponse { get; set; }
    private bool expandSearchPanel = true;
    private bool isSearchLoading = false;
    private List<LeagueModel> Model { get; set; }
    private IJSObjectReference? _module;
    private bool CanReadGames;
    private bool CanReadStandings;
    private bool CanReadStats;
    private bool CanReadLeagues;
    private bool CanUpdateLeagues;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        CanReadGames = user.IsInRole(Roles.ReadGames);
        CanReadStandings = user.IsInRole(Roles.ReadStandings);
        CanReadStats = user.IsInRole(Roles.ReadStats);
        CanReadLeagues = user.IsInRole(Roles.ReadLeagues);
        CanUpdateLeagues = user.IsInRole(Roles.UpdateLeagues);
    }

    private async Task ExecuteSearch(Func<Task> searchFunc)
    {
        try
        {
            isSearchLoading = true;
            await searchFunc();
            expandSearchPanel = false;
        }
        catch (Exception ex)
        {
            if (KeycloakTokenService.ShouldForceLogout())
            {
                await TriggerLogout();
                return;
            }
            ErrorState.Message = ex.Message;
            NavManager.NavigateTo("/error");
        }
        finally
        {
            isSearchLoading = false;
        }
    }

    private async Task SearchAllInternal()
    {
        var response = await LeagueLocalCache.GetLeaguesCache()
                        ?? await LeagueService.GetLeagues(1, 10000);

        if(response is not null)
            await LeagueLocalCache.SetLeaguesCache(response);

        Model = response.Leagues.ToList();
        await LoadImages();
    }

    private async Task SearchBySportInternal()
    {
        var response = await LeagueLocalCache.GetLeaguesBySportCache(sport)
                        ?? await LeagueService.GetLeaguesBySport(sport);
        if(response is not null)
            await LeagueLocalCache.SetLeaguesBySportCache(sport, response);
        Model = response.Leagues.ToList();
        await LoadImages();
    }

    private async Task SearchByNameInternal()
    {
        GetLeaguesByNameResponse response;
        if(lastNameSearched == name)
        {
            response = await LeagueLocalCache.GetLeaguesByNameCache();
            if(response is null)
            {
                response = await LeagueService.GetLeaguesByName(name);
                await LeagueLocalCache.SetLeaguesByNameCache(response);
            }
        }
        else
        {
            response = await LeagueService.GetLeaguesByName(name);
            await LeagueLocalCache.SetLeaguesByNameCache(response);
            lastNameSearched = name;
        }

        Model = response.Leagues.OrderBy(x => x.Name).ToList();
        await LoadImages();
    }

    private async Task LoadImages()
    {
        if(Model is null)
            return;

        foreach (var league in Model)
        {
            string keyPath = $"/{league.Sport}/{league.Name}/{league.ImageFile}";
            league.Image = await AWSService.GetImage(keyPath);
        }
    }

    private async Task TriggerLogout()
    {
        _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/authRefresh.js");
        await _module.InvokeVoidAsync("logout");
    }
}

@functions{
    private RenderFragment StatsIcon(LeagueModel league) => __builder =>
    {
        if(!CanReadStats) return;

        var url = league.Sport switch
        {
            SportName.BASEBALL => $"/baseballleaguestatsleaders/{league.Id}",
            SportName.BASKETBALL => $"/basketballleaguestatsleaders/{league.Id}",
            SportName.FOOTBALL => $"/footballleaguestatsleaders/{league.Id}",
            _ => null
        };

        if(url is not null)
        {
            <MudTooltip Text="Stats" Color="Color.Secondary">
                <MudIconButton Icon="@Icons.Material.Filled.QueryStats" Color="Color.Tertiary" Edge="Edge.Start" Href="@url" />
            </MudTooltip>            
            ;
        }
    };
}
